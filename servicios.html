<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Servicios Rai Trai</title>
  <!-- Tu hoja de estilos general -->
  <link rel="stylesheet" href="estilos.css">
  <style>
    /* ‚Äî‚Äî‚Äî Layout del header con bot√≥n de Proveedores ‚Äî‚Äî‚Äî */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    header h2 { margin: 0; }
    header button {
      background: #0055A4;
      color: #fff;
      border: none;
      padding: .5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    /* ‚Äî‚Äî‚Äî Secciones y tabla en grid para anchos proporcionales ‚Äî‚Äî‚Äî */
    .section { margin-bottom: 3rem; }
    .section h3 { margin: .5rem 0; }
    .section table {
      display: grid;
      grid-template-columns:
        1fr   /* # */
        4fr   /* Servicio */
        3fr   /* Tipo Servicio */
        3fr   /* Categor√≠a */
        2fr   /* Ciudad */
        5fr   /* Restricciones */
        3fr   /* Proveedor */
        2fr   /* Tipo Cobro */
        1fr   /* Moneda */
        2fr   /* Valor Servicio */
        2fr   /* Forma de Pago */
        auto auto; /* Guardar / Eliminar */
      width: 100%;
      border-collapse: collapse;
    }
    .section thead,
    .section tbody { display: contents; }
    .section th,
    .section td {
      border: 1px solid #ccc;
      padding: 4px;
      box-sizing: border-box;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      min-width: 0;      /* Evita overflow en grid */
    }

    /* ‚Äî‚Äî‚Äî Inputs y selects ‚Äî‚Äî‚Äî */
    input, select {
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Tooltip para inputs de texto */
    .section td input:hover {
      overflow: visible;
      white-space: normal;
    }

    /* ‚Äî‚Äî‚Äî Botones internos ‚Äî‚Äî‚Äî */
    .controls { margin: .5rem 0; }
    .controls button { margin-right: .5rem; }

    /* ‚Äî‚Äî‚Äî Modal Proveedores ‚Äî‚Äî‚Äî */
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    #modal .content {
      background: #fff;
      padding: 1rem;
      border-radius: 4px;
      width: 90%; max-width: 800px;
      position: relative;
    }
    #modal .close {
      position: absolute; top: 8px; right: 8px;
      cursor: pointer;
    }

    /* ‚Äî‚Äî‚Äî Editor flotante ‚Äî‚Äî‚Äî */
    .floating-editor {
      position: absolute;
      z-index: 1000;
      box-sizing: border-box;
      width: 300px;
      height: 80px;
      resize: both;
    }
  </style>
</head>
<body>

  <!-- Header externo -->
  <div id="encabezado"></div>

  <!-- T√≠tulo y bot√≥n Proveedores -->
  <header>
    <h2>üìã Lista de Servicios</h2>
    <button onclick="openModal()">üõ†Ô∏è Administrar Proveedores</button>
  </header>

  <!-- Modal embebido -->
  <div id="modal">
    <div class="content">
      <span class="close" onclick="closeModal()">‚úñÔ∏è</span>
      <iframe src="proveedores.html" style="width:100%; height:80vh; border:none;"></iframe>
    </div>
  </div>

  <!-- Contenedor de secciones -->
  <div id="secciones"></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    // ‚Äî Sesi√≥n ‚Äî
    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'login.html';
    });

    // ‚Äî Datos est√°ticos ‚Äî
    const opciones = {
      tipoServicio: ['DIARIO','GENERAL','OTRO'],
      categoria:    ['NAVEGACI√ìN','ALIMENTACI√ìN','ATRACCI√ìN TUR√çSTICA','ENTRETENIMIENTO','TOUR','PARQUE ACU√ÅTICO','DISCO','OTRA'],
      formaPago:    ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro:    ['POR PERSONA','POR GRUPO','OTRO'],
      moneda:       ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };
    const campos = [
      'servicio','tipoServicio','categoria',
      'ciudad','restricciones','proveedor','tipoCobro',
      'moneda','valorServicio','formaPago'
    ];
    const destinos = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE', null];

    // Referencias DOM
    const container = document.getElementById('secciones');
    const modal     = document.getElementById('modal');

    // ‚Äî Funciones modal ‚Äî
    function openModal()  { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; }

    // ‚Äî Editor flotante ‚Äî
    let floating = null;
    function showFloatingEditor(input) {
      if (floating) floating.remove();
      floating = document.createElement('textarea');
      floating.className = 'floating-editor';
      floating.value = input.value;
      document.body.appendChild(floating);
      const r = input.getBoundingClientRect();
      floating.style.top  = (r.bottom + scrollY + 4) + 'px';
      floating.style.left = (r.left   + scrollX) + 'px';
      floating.addEventListener('input', () => {
        input.value = floating.value;
        input.title = floating.value;
      });
      floating.addEventListener('blur', () => {
        floating.remove();
        floating = null;
      });
      floating.focus();
    }

    // ‚Äî Crea secci√≥n por destino ‚Äî
    function crearSeccion(destFijo) {
      const isOtro = destFijo === null;
      let destActivo = destFijo;
      const sec = document.createElement('div');
      sec.className = 'section';
      sec.innerHTML = `<h3>${ isOtro ? 'OTRO' : destFijo }</h3>`;

      // Tabla y cabecera
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      hr.appendChild(Object.assign(document.createElement('th'),{ textContent: '#' }));
      if (isOtro) {
        hr.appendChild(Object.assign(document.createElement('th'),{ textContent: 'Destino' }));
      }
      [
        'Servicio','Tipo Servicio','Categor√≠a','Ciudad',
        'Restricciones','Proveedor','Tipo Cobro','Moneda',
        'Valor Servicio','Forma de Pago','Guardar','Eliminar'
      ].forEach(txt => {
        const th = document.createElement('th');
        th.textContent = txt;
        hr.appendChild(th);
      });
      thead.appendChild(hr);
      tbl.appendChild(thead);

      // Cuerpo
      const tbody = document.createElement('tbody');
      tbl.appendChild(tbody);
      sec.appendChild(tbl);

      // Controles
      const ctrl = document.createElement('div');
      ctrl.className = 'controls';
      ['‚ûï Nueva fila','‚ûï‚ûï Agregar 10 filas','üíæ Guardar todo']
        .forEach((lbl,i) => {
          const btn = document.createElement('button');
          btn.textContent = lbl;
          btn.onclick = () => {
            if (i === 0) add();
            if (i === 1) [...Array(10)].forEach(() => add());
            if (i === 2) saveAll();
          };
          ctrl.appendChild(btn);
        });
      sec.appendChild(ctrl);

      const filasArr = [];

      // Actualiza numeraci√≥n
      function updateNums() {
        tbody.querySelectorAll('tr').forEach((tr,i) => {
          let td = tr.querySelector('td.rownum');
          if (!td) {
            td = document.createElement('td');
            td.className = 'rownum';
            tr.insertBefore(td, tr.firstChild);
          }
          td.textContent = i + 1;
        });
      }

      // Carga select de proveedores
      async function loadProv(tr) {
        const sel = tr.querySelector('[data-campo=proveedor]');
        sel.innerHTML = '<option value="">‚Äî</option>';
        if (!destActivo) return;
        const col = collection(db,'Proveedores',destActivo,'Listado');
        const snap = await getDocs(query(col, orderBy('proveedor','asc')));
        snap.forEach(d => sel.appendChild(new Option(d.id, d.id)));
      }

      // A√±ade fila
      function add(prefill = {}, ref = null) {
        const tr = document.createElement('tr');
        const inputs = [];

        // Columna n√∫mero
        tr.appendChild(Object.assign(document.createElement('td'),{ className: 'rownum' }));

        // Si es OTRO, input destino editable
        if (isOtro) {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.placeholder = 'Destino';
          inp.value = prefill.destino || '';
          inp.dataset.campo = 'destino';
          inp.addEventListener('input', () => destActivo = inp.value.toUpperCase());
          td.appendChild(inp);
          tr.appendChild(td);
          inputs.push(inp);
        }

        // Campos din√°micos
        campos.forEach(c => {
          const td = document.createElement('td');
          let inp;

          if (c === 'proveedor') {
            inp = document.createElement('select');
            inp.dataset.campo = c;
            inp.innerHTML = '<option value="">‚Äî</option>';
          }
          else if (opciones[c]) {
            inp = document.createElement('select');
            inp.dataset.campo = c;
            if (c === 'categoria' || c === 'formaPago') inp.multiple = true;
            opciones[c].forEach(o => inp.appendChild(new Option(o, o)));
            if (prefill[c]) {
              const arr = Array.isArray(prefill[c]) ? prefill[c] : [prefill[c]];
              arr.forEach(v => {
                const opt = Array.from(inp.options).find(o => o.value === v);
                if (opt) opt.selected = true;
              });
            }
          }
          else {
            inp = document.createElement('input');
            inp.value = prefill[c] || '';
            if (c !== 'valorServicio') {
              inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
            }
            inp.dataset.campo = c;
            inp.addEventListener('focus', () => showFloatingEditor(inp));
            inp.title = inp.value;
          }

          td.appendChild(inp);
          tr.appendChild(td);
          inputs.push(inp);
        });

        // Si no es OTRO, carga proveedores
        if (!isOtro) {
          destActivo = destFijo;
          setTimeout(() => loadProv(tr), 0);
        }

        // Bot√≥n Guardar fila
        const tdG = document.createElement('td');
        const btnG = document.createElement('button');
        btnG.textContent = 'üíæ';
        btnG.addEventListener('click', async () => {
          try { await save(inputs); alert('‚úÖ'); }
          catch (e) { alert('‚ö†Ô∏è ' + e.message); }
        });
        tdG.appendChild(btnG);
        tr.appendChild(tdG);

        // Bot√≥n Eliminar fila
        const tdD = document.createElement('td');
        const btnD = document.createElement('button');
        btnD.textContent = 'üóëÔ∏è';
        btnD.addEventListener('click', async () => {
          if (ref) {
            await deleteDoc(ref);
            alert('‚úÖ');
          }
          tr.remove();
          updateNums();
        });
        tdD.appendChild(btnD);
        tr.appendChild(tdD);

        // Pegado tab-a-tab
        tr.addEventListener('paste', e => {
          e.preventDefault();
          const vs = e.clipboardData.getData('text/plain').split('\t');
          inputs.forEach((inp,i) => {
            if (vs[i] != null) inp.value = vs[i].trim().toUpperCase();
          });
        });

        tbody.appendChild(tr);
        filasArr.push({ inputs, ref });
        updateNums();
      }

      // Guarda una fila
      async function save(inputs) {
        const data = {};
        inputs.forEach(i => {
          data[i.dataset.campo] = i.multiple
            ? [...i.selectedOptions].map(o => o.value)
            : i.value.trim().toUpperCase();
        });
        const destino = isOtro ? data.destino : destActivo;
        if (!destino)      throw new Error('Falta Destino');
        if (!data.servicio) throw new Error('Falta Servicio');
        if (!data.proveedor)throw new Error('Falta Proveedor');

        // Aseguro doc padre
        await setDoc(doc(db,'Servicios',destino), { _created: true }, { merge: true });
        // Subcolecci√≥n Listado
        const col = collection(db,'Servicios',destino,'Listado');
        const dr  = doc(col, data.servicio);
        await setDoc(dr, data);
      }

      // Guarda todas las filas
      async function saveAll() {
        for (const f of filasArr) {
          await save(f.inputs);
        }
        alert('‚úÖ Todos guardados');
      }

      // Carga inicial (ordenada ascendente por ID de servicio)
      if (!isOtro) {
        (async () => {
          const col  = collection(db,'Servicios',destFijo,'Listado');
          const snap = await getDocs(query(col, orderBy('servicio','asc')));
          snap.forEach(d => {
            const obj = d.data();
            obj.servicio = d.id;
            add(obj, doc(db,'Servicios',destFijo,'Listado',d.id));
          });
        })();
      }

      return sec;
    }

    // Montar secciones
    destinos.forEach(d => container.appendChild(crearSeccion(d)));

    // Cargar encabezado externo
    fetch('encabezado.html')
      .then(r => r.text())
      .then(html => document.getElementById('encabezado').innerHTML = html);

  </script>
</body>
</html>
