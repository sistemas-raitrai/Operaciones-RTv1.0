<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Servicios Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    .section { margin-bottom: 3rem; }
    .section h3 { margin-top: 1rem; }
    .section table { width: 100%; border-collapse: collapse; }
    .section th, .section td { border: 1px solid #ccc; padding: 4px; }
    .controls { margin: .5rem 0; }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <h2>üìã Listado de Servicios</h2>

  <div id="secciones"></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    onAuthStateChanged(auth, u => { if (!u) window.location.href = 'login.html'; });

    const opciones = {
      tipoServicio: ['DIARIO','GENERAL','OTRO'],
      categoria:    ['NAVEGACI√ìN','ALIMENTACI√ìN','ATRACCI√ìN TUR√çSTICA','ENTRETENCI√ìN','TOUR','PARQUE ACU√ÅTICO','DISCO','OTRA'],
      formaPago:    ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro:    ['POR PERSONA','POR GRUPO','OTRO'],
      moneda:       ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };
    const campos = ['destino','numero','servicio','tipoServicio','categoria','ciudad','restricciones','proveedor','contacto','correo','tipoCobro','moneda','valorServicio','formaPago'];

    function crearSeccion(destinoFijo) {
      const isOtro = destinoFijo === null;
      let destinoActivo = destinoFijo;
      const section = document.createElement('div');
      section.className = 'section';
      section.innerHTML = `<h3>${ isOtro ? 'OTRO' : destinoFijo }</h3>`;

      // tabla y encabezado
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      if (isOtro) {
        const th0 = document.createElement('th');
        th0.textContent = 'Destino';
        headRow.appendChild(th0);
      }
      ['N¬∞','Servicio','Tipo Servicio','Categor√≠a','Ciudad','Restricciones','Proveedor','Contacto','Correo','Tipo Cobro','Moneda','Valor Servicio','Forma de Pago','Guardar','Eliminar']
        .forEach(txt => {
          const th = document.createElement('th');
          th.textContent = txt;
          headRow.appendChild(th);
        });
      thead.appendChild(headRow);
      table.appendChild(thead);

      // cuerpo
      const tbody = document.createElement('tbody');
      table.appendChild(tbody);
      section.appendChild(table);

      // controles
      const ctrl = document.createElement('div');
      ctrl.className = 'controls';
      ['‚ûï Nueva fila','‚ûï‚ûï Agregar 10 filas','üíæ Guardar todo'].forEach((lbl,i)=>{
        const btn = document.createElement('button');
        btn.textContent = lbl;
        btn.onclick = ()=>{
          if (i===0) renderFila();
          if (i===1) Array.from({length:10}).forEach(()=>renderFila());
          if (i===2) guardarTodo();
        };
        ctrl.appendChild(btn);
      });
      section.appendChild(ctrl);

      const filas = [];

      function renderFila(prefill={}, ref=null) {
        const tr = document.createElement('tr');
        const inputs = [];
        campos.forEach(c=>{
          if (c==='destino' && isOtro) {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.placeholder = 'Destino';
            inp.value = prefill.destino||'';
            inp.addEventListener('change', ()=> destinoActivo = inp.value.trim().toUpperCase());
            td.appendChild(inp);
            tr.appendChild(td);
            inputs.push(inp);
            return;
          }
          if (c==='destino' && !isOtro) return;
          const td = document.createElement('td');
          let inp;
          if (opciones[c]) {
            inp = document.createElement('select');
            if (c==='categoria' || c==='formaPago') inp.multiple = true;
            opciones[c].forEach(opt=>{
              const o = new Option(opt,opt);
              if (prefill[c]) {
                const arr = Array.isArray(prefill[c])?prefill[c]:[prefill[c]];
                if (arr.includes(opt)) o.selected = true;
              }
              inp.appendChild(o);
            });
          } else {
            inp = document.createElement('input');
            inp.value = prefill[c]||'';
            if (c!=='valorServicio') inp.addEventListener('input', ()=> inp.value = inp.value.toUpperCase());
          }
          inp.dataset.campo = c;
          inputs.push(inp);
          td.appendChild(inp);
          tr.appendChild(td);
        });

        // guardar bot√≥n
        const tdG = document.createElement('td');
        const btnG = document.createElement('button');
        btnG.textContent = 'üíæ';
        btnG.onclick = async ()=>{
          try { await guardarFila(inputs); alert('Guardado ‚úÖ'); }
          catch(e){ alert('Error: '+e.message); }
        };
        tdG.appendChild(btnG); tr.appendChild(tdG);

        // eliminar bot√≥n
        const tdD = document.createElement('td');
        const btnD = document.createElement('button');
        btnD.textContent = 'üóëÔ∏è';
        btnD.onclick = async ()=>{
          if (ref) { await deleteDoc(ref); alert('Eliminado ‚úÖ'); }
          tr.remove();
        };
        tdD.appendChild(btnD); tr.appendChild(tdD);

        tbody.appendChild(tr);
        filas.push({inputs,ref});
      }

      async function guardarFila(inputs) {
        const data = { destino: destinoActivo };
        inputs.forEach(i=>{
          const k = i.dataset.campo;
          if (i.multiple) data[k] = Array.from(i.selectedOptions).map(o=>o.value);
          else if (k==='destino') data.destino = i.value.trim().toUpperCase();
          else data[k] = k==='valorServicio' ? Number(i.value)||0 : i.value.trim().toUpperCase();
        });
        if (!data.destino || !data.servicio) throw Error('Completa destino y servicio');
        const refDoc = doc(collection(db,'Servicios',data.destino), data.servicio);
        await setDoc(refDoc, data);
      }

      async function guardarTodo() {
        for (const f of filas) await guardarFila(f.inputs);
        alert('Todos guardados ‚úÖ');
      }

      // pegado masivo por secci√≥n
      tbody.addEventListener('paste', e=>{
        e.preventDefault();
        const lines = e.clipboardData.getData('text/plain')
          .trim().split(/\r?\n/);
        lines.forEach(line=>{
          const vals = line.split('\t');
          const obj = {};
          campos.forEach((c,i)=> obj[c] = vals[i]||'');
          renderFila(obj);
        });
      });

      // carga inicial con IIFE async
      if (!isOtro) {
        (async()=>{
          destinoActivo = destinoFijo;
          const snap = await getDocs(collection(db,'Servicios', destinoActivo));
          snap.forEach(docSnap=>{
            const d = docSnap.data();
            d.servicio = docSnap.id;
            renderFila(d, doc(db,'Servicios', destinoActivo, docSnap.id));
          });
        })();
      }

      return section;
    }

    // Generar 5 secciones
    const destinos = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE', null];
    const cont = document.getElementById('secciones');
    destinos.forEach(d=> cont.appendChild(crearSeccion(d)));

    fetch('encabezado.html')
      .then(r=>r.text())
      .then(html=>document.getElementById('encabezado').innerHTML = html);
  </script>
</body>
</html>
