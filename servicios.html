<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Servicios Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    /* Anchos predefinidos para columnas */
    .w-xs { width: 5%; }
    .w-sm { width: 10%; }
    .w-md { width: 20%; }
    .w-lg { width: 30%; }

    .section { margin-bottom: 3rem; }
    .section h3 { margin-top: 1rem; }
    .section table { width: 100%; border-collapse: collapse; }
    .section th, .section td { border: 1px solid #ccc; padding: 4px; box-sizing: border-box; }
    select, input { width:100%; box-sizing:border-box; }
    .controls { margin: .5rem 0; }
    .controls button { margin-right: .5rem; }

    /* Modal proveedores */
    #modal { display:none; position:fixed; top:0;left:0; width:100%;height:100%;
             background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
    #modal .modal-content { background:#fff; padding:1rem; border-radius:4px;
                             width:90%; max-width:800px; position:relative; }
    #modal .close-btn { position:absolute; top:8px; right:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <h2>üìã Listado de Servicios</h2>

  <!-- Bot√≥n modal proveedores -->
  <button style="position:absolute; top:1rem; right:1rem;" onclick="openModal()">
    üõ†Ô∏è Administrar Proveedores
  </button>
  <div id="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">‚úñÔ∏è</span>
      <iframe src="proveedores.html" style="width:100%; height:80vh; border:none;"></iframe>
    </div>
  </div>

  <div id="secciones"></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    onAuthStateChanged(auth, u => { if (!u) window.location.href='login.html'; });

    const opciones = {
      tipoServicio: ['DIARIO','GENERAL','OTRO'],
      categoria:    ['NAVEGACI√ìN','ALIMENTACI√ìN','ATRACCI√ìN TUR√çSTICA','ENTRETENCI√ìN','TOUR','PARQUE ACU√ÅTICO','DISCO','OTRA'],
      formaPago:    ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro:    ['POR PERSONA','POR GRUPO','OTRO'],
      moneda:       ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };
    const campos = [
      'destino','numero','servicio','tipoServicio','categoria',
      'ciudad','restricciones','proveedor','tipoCobro',
      'moneda','valorServicio','formaPago'
    ];
    const destinos = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE', null];
    const container = document.getElementById('secciones');

    // ===================================================
    // Funciones modal
    function openModal(){ document.getElementById('modal').style.display='flex'; }
    function closeModal(){ document.getElementById('modal').style.display='none'; }

    // ===================================================
    // Crea secci√≥n para un destino (o "OTRO")
    function crearSeccion(destinoFijo) {
      const isOtro = destinoFijo===null;
      let destinoActivo = destinoFijo;
      const section = document.createElement('div');
      section.className = 'section';
      section.innerHTML = `<h3>${isOtro?'OTRO':destinoFijo}</h3>`;

      // Tabla y cabecera
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      if (isOtro) {
        const th = document.createElement('th');
        th.textContent='Destino';
        th.className='w-sm';
        headRow.appendChild(th);
      }
      // Define anchos: ajusta clases seg√∫n tu preferencia
      const definiciones = [
        'w-xs','w-sm','w-md','w-sm','w-sm','w-sm','w-sm','w-lg','w-sm','w-sm','w-sm','w-sm','w-sm','w-xs','w-xs'
      ];
      ['N¬∞','Servicio','Tipo Servicio','Categor√≠a','Ciudad','Restricciones','Proveedor','Tipo Cobro','Moneda','Valor Servicio','Forma de Pago','Guardar','Eliminar']
        .forEach((txt,i) => {
          const th = document.createElement('th');
          th.textContent=txt;
          th.className=definiciones[isOtro? i : i+1]||'';
          headRow.appendChild(th);
        });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      table.appendChild(tbody);
      section.appendChild(table);

      // Controles
      const ctrl = document.createElement('div');
      ctrl.className='controls';
      ['‚ûï Nueva fila','‚ûï‚ûï Agregar 10 filas','üíæ Guardar todo'].forEach((lab,idx)=>{
        const btn=document.createElement('button');
        btn.textContent=lab;
        btn.onclick=()=>{
          if(idx===0) renderFila();
          if(idx===1) Array.from({length:10}).forEach(renderFila);
          if(idx===2) guardarTodo();
        };
        ctrl.appendChild(btn);
      });
      section.appendChild(ctrl);

      const filasArr=[];

      // Numeraci√≥n
      function actualizarNumeros(){
        tbody.querySelectorAll('tr').forEach((tr,i)=>{
          let td=tr.querySelector('td.rownum');
          if(!td){
            td=document.createElement('td');
            td.className='rownum w-xs';
            tr.insertBefore(td,tr.firstChild);
          }
          td.textContent=i+1;
        });
      }

      // Crea select Destino
      function crearSelectDestino(val=''){
        const sel=document.createElement('select');
        sel.dataset.campo='destino';
        sel.appendChild(new Option('‚Äî',''));
        destinos.filter(d=>d).forEach(d=>{
          const o=new Option(d,d);
          if(d===val) o.selected=true;
          sel.appendChild(o);
        });
        sel.onchange=()=>{ destinoActivo=sel.value; cargarProveedoresFila(tr); };
        return sel;
      }

      // Pobla proveedores
      async function cargarProveedoresFila(tr){
        const dest=destinoActivo;
        const sel=tr.querySelector('[data-campo=proveedor]');
        sel.innerHTML='<option value="">‚Äî</option>';
        if(!dest) return;
        const col=collection(db,'Proveedores',dest,'Listado');
        const q=query(col,orderBy('proveedor','asc'));
        const snap=await getDocs(q);
        snap.forEach(s=>sel.appendChild(new Option(s.id,s.id)));
      }

      // Render fila
      function renderFila(prefill={}, ref=null){
        const tr=document.createElement('tr');
        const inputs=[];

        // columna destino o n√∫mero
        if(isOtro){
          const td=document.createElement('td');
          const inp=document.createElement('input');
          inp.placeholder='Destino';
          inp.value=prefill.destino||'';
          inp.dataset.campo='destino';
          inp.addEventListener('input',()=>destinoActivo=inp.value.toUpperCase());
          td.appendChild(inp); tr.appendChild(td); inputs.push(inp);
        }

        // resto campos
        campos.forEach(c=>{
          if(c==='destino' && !isOtro) return;
          const td=document.createElement('td');
          let inp;
          if(c==='destino'){
            inp=crearSelectDestino(prefill.destino||destinoActivo);
          }
          else if(opciones[c]){
            inp=document.createElement('select');
            inp.dataset.campo=c;
            if(c==='categoria'||c==='formaPago') inp.multiple=true;
            opciones[c].forEach(o=>inp.appendChild(new Option(o,o)));
            // prefill
            if(prefill[c]){
              const arr=Array.isArray(prefill[c])?prefill[c]:[prefill[c]];
              arr.forEach(v=>{
                const opt=Array.from(inp.options).find(o=>o.value===v);
                if(opt) opt.selected=true;
              });
            }
          }
          else{
            inp=document.createElement('input');
            inp.value=prefill[c]||'';
            if(c!=='valorServicio')
              inp.addEventListener('input',()=>inp.value=inp.value.toUpperCase());
            inp.dataset.campo=c;
          }
          td.appendChild(inp);
          tr.appendChild(td);
          inputs.push(inp);
        });

        // botones
        const tdG=document.createElement('td');
        const btnG=document.createElement('button'); btnG.textContent='üíæ';
        btnG.onclick=async()=>{
          try{ await guardarFila(inputs); alert('‚úÖ'); }
          catch(e){ alert('‚ö†Ô∏è '+e.message); }
        };
        tdG.appendChild(btnG); tr.appendChild(tdG);

        const tdD=document.createElement('td');
        const btnD=document.createElement('button'); btnD.textContent='üóëÔ∏è';
        btnD.onclick=async()=>{
          if(ref){ await deleteDoc(ref); alert('‚úÖ'); }
          tr.remove(); actualizarNumeros();
        };
        tdD.appendChild(btnD); tr.appendChild(tdD);

        // pegado individual
        tr.addEventListener('paste',e=>{
          e.preventDefault();
          const vals=e.clipboardData.getData('text/plain').split('\t');
          inputs.forEach((inp,i)=>{ if(vals[i]!=null) inp.value=vals[i].trim().toUpperCase(); });
        });

        tbody.appendChild(tr);
        filasArr.push({inputs:inputs,ref});
        actualizarNumeros();
        // carga proveedores
        if(!isOtro) cargarProveedoresFila(tr);
      }

      // guardar fila
      async function guardarFila(inputs){
        const data={destino:destinoActivo};
        inputs.forEach(i=>{
          const k=i.dataset.campo;
          if(i.multiple)
            data[k]=[...i.selectedOptions].map(o=>o.value);
          else
            data[k]=i.value.trim().toUpperCase();
        });
        if(!data.destino||!data.servicio) throw new Error('Falta destino/servicio');
        // padre
        const padre=doc(db,'Servicios',data.destino);
        await setDoc(padre,{_created:true},{merge:true});
        // listado
        const col=collection(db,'Servicios',data.destino,'Listado');
        const sdoc=doc(col,data.servicio);
        await setDoc(sdoc,data);
      }

      // guardar todo
      async function guardarTodo(){
        for(const f of filasArr)
          await guardarFila(f.inputs);
        alert('Todos guardados ‚úÖ');
      }

      // masivo
      tbody.addEventListener('paste',e=>{
        e.preventDefault();
        const lines=e.clipboardData.getData('text/plain').trim().split(/\r?\n/);
        lines.forEach(ln=>{
          const vals=ln.split('\t');
          const obj={};
          campos.forEach((c,i)=>obj[c]=vals[i]||'');
          renderFila(obj);
        });
      });

      // carga inicial
      if(!isOtro){
        (async()=>{
          destinoActivo=destinoFijo;
          const col=collection(db,'Servicios',destinoActivo,'Listado');
          const snap=await getDocs(col);
          snap.forEach(dS=>{
            const d=dS.data(); d.servicio=dS.id;
            renderFila(d, doc(db,'Servicios',destinoActivo,'Listado',dS.id));
          });
        })();
      }

      return section;
    }

    // monta secciones
    destinos.forEach(d=>container.appendChild(crearSeccion(d)));

    // encabezado externo
    fetch('encabezado.html').then(r=>r.text()).then(h=>document.getElementById('encabezado').innerHTML=h);
  </script>
</body>
</html>
