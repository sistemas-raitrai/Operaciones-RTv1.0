<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Servicios Rai Trai</title>
  <link rel="stylesheet" href="estilos.css" />
  <style>
    /* ‚Äî‚Äî‚Äî Layout del header con bot√≥n de Proveedores ‚Äî‚Äî‚Äî */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    header h2 { margin: 0; }
    header button {
      background: #0055A4;
      color: #fff;
      border: none;
      padding: .5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    /* ‚Äî‚Äî‚Äî Contenedor scrollable ‚Äî‚Äî‚Äî */
    .table-wrapper {
      overflow-x: auto;    /* scroll horizontal */
      margin-bottom: 2rem;
    }

    /* ‚Äî‚Äî‚Äî Tabla nativa ‚Äî‚Äî‚Äî */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #f9f9f9;
      z-index: 2;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    /* ‚Äî‚Äî‚Äî Anchos aproximados ‚Äî‚Äî‚Äî */
    th:nth-child(1),  td:nth-child(1)   { width:   5%; }
    th:nth-child(2),  td:nth-child(2)   { width:  20%; }
    th:nth-child(3),  td:nth-child(3)   { width:  12%; }
    th:nth-child(4),  td:nth-child(4)   { width:  12%; }
    th:nth-child(5),  td:nth-child(5)   { width:  10%; }
    th:nth-child(6),  td:nth-child(6)   { width:  20%; }
    th:nth-child(7),  td:nth-child(7)   { width:  12%; }
    th:nth-child(8),  td:nth-child(8)   { width:  10%; }
    th:nth-child(9),  td:nth-child(9)   { width:   8%; }
    th:nth-child(10), td:nth-child(10)  { width:  10%; }
    th:nth-child(11), td:nth-child(11)  { width:  10%; }
    th:nth-child(12), td:nth-child(12),
    th:nth-child(13), td:nth-child(13)  { width: auto; }

    /* ‚Äî‚Äî‚Äî Sticky columnas Guardar/Eliminar ‚Äî‚Äî‚Äî */
    .col-save {
      position: sticky;
      right: 3.5rem;      /* espacio para el bot√≥n Eliminar */
      background: #fff;
      z-index: 3;
    }
    .col-del {
      position: sticky;
      right: 0;
      background: #fff;
      z-index: 3;
    }
    thead .col-save,
    thead .col-del {
      z-index: 4;
    }

    /* ‚Äî‚Äî‚Äî Botones de control internos ‚Äî‚Äî‚Äî */
    .controls { margin: .5rem 0; }
    .controls button { margin-right: .5rem; }

    /* ‚Äî‚Äî‚Äî Modal Proveedores ‚Äî‚Äî‚Äî */
    #backdrop-prov {
      display: none;
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
    }
    #modal-prov {
      display: none;
      position: fixed;
      top:50%; left:50%;
      transform: translate(-50%,-50%);
      width:90%; max-width:800px;
      background:#fff;
      border-radius:4px;
      z-index:101;
      box-shadow:0 2px 10px rgba(0,0,0,0.2);
    }
    #modal-prov .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:.5rem 1rem;
      border-bottom:1px solid #ddd;
    }
    #modal-prov .header h3 { margin:0; font-size:1.1rem; }
    #modal-prov .header button {
      background:transparent;
      border:none;
      font-size:1.2rem;
      cursor:pointer;
    }
    #modal-prov iframe {
      width:100%;
      height:70vh;
      border:none;
    }

    /* ‚Äî‚Äî‚Äî Floating editor ‚Äî‚Äî‚Äî */
    .floating-editor {
      position:absolute;
      z-index:200;
      width:300px;
      height:80px;
      resize:both;
      box-sizing:border-box;
    }
  </style>
</head>
<body>

  <!-- Header com√∫n -->
  <div id="encabezado"></div>
  <header>
    <h2>üìã Servicios</h2>
    <button id="btnProv">üõ†Ô∏è Administrar Proveedores</button>
  </header>

  <!-- Modal Proveedores -->
  <div id="backdrop-prov" onclick="closeProveedores()"></div>
  <div id="modal-prov">
    <div class="header">
      <h3>Administrar Proveedores</h3>
      <button onclick="closeProveedores()">‚úñÔ∏è</button>
    </div>
    <iframe id="iframe-prov" src=""></iframe>
  </div>

  <!-- TABLA SCROLLABLE -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Servicio</th>
          <!-- ... tus dem√°s cabeceras ... -->
          <th class="col-save">Guardar</th>
          <th class="col-del">Eliminar</th>
        </tr>
      </thead>
      <tbody id="tbody-servicios">
        <!-- Filas inyectadas por JavaScript -->
      </tbody>
    </table>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged }
      from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    // Autenticaci√≥n
    onAuthStateChanged(auth, user => {
      if (!user) location.href = 'login.html';
      else init();
    });

    // Par√°metros fijos
    const opciones = {
      tipoServicio: ['DIARIO','GENERAL','OTRO'],
      categoria:    ['NAVEGACI√ìN','ALIMENTACI√ìN','ATRACCI√ìN TUR√çSTICA','ENTRETENIMIENTO','TOUR','PARQUE ACU√ÅTICO','DISCO','OTRA'],
      formaPago:    ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro:    ['POR PERSONA','POR GRUPO','OTRO'],
      moneda:       ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };
    const campos = ['servicio','tipoServicio','categoria','ciudad','restricciones','proveedor','tipoCobro','moneda','valorServicio','formaPago'];
    const destinos = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE', null];

    let floating = null;
    function showFloatingEditor(input) {
      if (floating) floating.remove();
      floating = document.createElement('textarea');
      floating.className = 'floating-editor';
      floating.value = input.value;
      document.body.appendChild(floating);
      const r = input.getBoundingClientRect();
      floating.style.top  = (r.bottom + scrollY + 4) + 'px';
      floating.style.left = (r.left   + scrollX)     + 'px';
      floating.oninput = () => { input.value = floating.value; input.title = floating.value; };
      floating.onblur  = () => { floating.remove(); floating = null; };
      floating.focus();
    }

    function init() {
      // Carga encabezado
      fetch('encabezado.html')
        .then(r=>r.text())
        .then(html=> document.getElementById('encabezado').innerHTML = html);

      // Renderiza secciones / filas
      destinos.forEach(dest => renderSeccion(dest));

      // Listener modal Proveedores
      document.getElementById('btnProv').onclick = openProveedores;
      window.closeProveedores = closeProveedores;
    }

    async function renderSeccion(destFijo) {
      // Para simplificar, pongo todo en un √∫nico <tbody>;
      // si necesitas secciones separadas, adapta creando m√∫ltiples tablas.
      const tbody = document.getElementById('tbody-servicios');
      const destino = destFijo|| 'OTRO';

      // Cargar datos de Firestore
      const snap = await getDocs(query(
        collection(db,'Servicios',destino,'Listado'),
        orderBy('servicio','asc')
      ));

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement('tr');

        // Columna n√∫mero
        const tdNum = document.createElement('td');
        tdNum.textContent = (tbody.children.length + 1);
        tr.appendChild(tdNum);

        // Columnas de datos
        campos.forEach(c => {
          const td = document.createElement('td');
          let inp;

          if (c === 'proveedor') {
            inp = document.createElement('select');
            inp.dataset.campo = c;
            inp.innerHTML = '<option>‚Äî</option>';
            // Carga proveedores del destino
            getDocs(query(
              collection(db,'Proveedores',destino,'Listado'),
              orderBy('proveedor','asc')
            )).then(s => {
              s.forEach(d => {
                const o = new Option(d.id,d.id);
                if (d.id === data[c]) o.selected = true;
                inp.appendChild(o);
              });
            });
          }
          else if (opciones[c]) {
            inp = document.createElement('select');
            inp.dataset.campo = c;
            opciones[c].forEach(o=> inp.appendChild(new Option(o,o)));
            if (data[c]) {
              inp.value = data[c];
            }
          }
          else {
            inp = document.createElement('input');
            inp.value = data[c]||'';
            if (c!=='valorServicio') {
              inp.oninput = ()=> inp.value = inp.value.toUpperCase();
            }
            inp.dataset.campo = c;
            inp.onfocus      = ()=> showFloatingEditor(inp);
            inp.title        = inp.value;
          }

          td.appendChild(inp);
          tr.appendChild(td);
        });

        // Bot√≥n Guardar
        const tdSave = document.createElement('td');
        tdSave.classList.add('col-save');
        const btnSave= document.createElement('button');
        btnSave.textContent = 'üíæ';
        btnSave.onclick = async () => {
          // Recoge valores
          const payload = {};
          tr.querySelectorAll('td').forEach((cell,i) => {
            if (i===0) return; // salto n√∫mero
            const campo = campos[i-1];
            const inp   = cell.firstChild;
            payload[campo] = inp.multiple
              ? [...inp.selectedOptions].map(o=>o.value)
              : inp.value.trim().toUpperCase();
          });
          // Actualiza Firestore
          await setDoc(doc(db,'Servicios',destino), {_created:true}, {merge:true});
          await setDoc(
            doc(collection(db,'Servicios',destino,'Listado'), payload.servicio),
            payload
          );
          alert('‚úÖ Guardado');
        };
        tdSave.appendChild(btnSave);
        tr.appendChild(tdSave);

        // Bot√≥n Eliminar
        const tdDel = document.createElement('td');
        tdDel.classList.add('col-del');
        const btnDel= document.createElement('button');
        btnDel.textContent = 'üóëÔ∏è';
        btnDel.onclick = async () => {
          await deleteDoc(doc(db,'Servicios',destino,'Listado', data.servicio));
          tr.remove();
        };
        tdDel.appendChild(btnDel);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      });
    }

    // Modal Proveedores
    function openProveedores() {
      document.getElementById('iframe-prov').src = 'proveedores.html';
      document.getElementById('backdrop-prov').style.display = 'block';
      document.getElementById('modal-prov').style.display   = 'block';
    }
    function closeProveedores() {
      document.getElementById('iframe-prov').src = '';
      document.getElementById('backdrop-prov').style.display = 'none';
      document.getElementById('modal-prov').style.display   = 'none';
    }
  </script>
</body>
</html>
