<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Servicios Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    .section { margin-bottom: 3rem; }
    .section h3 { margin-top: 1rem; }
    .section table { width: 100%; border-collapse: collapse; }
    .section th, .section td { border: 1px solid #ccc; padding: 4px; box-sizing: border-box; }
    select, input { width: 100%; box-sizing: border-box; }
    .controls { margin: .5rem 0; }
    .controls button { margin-right: .5rem; }
    /* Modal proveedores */
    #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
             align-items:center; justify-content:center; }
    #modal .content { background:#fff; padding:1rem; border-radius:4px; width:90%; max-width:800px; position:relative; }
    #modal .close { position:absolute; top:8px; right:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <h2>üìã Listado de Servicios</h2>

  <!-- Bot√≥n modal proveedores -->
  <button style="position:absolute; top:1rem; right:1rem;" onclick="openModal()">
    üõ†Ô∏è Administrar Proveedores
  </button>
  <div id="modal">
    <div class="content">
      <span class="close" onclick="closeModal()">‚úñÔ∏è</span>
      <iframe src="proveedores.html" style="width:100%; height:80vh; border:none;"></iframe>
    </div>
  </div>

  <div id="secciones"></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    onAuthStateChanged(auth, u => { if(!u) window.location.href='login.html'; });

    const opciones = {
      tipoServicio: ['DIARIO','GENERAL','OTRO'],
      categoria:    ['NAVEGACI√ìN','ALIMENTACI√ìN','ATRACCI√ìN TUR√çSTICA','ENTRETENIMIENTO','TOUR','PARQUE ACU√ÅTICO','DISCO','OTRA'],
      formaPago:    ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro:    ['POR PERSONA','POR GRUPO','OTRO'],
      moneda:       ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };
    // campos (ya sin ‚Äúnumero‚Äù)
    const campos = [
      'servicio','tipoServicio','categoria',
      'ciudad','restricciones','proveedor','tipoCobro',
      'moneda','valorServicio','formaPago'
    ];
    const destinos = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE', null];
    const container = document.getElementById('secciones');

    function openModal(){ document.getElementById('modal').style.display='flex'; }
    function closeModal(){ document.getElementById('modal').style.display='none'; }

    function crearSeccion(destFijo){
      const isOtro = destFijo === null;
      let destActivo = destFijo;
      const sec = document.createElement('div');
      sec.className = 'section';
      sec.innerHTML = `<h3>${ isOtro ? 'OTRO' : destFijo }</h3>`;

      // 1) Creo la tabla y colgroup con anchos proporcionales
      const tbl = document.createElement('table');
      const colgroup = document.createElement('colgroup');
      // [1,5,3,3,2,5,3,2,1,2,2] unidades de 29 totales => porcentajes
      const anchos = [
        '3.45%', /* # */
        isOtro ? '6.90%' : null, /* Destino solo en OTRO */
        '17.24%', /* Servicio */
        '10.34%', /* Tipo Servicio */
        '10.34%', /* Categor√≠a */
        '6.90%',  /* Ciudad */
        '17.24%', /* Restricciones */
        '10.34%', /* Proveedor */
        '6.90%',  /* Tipo Cobro */
        '3.45%',  /* Moneda */
        '6.90%',  /* Valor Servicio */
        '6.90%'   /* Forma de Pago */
      ];
      anchos.forEach(w => {
        if(!w) return;
        const col = document.createElement('col');
        col.style.width = w;
        colgroup.appendChild(col);
      });
      tbl.appendChild(colgroup);

      // 2) Cabecera
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      hr.appendChild(Object.assign(document.createElement('th'),{ textContent:'#' }));
      if(isOtro){
        hr.appendChild(Object.assign(document.createElement('th'),{ textContent:'Destino' }));
      }
      ['Servicio','Tipo Servicio','Categor√≠a','Ciudad','Restricciones','Proveedor','Tipo Cobro','Moneda','Valor Servicio','Forma de Pago','Guardar','Eliminar']
        .forEach(txt => {
          const th = document.createElement('th');
          th.textContent = txt;
          hr.appendChild(th);
        });
      thead.appendChild(hr);
      tbl.appendChild(thead);

      const tbody = document.createElement('tbody');
      tbl.appendChild(tbody);
      sec.appendChild(tbl);

      // controles
      const ctrl = document.createElement('div');
      ctrl.className = 'controls';
      ['‚ûï Nueva fila','‚ûï‚ûï Agregar 10 filas','üíæ Guardar todo']
        .forEach((lab,i) => {
          const btn = document.createElement('button');
          btn.textContent = lab;
          btn.onclick = () => {
            if(i===0) add();
            if(i===1) Array.from({length:10}).forEach(add);
            if(i===2) saveAll();
          };
          ctrl.appendChild(btn);
        });
      sec.appendChild(ctrl);

      const filasArr = [];

      function updateNums(){
        tbody.querySelectorAll('tr').forEach((tr,i)=>{
          let td = tr.querySelector('td.rownum');
          if(!td){
            td = document.createElement('td');
            td.className = 'rownum';
            tr.insertBefore(td, tr.firstChild);
          }
          td.textContent = i+1;
        });
      }

      async function loadProv(tr){
        const sel = tr.querySelector('[data-campo=proveedor]');
        sel.innerHTML = '<option value="">‚Äî</option>';
        if(!destActivo) return;
        const col = collection(db,'Proveedores',destActivo,'Listado');
        const q   = query(col, orderBy('proveedor','asc'));
        const snap = await getDocs(q);
        snap.forEach(d=> sel.appendChild(new Option(d.id,d.id)));
      }

      function add(prefill={}, ref=null){
        const tr = document.createElement('tr');
        const inputs = [];

        // #
        tr.appendChild(Object.assign(document.createElement('td'),{ className:'rownum' }));

        // OTRO: columna Destino editable
        if(isOtro){
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.placeholder = 'Destino';
          inp.value       = prefill.destino||'';
          inp.dataset.campo = 'destino';
          inp.addEventListener('input', ()=> destActivo = inp.value.toUpperCase());
          td.appendChild(inp);
          tr.appendChild(td);
          inputs.push(inp);
        }

        campos.forEach(c=>{
          const td = document.createElement('td');
          let inp;
          if(c==='proveedor'){
            inp = document.createElement('select');
            inp.dataset.campo = c;
            inp.innerHTML = '<option value="">‚Äî</option>';
          }
          else if(opciones[c]){
            inp = document.createElement('select');
            inp.dataset.campo = c;
            if(c==='categoria'||c==='formaPago') inp.multiple = true;
            opciones[c].forEach(o=> inp.appendChild(new Option(o,o)));
            // prefill
            if(prefill[c]){
              const arr = Array.isArray(prefill[c])? prefill[c] : [prefill[c]];
              arr.forEach(v=>{
                const opt = Array.from(inp.options).find(x=>x.value===v);
                if(opt) opt.selected = true;
              });
            }
          } else {
            inp = document.createElement('input');
            inp.value = prefill[c]||'';
            if(c!=='valorServicio') inp.addEventListener('input', ()=> inp.value = inp.value.toUpperCase());
            inp.dataset.campo = c;
          }
          td.appendChild(inp);
          tr.appendChild(td);
          inputs.push(inp);
        });

        // si no es ‚ÄúOTRO‚Äù, cargo proveedores luego de montar la fila
        if(!isOtro){
          destActivo = destFijo;
          setTimeout(()=> loadProv(tr), 0);
        }

        // bot√≥n Guardar
        const tdG = document.createElement('td');
        const btnG = document.createElement('button');
        btnG.textContent = 'üíæ';
        btnG.onclick = async ()=>{
          try { await save(inputs); alert('‚úÖ'); }
          catch(e){ alert('‚ö†Ô∏è ' + e.message); }
        };
        tdG.appendChild(btnG);
        tr.appendChild(tdG);

        // bot√≥n Eliminar
        const tdD = document.createElement('td');
        const btnD = document.createElement('button');
        btnD.textContent = 'üóëÔ∏è';
        btnD.onclick = async ()=>{
          if(ref){ await deleteDoc(ref); alert('‚úÖ'); }
          tr.remove();
          updateNums();
        };
        tdD.appendChild(btnD);
        tr.appendChild(tdD);

        // pegado tab a tab
        tr.addEventListener('paste', e=>{
          e.preventDefault();
          const vs = e.clipboardData.getData('text/plain').split('\t');
          inputs.forEach((inp,i)=>{ if(vs[i]!=null) inp.value = vs[i].trim().toUpperCase(); });
        });

        tbody.appendChild(tr);
        filasArr.push({ inputs, ref });
        updateNums();
      }

      // guarda una sola fila
      async function save(inputs){
        const data = {};
        inputs.forEach(i=>{
          data[i.dataset.campo] = i.multiple
            ? [...i.selectedOptions].map(o=>o.value)
            : i.value.trim().toUpperCase();
        });
        const destino = isOtro ? data.destino : destActivo;
        if(!destino)         throw new Error('Falta Destino');
        if(!data.servicio)   throw new Error('Falta Servicio');
        if(!data.proveedor)  throw new Error('Falta Proveedor');

        // doc padre
        await setDoc(doc(db,'Servicios',destino),{_created:true},{merge:true});
        // subcolecci√≥n Listado
        const col = collection(db,'Servicios',destino,'Listado');
        const dr  = doc(col, data.servicio);
        await setDoc(dr, data);
      }

      // guarda todo
      async function saveAll(){
        for(const f of filasArr) await save(f.inputs);
        alert('‚úÖ Todos guardados');
      }

      // carga inicial
      if(!isOtro){
        (async ()=>{
          const col = collection(db,'Servicios',destFijo,'Listado');
          const snap = await getDocs(col);
          snap.forEach(d=>{
            const o = d.data();
            o.servicio = d.id;
            add(o, doc(db,'Servicios',destFijo,'Listado',d.id));
          });
        })();
      }

      return sec;
    }

    // monto las 5 secciones
    destinos.forEach(d=> container.appendChild(crearSeccion(d)));

    // cargo encabezado externo
    fetch('encabezado.html')
      .then(r=>r.text())
      .then(html=>document.getElementById('encabezado').innerHTML = html);
  </script>
</body>
</html>
