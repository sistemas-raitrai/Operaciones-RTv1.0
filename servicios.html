<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Servicios Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    /* Anchos predefinidos para columnas */
    .w-xs { width: 5%; }
    .w-sm { width: 10%; }
    .w-md { width: 20%; }
    .w-lg { width: 30%; }

    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 4px; box-sizing: border-box; }
    select, input { width: 100%; box-sizing: border-box; }
    .controls { margin: 1rem 0; }
    .controls button { margin-right: .5rem; }

    /* Modal proveedores */
    #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%;
             background: rgba(0,0,0,0.5); align-items:center; justify-content:center; }
    #modal .modal-content { background:#fff; padding:1rem; border-radius:4px;
                             width: 90%; max-width:800px; position:relative; }
    #modal .close-btn { position:absolute; top:8px; right:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <h2>üìã Listado de Servicios</h2>

  <!-- Bot√≥n para abrir modal de proveedores -->
  <button onclick="openModal()">üõ†Ô∏è Administrar Proveedores</button>

  <!-- Modal interno -->
  <div id="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">‚úñÔ∏è</span>
      <iframe src="proveedores.html" style="width:100%; height:80vh; border:none;"></iframe>
    </div>
  </div>

  <table id="tabla">
    <thead>
      <tr>
        <th class="w-xs">#</th>
        <th class="w-sm">Destino</th>
        <th class="w-sm">N¬∞ Ident.</th>
        <th class="w-md">Servicio</th>
        <th class="w-sm">Tipo Serv.</th>
        <th class="w-sm">Categor√≠a</th>
        <th class="w-sm">Ciudad</th>
        <th class="w-lg">Restricciones</th>
        <th class="w-sm">Proveedor</th>
        <th class="w-sm">Tipo Cobro</th>
        <th class="w-sm">Moneda</th>
        <th class="w-sm">Valor Serv.</th>
        <th class="w-sm">Forma de Pago</th>
        <th class="w-xs">üíæ</th>
        <th class="w-xs">üóëÔ∏è</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>

  <div class="controls">
    <button onclick="agregarFila()">‚ûï Nueva fila</button>
    <button onclick="agregarVariasFilas(10)">‚ûï‚ûï Agregar 10 filas</button>
    <button onclick="guardarTodo()">üíæ Guardar todo</button>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    // Redirige si no hay sesi√≥n
    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'login.html';
    });

    const destinos = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE','OTRO'];
    const campos   = ['destino','numero','servicio','tipoServicio','categoria',
                      'ciudad','restricciones','proveedor','tipoCobro',
                      'moneda','valorServicio','formaPago'];

    const tablaBody = document.getElementById('contenido');
    const filas     = [];

    // Numera filas
    function actualizarNumeros() {
      tablaBody.querySelectorAll('tr').forEach((tr,i) => {
        let td = tr.querySelector('td.rownum');
        if (!td) {
          td = document.createElement('td');
          td.className = 'rownum';
          tr.insertBefore(td, tr.firstChild);
        }
        td.textContent = i+1;
      });
    }

    // Crea <select> Destino
    function crearSelectDestino(valor='') {
      const sel = document.createElement('select');
      sel.dataset.campo = 'destino';
      sel.appendChild(new Option('‚Äî',''));
      destinos.forEach(d => {
        const o = new Option(d,d);
        if (d===valor) o.selected = true;
        sel.appendChild(o);
      });
      sel.onchange = () => {
        sel.value = sel.value.toUpperCase();
        cargarProveedoresFila(sel.closest('tr'));
      };
      return sel;
    }

    // Pobla <select> Proveedor seg√∫n destino
    async function cargarProveedoresFila(tr) {
      const dest   = tr.querySelector('[data-campo=destino]').value;
      const selProv= tr.querySelector('[data-campo=proveedor]');
      selProv.innerHTML = '<option value="">‚Äî</option>';
      if (!dest) return;
      const col = collection(db,'Proveedores',dest,'Listado');
      const q   = query(col,orderBy('proveedor','asc'));
      const snap= await getDocs(q);
      snap.forEach(docSnap=>{
        const p=new Option(docSnap.id,docSnap.id);
        selProv.appendChild(p);
      });
      // auto-select primero
      if(selProv.options.length>1) selProv.selectedIndex=1;
    }

    // Crea una fila nueva (o con datos)
    function agregarFila(prefill={}, ref=null) {
      const tr = document.createElement('tr');
      const inputs=[];

      // columna n√∫mero
      const td0 = document.createElement('td');
      td0.className='rownum';
      tr.appendChild(td0);

      campos.forEach(c=>{
        const td=document.createElement('td');
        let inp;
        if(c==='destino'){
          inp = crearSelectDestino((prefill[c]||'').toUpperCase());
        } else if(c==='proveedor'){
          inp = document.createElement('select');
          inp.dataset.campo='proveedor';
          inp.innerHTML='<option value="">‚Äî</option>';
        } else if(['tipoServicio','categoria','formaPago','tipoCobro','moneda'].includes(c)){
          inp = document.createElement('select');
          inp.dataset.campo=c;
          // aqu√≠ podr√≠as rellenar opciones est√°ticas si lo deseas
        } else {
          inp=document.createElement('input');
          inp.value=prefill[c]||'';
          if(c!=='valorServicio'){
            inp.addEventListener('input',()=>inp.value=inp.value.toUpperCase());
          }
          inp.dataset.campo=c;
        }
        td.appendChild(inp);
        tr.appendChild(td);
        inputs.push(inp);
      });

      // bot√≥n Guardar
      const tdG=document.createElement('td');
      const btnG=document.createElement('button');
      btnG.textContent='üíæ';
      btnG.onclick=async()=>{
        try{
          await guardarFila(inputs,ref);
          alert('‚úÖ Guardado');
        }catch(e){
          alert('‚ö†Ô∏è '+e.message);
        }
      };
      tdG.appendChild(btnG); tr.appendChild(tdG);

      // bot√≥n Eliminar
      const tdE=document.createElement('td');
      const btnE=document.createElement('button');
      btnE.textContent='üóëÔ∏è';
      btnE.onclick=async()=>{
        if(ref){
          await deleteDoc(ref);
          alert('‚úÖ Eliminado');
        }
        tr.remove();
        actualizarNumeros();
      };
      tdE.appendChild(btnE); tr.appendChild(tdE);

      // pegado tab-a-tab
      tr.addEventListener('paste',e=>{
        e.preventDefault();
        const vals=e.clipboardData.getData('text/plain').split('\t');
        inputs.forEach((inp,i)=>{
          if(vals[i]!=null) inp.value=vals[i].trim().toUpperCase();
        });
      });

      tablaBody.appendChild(tr);
      filas.push({inputs,ref});
      actualizarNumeros();
      if(prefill.destino) cargarProveedoresFila(tr);
    }

    function agregarVariasFilas(n){
      for(let i=0;i<n;i++) agregarFila();
    }

    // Guarda fila en Servicios/{destino}/Listado/{servicio}
    async function guardarFila(inputs,ref){
      const data={};
      inputs.forEach(i=> data[i.dataset.campo]=i.value.trim().toUpperCase());
      if(!data.destino)   throw new Error('Falta Destino');
      if(!data.servicio)  throw new Error('Falta Servicio');
      if(!data.proveedor) throw new Error('Falta Proveedor');

      // 1) documento padre (merge)
      const padre = doc(db,'Servicios',data.destino);
      await setDoc(padre,{_created:true},{merge:true});

      // 2) subcolecci√≥n Listado
      const col = collection(db,'Servicios',data.destino,'Listado');
      const servDoc = doc(col,data.servicio);
      await setDoc(servDoc,data);

      if(!ref){
        filas.find(f=>f.inputs===inputs).ref=servDoc;
      }
    }

    async function guardarTodo(){
      for(const f of filas){
        await guardarFila(f.inputs,f.ref);
      }
      alert('üìë Todos guardados');
    }

    // Carga inicial desde Services/{destino}/Listado
    async function cargarServicios(){
      for(const d of destinos){
        const dest=d.toUpperCase();
        const col=collection(db,'Servicios',dest,'Listado');
        const snap=await getDocs(col);
        snap.forEach(docSnap=>{
          const data=docSnap.data();
          data.destino=dest;
          data.servicio=docSnap.id;
          agregarFila(data,doc(db,'Servicios',dest,'Listado',docSnap.id));
        });
      }
    }

    // Pegado masivo en toda la tabla
    tablaBody.addEventListener('paste',e=>{
      e.preventDefault();
      const lines=e.clipboardData.getData('text/plain').trim().split(/\r?\n/);
      lines.forEach(line=>{
        const vals=line.split('\t');
        const obj={};
        campos.forEach((c,i)=> obj[c]=vals[i]||'');
        agregarFila(obj);
      });
    });

    // Modal funciones
    function openModal(){ document.getElementById('modal').style.display='flex'; }
    function closeModal(){ document.getElementById('modal').style.display='none'; }

    window.agregarFila        = agregarFila;
    window.agregarVariasFilas = agregarVariasFilas;
    window.guardarTodo        = guardarTodo;

    cargarServicios();
    fetch('encabezado.html')
      .then(r=>r.text())
      .then(html=>document.getElementById('encabezado').innerHTML=html);
  </script>
</body>
</html>
