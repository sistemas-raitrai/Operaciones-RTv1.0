<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Asignaci√≥n de Coordinadores a Viajes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    .page { padding: 1rem 1.2rem; }
    h2 { margin: .6rem 0 1rem; }
    .grid { display:grid; grid-template-columns: 340px 1fr; gap:1rem; align-items:start; }

    .panel { border:1px solid #ddd; border-radius:10px; background:#fff; }
    .panel > .hd { padding:.6rem .8rem; border-bottom:1px solid #eee; font-weight:600; }
    .panel > .bd { padding:.6rem .8rem; }
    .list { max-height:58vh; overflow:auto; }

    .card { border:1px solid #ddd; border-radius:12px; background:#fff; margin:.6rem 0; display:block; width:100%; }
    .card .hd { padding:.6rem .8rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:.5rem; }
    .card .bd { padding:.6rem .8rem; }

    .page, .page * { text-transform: uppercase; }
    .page input, .page select, .page button, .page textarea, .page table { font-family: inherit !important; font-size: 100%; }
    ::placeholder { text-transform: uppercase; }

    .muted { color:#666; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .tag { background:#eef3fa; color:#1f64b2; padding:.1rem .4rem; border-radius:6px; font-size:.85rem; }
    .pill { padding:.06rem .35rem; border-radius:999px; background:#f1f5f9; font-size:.78rem; }
    .warn { color:#c57e00; font-weight:600; }
    .err  { color:#b11;   font-weight:700; }

    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #eee; padding:.4rem .5rem; text-align:left; vertical-align:top; }
    th { background:#f8fafc; }
    input[type="text"] { width:100%; box-sizing:border-box; padding:.35rem .45rem; }
    select, input[type="date"] { padding:.35rem .45rem; }
    .empty { color:#777; font-style:italic; padding:.4rem 0; }

    .btn { background:#1f64b2; color:#fff; border:none; padding:.5rem .8rem; border-radius:6px; cursor:pointer; }
    .btn.secondary { background:#5a6a7a; }
    .btn.ghost     { background:#e8eef6; color:#1f64b2; }
    .btn.small     { padding:.3rem .55rem; font-size:.9rem; }
    .btn.small.selected-swap{ outline:2px solid #1f64b2; box-shadow:0 0 0 3px #d9e9ff inset; }
    .btn[disabled] { opacity:.65; cursor:not-allowed; }

    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; }
    .modal{
      position:fixed; left:50%; transform:translateX(-50%);
      top:4vh; width:min(1500px,96vw);
      background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2);
      display:none;                   /* oculto por defecto */
      max-height:88vh;                /* cuerpo con scroll, footer visible */
      flex-direction:column;
    }
    .modal .hd { padding:.8rem 1rem; border-bottom:1px solid #eee; font-weight:700; display:flex; justify-content:space-between; align-items:center; }
    .modal .bd { padding:1rem; overflow:auto; }
    .modal .ft { padding:.8rem 1rem; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:.5rem; }
    .x { cursor:pointer; font-size:1.4rem; line-height:1; }
    .picker-range { width:220px; }

    .toolbar{
    display:flex;
    gap:.5rem;
    align-items:center;
    flex-wrap:wrap;
    margin:.5rem 0;
  }
  .toolbar input[type="search"], .toolbar input[type="text"]{ min-width:240px; }
  .toolbar input[type="date"]{ min-width:160px; }

  /* Altura de offset si tienes un header fijo arriba */
  :root{
    --sticky-top: 72px; /* ajusta seg√∫n tu encabezado; prueba 12px si no es fijo */
  }
  
  /* Mant√©n los hijos alineados al inicio para que sticky funcione bien */
  .grid{
    align-items: start;
  }
  
  /* Haz sticky el panel izquierdo completo (Viajes Libres) */
  .grid > .panel:first-child{
    position: sticky;
    top: var(--sticky-top);
    z-index: 1;           /* que no quede tapado por sombras del otro panel */
  }
  
  /* La lista interna no debe exceder la ventana */
  .grid > .panel:first-child .list{
    max-height: calc(100vh - var(--sticky-top) - 24px);
    overflow: auto;       /* scroll interno si la lista crece */
  }
  
  /* Responsive: en pantallas chicas apila y desactiva sticky */
  @media (max-width: 900px){
    .grid{
      grid-template-columns: 1fr !important;
    }
    .grid > .panel:first-child{
      position: static;
      top: auto;
    }
    .grid > .panel:first-child .list{
      max-height: none;
      overflow: visible;
    }
  }

  .token-wrap{
  display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.4rem;
  }
  .token{
    display:inline-flex; align-items:center; gap:.35rem;
    padding:.15rem .5rem; border-radius:999px;
    background:#e8eef6; color:#1f64b2; font-weight:600; font-size:.9rem;
  }
  .token .x{
    cursor:pointer; font-weight:700; opacity:.8;
  }
  .token .x:hover{ opacity:1; }

  </style>
</head>
<body>
  <div id="encabezado"></div>

  <div class="page">
    <h2><b>Asignaci√≥n de Coordinadores a Grupo de Viajes</b></h2>

    <!-- Resumen / filtros -->
    <div class="panel" style="margin:.8rem 0;">
      <div class="hd">üìä Resumen Y Filtros</div>
      <div class="bd">
        <div class="row" style="gap:.5rem; flex-wrap:wrap; align-items:center;">
          <select id="f-destino"><option>Todos los destinos</option></select>
          <select id="f-programa"><option>Todos los programas</option></select>
          <input type="date" id="f-desde" title="Desde (fecha de inicio)">
          <input type="date" id="f-hasta" title="Hasta (fecha de inicio)">
          <input type="text" id="f-buscar" placeholder="Buscador" style="min-width:280px">
        </div>
        <div id="resumen-wrap" style="margin-top:.8rem;"></div>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="panel" id="panel-stats-viajes" style="margin:.8rem 0;">
      <div class="hd">üìà Estad√≠sticas De Viajes</div>
      <div class="bd" id="stats-viajes-wrap"><div class="empty">A√öN NO HAY DATOS.</div></div>
    </div>

    <!-- Acciones (despu√©s de estad√≠sticas) -->
    <!-- Acciones (despu√©s de estad√≠sticas) -->
    <div class="row" style="gap:.5rem; margin-bottom:1rem;">
      <button class="btn" id="btn-modal-coords">Gestionar coordinadores</button>
      <button class="btn ghost" id="btn-sugerir">Sugerir grupos de viajes (auto)</button>
      <button class="btn ghost" id="btn-nuevo-conjunto">Nuevo grupo de viajes</button>
      <button class="btn secondary" id="btn-guardar">Guardar cambios</button>
      <span id="msg" class="muted"></span>
    </div>

    <!-- Toolbar de LIBRES -->


    <div class="grid">
      <div class="panel">
        <div class="hd">üß≥ Viajes Libres</div>
        <div id="toolbar-libres" class="toolbar">
          <input id="buscar-libres" type="search" placeholder="Buscar viajes no asignados‚Ä¶" />
          <input id="f-dia-libres" type="date" title="Filtrar por fecha de inicio (libres)" />
        </div>
        <div class="bd list">
          <div id="lista-viajes-libres" class="empty">Sin datos‚Ä¶</div>
        </div>
      </div>
    
      <div class="panel">
        <div class="hd">üóÇÔ∏è Viajes</div>
        <div class="bd">
          <!-- üîé Buscador de conjuntos -->
          <div class="row" style="margin-bottom:.6rem;">
            <input
              id="buscar-sets"
              type="text"
              style="width:100%; max-width:520px"
              placeholder="Buscar en VIAJES‚Ä¶ (coordinador, alias, #negocio, id, destino, programa, fecha) ‚Äî separa con comas"
            />
            <input id="f-dia-sets" type="date" title="Filtrar por fecha de inicio (asignados)" />

          </div>
    
          <!-- Contenedor de los conjuntos -->
          <div id="conjuntos-wrap">
            <div class="empty">
              A√∫n no hay grupos de viajes. Usa ‚ÄúSugerir grupos de viajes (auto)‚Äù o ‚ÄúNuevo grupo de viajes‚Äù.
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Modal coordinadores -->
  <div id="mb" class="modal-backdrop"></div>
  <div id="modal-coords" class="modal" role="dialog" aria-modal="true" aria-label="Gestionar coordinadores">
    <div class="hd">
      <div>Gestionar Coordinadores</div>
      <div class="x" id="close-modal">√ó</div>
    </div>
    <div class="bd">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <button class="btn small" id="btn-add-coord">+ Agregar</button>
          <button class="btn small" id="btn-add-lote">+ Agregar por Excel</button>
          <input id="input-excel" type="file" accept=".xlsx,.xls" style="display:none">
        </div>
        <div class="muted">Nombre es obligatorio. Disponibilidad (rangos) es opcional.</div>
      </div>

      <table id="tabla-coords" style="margin-top:.6rem;">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>NOMBRE *</th>
            <th>RUT</th>
            <th>TEL√âFONO</th>
            <th>CORREO</th>
            <th>DESTINOS</th>
            <th>DISPONIBILIDAD</th>
            <th style="width:120px">ACCI√ìN</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="empty muted" id="hint-empty-coords" style="display:none; margin-top:.6rem;">
        No hay coordinadores a√∫n. Agrega manual o carga un Excel con columna <b>Nombre</b>.
      </div>
    </div>
    <div class="ft">
      <button class="btn secondary" id="btn-guardar-coords">Guardar coordinadores</button>
      <button class="btn ghost" id="btn-cerrar">Cerrar</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    // Importa SIEMPRE con ruta absoluta desde la ra√≠z del deployment
    import '/firebase-init.js?v=2025-08-27-2';   // ‚Üê bumpa el n√∫mero si vuelves a subir
    import '/script.js?v=2025-08-27-2';
    import '/coordinadores.js?v=2025-08-27-2';
  
    // Diagn√≥stico en runtime: confirma proyecto y databaseId reales
    const { getApp } = await import('https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js');
    const app = getApp();
    console.log('[coordinadores.html] projectId =', app.options.projectId);
  
    const init = await import('/firebase-init.js?v=2025-08-27-2');
    const { getFirestore, collection, getDocs } =
      await import('https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js');
  
    // Lee con LA MISMA instancia que usa la p√°gina
    const snap = await getDocs(collection(init.db, 'grupos'));
    console.log('[coordinadores.html] grupos size =', snap.size);
  </script>
</body>
</html>
