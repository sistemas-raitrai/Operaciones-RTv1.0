<!-- finanzas.html — Módulo Finanzas Operaciones RT (layout ancho, sin .card) -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Finanzas-Operaciones RT</title>
  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />
  <style>
    /* ======= Scope SOLO para esta página ======= */
    :root{ --fin-gap:1rem; --fin-panel-bg:#fff; --fin-panel-bd:#e5e7eb; }

    body.finanzas-page{ background:#f7f7f8; }

    /* Contenedor general (no usamos .container para evitar choques) */
    #fin-main{
      width:min(1800px,98vw);
      margin:0 auto;
      padding:1rem;
      display:grid;
      grid-template-columns:360px 1fr;   /* filtros | contenido */
      gap:var(--fin-gap);
      box-sizing:border-box;
    }
    /* header de la página ocupa el ancho completo */
    #fin-main > header.page{
      grid-column:1 / -1;
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      margin:.5rem 0;
    }
    header.page h2{ margin:0; font-weight:700; }
    .row{ display:flex; flex-wrap:wrap; align-items:center; gap:.75rem; }
    /* Por si algo intenta forzar ancho: */
    #fin-main > *{ min-width:0; }

    /* ======= Paneles (reemplazo de .card) ======= */
    .panel{
      width:100%;
      background:var(--fin-panel-bg);
      border:1px solid var(--fin-panel-bd);
      border-radius:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
      padding:1rem;
    }
    .panel--sticky{ position:sticky; top:64px; align-self:start; }
    .panel h3{ margin:.25rem 0 .6rem; }

    /* ======= Filtros (columna izquierda) ======= */
    .controls label{ font-weight:600; display:block; }
    select[multiple]{ min-width:220px; min-height:120px; }
    input[type="search"], input[type="number"], input[type="date"]{ padding:.35rem .5rem; width:100%; }
    .chips{ display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.5rem; }
    .chip{ background:#f3f4f6; border:1px solid #e5e7eb; padding:.2rem .5rem; border-radius:999px; font-size:.8rem; }

    /* ======= KPIs (columna derecha) ======= */
    .kpi-grid{
      grid-column:2 / -1;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:var(--fin-gap);
    }
    .kpi-tile{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.05); padding:1rem;
    }
    .kpi-tile h4{ margin:.25rem 0 .35rem; font-size:.95rem; color:#374151; }
    .kpi-tile .big{ font-size:1.25rem; font-weight:800; }
    .muted{ color:#6b7280; font-size:.9rem; }

    /* ======= Secciones de tablas (columna derecha) ======= */
    .fin-section{ grid-column:2 / -1; }
    .scroll-x{ overflow-x:auto; }
    .fin-table{ width:100%; border-collapse:collapse; }
    .fin-table th, .fin-table td{ border-bottom:1px solid #eee; padding:.5rem .6rem; text-align:left; }
    .fin-table th{ background:#fafafa; position:sticky; top:0; z-index:1; }
    .right{ text-align:right; }

    /* ======= Botones ======= */
    .btn{ background:#111827; color:#fff; border:none; padding:.5rem .8rem; border-radius:.5rem; cursor:pointer; font-weight:600; }
    .btn.ghost{ background:transparent; color:#111827; border:1px solid #e5e7eb; }
    .btn.secondary{ background:#e5e7eb; color:#111827; }

    /* ======= MODAL encapsulado (no usa .modal genérico) ======= */
    #backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display:none; z-index:2000;
    }
    #modal{
      position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:min(1200px,94vw); max-height:86vh; background:#fff;
      border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.35);
      display:none; overflow:hidden; z-index:2001;
    }
    #modal > header{
      position:sticky; top:0; background:#fff; padding:.6rem 1rem;
      border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;
    }
    #modal .close{ border:none; background:#f3f4f6; padding:.4rem .6rem; border-radius:.5rem; cursor:pointer; }
    .fin-modal-body{ max-height:calc(86vh - 64px); overflow:auto; padding:.75rem 1rem; }
    #modal .fin-table thead th{ position:sticky; top:0; background:#fafafa; z-index:1; }

    /* Bloquear scroll del fondo cuando está abierto */
    body.modal-open{ overflow:hidden; }

    /* ======= Evitar “superposición” de paneles en pantallas estrechas ======= */
    @media (max-width: 1100px){
      #fin-main{ grid-template-columns:1fr; }
      .kpi-grid, .fin-section{ grid-column:1 / -1; }
      .panel--sticky{ position:static; } /* en móvil no fijamos filtros */
    }
  </style>
</head>

<body class="finanzas-page">
  <!-- Encabezado común del sitio -->
  <div id="encabezado"></div>

  <main id="fin-main">
    <!-- Header local de la página -->
    <header class="page">
      <div class="row">
        <img src="Logo Raitrai.png" alt="Rai Trai" style="height:36px;width:auto;">
        <h2>Finanzas-Operaciones</h2>
        <span class="muted" id="usuario-conectado"></span>
      </div>
      <div class="row">
        <button id="btnExportCSV" class="btn ghost">Exportar CSV</button>
        <button id="btnRecalcular" class="btn">Recalcular</button>
      </div>
    </header>

    <!-- Columna izquierda: Filtros -->
    <aside id="filtersCard" class="panel panel--sticky">
      <div class="controls">
        <label for="filtroAnio">Año</label>
        <select id="filtroAnio"></select>

        <label for="filtroDestino" style="margin-top:.75rem;">Destino</label>
        <select id="filtroDestino" multiple></select>

        <div class="row" style="gap:.5rem; margin-top:.75rem;">
          <div style="flex:1">
            <label for="fechaDesde">Desde</label>
            <input type="date" id="fechaDesde">
          </div>
          <div style="flex:1">
            <label for="fechaHasta">Hasta</label>
            <input type="date" id="fechaHasta">
          </div>
        </div>

        <label class="row" style="gap:.35rem; margin-top:.5rem;">
          <input type="checkbox" id="inclActividades" checked /> Incluir actividades
        </label>
        <label class="row" style="gap:.35rem;">
          <input type="checkbox" id="inclHoteles" /> Incluir hoteles
        </label>

        <div style="margin-top:.5rem;">
          <label>Tipos de cambio → CLP</label>
          <div class="row" style="gap:.5rem;">
            <input type="number" id="tcUSD" placeholder="USD→CLP" step="1" style="width:120px;">
            <input type="number" id="tcBRL" placeholder="BRL→CLP" step="1" style="width:120px;">
          </div>
          <span class="muted">Si no indicas TC, verás subtotales por moneda y un CLP parcial.</span>
        </div>

        <div id="chipsDestino" class="chips"></div>
      </div>
    </aside>

    <!-- KPIs (columna derecha) -->
    <section class="kpi-grid">
      <div class="kpi-tile">
        <h4>Total CLP (convertido)</h4>
        <div id="kpiTotCLP" class="big">$0</div>
        <div class="muted" id="kpiOtrosMon">USD/BRL no convertidos: 0</div>
      </div>
      <div class="kpi-tile">
        <h4>Proveedores incluidos</h4>
        <div id="kpiProv" class="big">0</div>
        <div class="muted">Con al menos 1 ítem</div>
      </div>
      <div class="kpi-tile">
        <h4>Destinos incluidos</h4>
        <div id="kpiDest" class="big">0</div>
        <div class="muted">Filtrados</div>
      </div>
    </section>

    <!-- Totales por destino -->
    <section class="panel fin-section">
      <h3>Totales por destino</h3>
      <div class="scroll-x">
        <table class="fin-table" id="tblDestinos">
          <thead>
            <tr>
              <th>Destino</th>
              <th class="right">Total CLP</th>
              <th class="right">Total USD</th>
              <th class="right">Total BRL</th>
              <th class="right">Ítems</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Totales por proveedor -->
    <section class="panel fin-section">
      <h3>Totales por proveedor</h3>
      <div class="scroll-x">
        <table class="fin-table" id="tblProveedores">
          <thead>
            <tr>
              <th>Proveedor</th>
              <th>Destino(s)</th>
              <th class="right">CLP</th>
              <th class="right">USD</th>
              <th class="right">BRL</th>
              <th class="right"># Ítems</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Totales por hotel (opcional) -->
    <section class="panel fin-section" id="secHoteles" style="display:none;">
      <h3>Totales por hotel</h3>
      <div class="scroll-x">
        <table class="fin-table" id="tblHoteles">
          <thead>
            <tr>
              <th>Hotel</th>
              <th>Destino</th>
              <th class="right">CLP</th>
              <th class="right">USD</th>
              <th class="right">BRL</th>
              <th class="right"># Noches</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal detalle proveedor (IDs que usa finanzas.js) -->
  <div id="backdrop"></div>
  <div id="modal" role="dialog" aria-modal="true">
    <header>
      <h3 id="modalTitle">Detalle de proveedor</h3>
      <button class="close" id="modalClose">Cerrar</button>
    </header>

    <div class="muted" id="modalSub" style="padding:0 1rem;"></div>

    <div class="fin-modal-body">
      <div class="scroll-x">
        <table class="fin-table" id="tblDetalleProv">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Grupo</th>
              <th>Destino</th>
              <th>Actividad/Servicio</th>
              <th class="right">Pax</th>
              <th>Modalidad</th>
              <th>Moneda</th>
              <th class="right">Tarifa</th>
              <th class="right">Total (mon)</th>
              <th class="right">Total CLP</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th colspan="9" class="right">Total CLP</th>
              <th id="modalTotalCLP" class="right">$0</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="script.js"></script>
  <script type="module" src="finanzas.js"></script>
  <script>
    // por si tu finanzas.js aún no bloquea el scroll del fondo:
    (function(){
      const b = document.body, backdrop = document.getElementById('backdrop'), modal = document.getElementById('modal');
      window.addEventListener('keydown', e => { if(e.key==='Escape') closeModal && closeModal(); });
      window.openModalProveedor && (function(orig){
        window.openModalProveedor = function(){
          orig.apply(this, arguments);
          b.classList.add('modal-open');
        };
      })(window.openModalProveedor);
      window.closeModal && (function(orig){
        window.closeModal = function(){
          orig.apply(this, arguments);
          b.classList.remove('modal-open');
        };
      })(window.closeModal);
    })();
  </script>
</body>
</html>
