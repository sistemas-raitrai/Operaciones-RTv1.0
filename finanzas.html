<!-- finanzas.html — Módulo Finanzas Operaciones RT -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Finanzas | Operaciones RT</title>
  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />
  <style>
  /* ====== Página Finanzas – layout ancho 2 columnas ====== */
  body { background:#f7f7f8; }
  
  /* Contenedor ancho solo en esta página */
  body.finanzas-page .container{
    display:block !important;
    max-width:1800px; width:min(1800px,98vw);
    margin:0 auto; padding:1rem;
  }
  
  /* Shell de 2 columnas: aside (filtros) + contenido */
  body.finanzas-page .fin-shell{
    display:grid; grid-template-columns:360px 1fr;
    gap:1rem; align-items:start;
  }
  /* TODO lo que NO es el primer hijo (aside) va a la columna derecha */
  body.finanzas-page .fin-shell > :not(:first-child){
    grid-column:2 / -1; width:100%; min-width:0;
  }
  
  /* Aside fijo */
  .sticky{ position:sticky; top:64px; align-self:start; }
  
  /* ====== Header/KPIs/cards ====== */
  header.page{ display:flex; align-items:center; gap:.75rem; justify-content:space-between; margin:.75rem 0; }
  header.page h2{ margin:0; font-weight:700; }
  .row{ display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; }
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.05); padding:1rem; }
  
  .kpis{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:.75rem; }
  .kpis .kpi h4{ margin:.25rem 0 .35rem; font-size:.95rem; color:#374151; }
  .kpis .kpi .big{ font-size:1.25rem; font-weight:800; }
  .muted{ color:#6b7280; font-size:.9rem; }
  
  /* ====== Tablas ====== */
  .table{ width:100%; border-collapse:collapse; }
  .table th, .table td{ border-bottom:1px solid #eee; padding:.5rem .6rem; text-align:left; }
  .table th{ background:#fafafa; position:sticky; top:0; z-index:1; }
  .right{ text-align:right; }
  .scroll-x{ overflow-x:auto; }
  
  /* ====== Controles ====== */
  .controls label{ font-weight:600; }
  select[multiple]{ min-width:220px; min-height:120px; }
  input[type="search"], input[type="number"], input[type="date"]{ padding:.35rem .5rem; width:100%; }
  
  .btn{ background:#111827; color:#fff; border:none; padding:.5rem .8rem; border-radius:.5rem; cursor:pointer; font-weight:600; }
  .btn.secondary{ background:#e5e7eb; color:#111827; }
  .btn.ghost{ background:transparent; color:#111827; border:1px solid #e5e7eb; }
  
  .badge{ background:#eef2ff; color:#3730a3; padding:.1rem .4rem; border-radius:.5rem; font-size:.75rem; }
  .warn{ color:#b45309; }
  .ok{ color:#059669; }
  
  /* ====== Chips filtro destino ====== */
  .chips{ display:flex; gap:.4rem; flex-wrap:wrap; }
  .chip{ background:#f3f4f6; border:1px solid #e5e7eb; padding:.2rem .5rem; border-radius:999px; font-size:.8rem; }
  
  /* ====== Modal ====== */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; }
  .modal{
    position:fixed; inset:auto 0 0 0; margin:auto; top:6%;
    width:min(1100px,96%); max-height:88%; overflow:auto;
    background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:1rem; display:none;
  }
  .modal header{ display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:#fff; padding:.25rem 0; }
  .modal h3{ margin:.25rem 0; }
  .modal .close{ border:none; background:#f3f4f6; padding:.4rem .6rem; border-radius:.5rem; cursor:pointer; }

    /* ===== Forzar layout ancho en FINANZAS ===== */
  body.finanzas-page main.container{
    max-width:none !important;
    width:100% !important;           /* usar todo el ancho disponible */
    margin:0 auto;
    display:grid !important;         /* 2 columnas: filtros + contenido */
    grid-template-columns:360px minmax(720px, 1fr);
    gap:1rem;
    box-sizing:border-box;
  }
  
  /* Header de la página a lo ancho */
  body.finanzas-page main.container > header.page{
    grid-column:1 / -1;
  }
  
  /* Aside de filtros (asegúrate que tenga id="filtersCard") */
  body.finanzas-page #filtersCard{
    grid-column:1;
    position:sticky; top:64px; align-self:start;
  }
  
  /* TODO lo demás (KPIs + tablas) a la columna derecha y estirado */
  body.finanzas-page main.container > *:not(header.page):not(#filtersCard){
    grid-column:2 / -1;
    width:100%; min-width:0;
  }
  
  /* Quita límites residuales de cartas/tablas */
  body.finanzas-page .card,
  body.finanzas-page .kpis,
  body.finanzas-page section.card,
  body.finanzas-page #secHoteles { width:100%; }
  
  /* Por si estilos globales centran .container */
  body.finanzas-page .container { justify-content:stretch !important; }

  </style>
</head>
<body>
  <!-- ✅ Encabezado común -->
  <div id="encabezado"></div>

  <main class="container" style="padding:1rem;">
    <header class="page">
      <div class="row">
        <img src="Logo Raitrai.png" alt="Rai Trai" style="height:36px;width:auto;">
        <h2>Finanzas — Operaciones</h2>
        <span class="muted" id="usuario-conectado"></span>
      </div>
      <div class="row">
        <button id="btnExportCSV" class="btn ghost">Exportar CSV</button>
        <button id="btnRecalcular" class="btn">Recalcular</button>
      </div>
    </header>

    <!-- ====== Barra de Filtros ====== -->
    <section class="card">
      <div class="row controls">
        <label for="filtroAnio">Año</label>
        <select id="filtroAnio"></select>

        <label for="filtroDestino">Destino</label>
        <select id="filtroDestino" multiple></select>

        <label for="fechaDesde">Desde</label>
        <input type="date" id="fechaDesde">
        <label for="fechaHasta">Hasta</label>
        <input type="date" id="fechaHasta">

        <label class="row" style="gap:.35rem;">
          <input type="checkbox" id="inclActividades" checked /> Incluir actividades
        </label>
        <label class="row" style="gap:.35rem;">
          <input type="checkbox" id="inclHoteles" /> Incluir hoteles
        </label>
      </div>
      <div class="row controls" style="margin-top:.5rem;">
        <label>Tipos de cambio → CLP</label>
        <input type="number" id="tcUSD" placeholder="USD→CLP" step="1" style="width:120px;">
        <input type="number" id="tcBRL" placeholder="BRL→CLP" step="1" style="width:120px;">
        <span class="muted">Si no indicas TC, verás subtotales por moneda y un CLP parcial.</span>
      </div>
      <div id="chipsDestino" class="chips" style="margin-top:.5rem;"></div>
    </section>

    <!-- ====== KPIs ====== -->
    <section class="kpis" style="margin-top:.75rem;">
      <div class="card kpi">
        <h4>Total CLP (convertido)</h4>
        <div id="kpiTotCLP" class="big">$0</div>
        <div class="muted" id="kpiOtrosMon">USD/BRL no convertidos: —</div>
      </div>
      <div class="card kpi">
        <h4>Proveedores incluidos</h4>
        <div id="kpiProv" class="big">0</div>
        <div class="muted">Con al menos 1 ítem</div>
      </div>
      <div class="card kpi">
        <h4>Destinos incluidos</h4>
        <div id="kpiDest" class="big">0</div>
        <div class="muted">Filtrados</div>
      </div>
    </section>

    <!-- ====== Totales por destino ====== -->
    <section class="card" style="margin-top:.75rem;">
      <h3 style="margin:.25rem 0 .6rem;">Totales por destino</h3>
      <div class="scroll-x">
        <table class="table" id="tblDestinos">
          <thead><tr>
            <th>Destino</th>
            <th class="right">Total CLP</th>
            <th class="right">Total USD</th>
            <th class="right">Total BRL</th>
            <th class="right">Ítems</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ====== Totales por proveedor ====== -->
    <section class="card" style="margin-top:.75rem;">
      <h3 style="margin:.25rem 0 .6rem;">Totales por proveedor</h3>
      <div class="scroll-x">
        <table class="table" id="tblProveedores">
          <thead><tr>
            <th>Proveedor</th>
            <th>Destino(s)</th>
            <th class="right">CLP</th>
            <th class="right">USD</th>
            <th class="right">BRL</th>
            <th class="right"># Ítems</th>
            <th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ====== Totales por hotel (opcional) ====== -->
    <section class="card" id="secHoteles" style="margin-top:.75rem; display:none;">
      <h3 style="margin:.25rem 0 .6rem;">Totales por hotel</h3>
      <div class="scroll-x">
        <table class="table" id="tblHoteles">
          <thead><tr>
            <th>Hotel</th>
            <th>Destino</th>
            <th class="right">CLP</th>
            <th class="right">USD</th>
            <th class="right">BRL</th>
            <th class="right"># Noches</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ====== Modal detalle proveedor ====== -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <header>
      <h3 id="modalTitle">Detalle de proveedor</h3>
      <button class="close" id="modalClose">Cerrar</button>
    </header>
    <div class="muted" id="modalSub"></div>
    <div class="scroll-x" style="margin-top:.5rem;">
      <table class="table" id="tblDetalleProv">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Grupo</th>
            <th>Destino</th>
            <th>Actividad/Servicio</th>
            <th class="right">Pax</th>
            <th>Modalidad</th>
            <th>Moneda</th>
            <th class="right">Tarifa</th>
            <th class="right">Total (mon)</th>
            <th class="right">Total CLP</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot><tr>
          <th colspan="9" class="right">Total CLP</th>
          <th id="modalTotalCLP" class="right">$0</th>
        </tr></tfoot>
      </table>
    </div>
  </div>

  <!-- ✅ Encabezado + utilidades globales -->
  <script type="module" src="script.js"></script>
  <!-- ✅ Lógica del módulo -->
  <script type="module" src="finanzas.js"></script>
</body>
</html>
