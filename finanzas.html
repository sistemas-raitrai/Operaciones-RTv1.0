<!-- finanzas.html — Finanzas Operaciones RT (barra de filtros + modal con abonos/xlsx) -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Finanzas-Operaciones RT</title>
  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />

  <!-- SheetJS para exportación XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --fin-gap:1.25rem; --fin-panel-bg:#fff; --fin-panel-bd:#e5e7eb; --fin-blue:#1d4ed8; }
    body.finanzas-page{ background:#f7f7f8; overflow-x:hidden; color:#111827; }

    /* ===== Layout general ===== */
    #fin-main{ width:min(1800px,98vw); margin:0 auto; padding:1rem; display:grid; grid-template-columns: 1fr; gap: var(--fin-gap); }
    #fin-main > header.page{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin:.5rem 0; }
    header.page h2{ margin:0; font-weight:700; }
    .row{ display:flex; flex-wrap:wrap; align-items:center; gap:.75rem; }

    /* Panel genérico */
    .panel{ width:100%; background:var(--fin-panel-bg); border:1px solid var(--fin-panel-bd); border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.05); padding:1rem; }

    /* Filtros (barra) */
    #filtersCard .controls{ display:grid; grid-auto-flow:column; grid-auto-columns:max-content; grid-template-rows:auto auto; column-gap:16px; row-gap:4px; align-items:end; overflow-x:auto; padding-bottom:.25rem; scrollbar-width:thin; }
    #filtersCard .controls > label{ grid-row:1; margin:0; white-space:nowrap; font-weight:600; }
    #filtersCard .controls > label + select, #filtersCard .controls > label + input, #filtersCard .controls > label + div{ grid-row:2; }
    #filtersCard .controls > .row{ grid-row:1 / span 2; align-items:flex-end; gap:.5rem; }
    #filtersCard .controls input[type="number"], #filtersCard .controls input[type="date"], #filtersCard .controls select{ width:auto; min-width:140px; padding:.35rem .5rem; }
    #filtersCard .controls select[multiple]{ min-width:240px; min-height:110px; }

    /* KPIs */
    .kpi-grid{ display:grid; grid-template-columns:repeat(3, minmax(220px,1fr)); gap:var(--fin-gap); align-items:stretch; }
    .kpi-grid.small{ grid-template-columns:repeat(3, minmax(220px,1fr)); }
    .kpi-tile{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.05); padding:1rem; }
    .kpi-tile h4{ margin:.25rem 0 .35rem; font-size:.95rem; color:#374151; }
    .kpi-tile .big{ font-size:1.25rem; font-weight:800; }
    .muted{ color:#6b7280; font-size:.9rem; }

    /* Tablas */
    .scroll-x{ overflow-x:auto; min-width:0; }
    .fin-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    .fin-table th, .fin-table td{ border-bottom:1px solid #eee; padding:.5rem .6rem; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .fin-table thead th{ background:#fafafa; position:sticky; top:0; z-index:3; }
    .right{ text-align:right; }

    /* Botones */
    .btn{ background:#111827; color:#fff; border:none; padding:.5rem .8rem; border-radius:.5rem; cursor:pointer; font-weight:600; }
    .btn.ghost{ background:transparent; color:#111827; border:1px solid #e5e7eb; }
    .btn.secondary{ background:#e5e7eb; color:#111827; }
    .btn.blue{ background:var(--fin-blue); color:#fff; }

    /* Marcados azul */
    .is-native, .is-abono{ color:var(--fin-blue); font-weight:700; }

    /* Modal proveedor */
    #backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:2000; }
    #modal{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:min(1200px,94vw); max-height:86vh; background:#fff; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:none; overflow:hidden; z-index:2001; }
    #modal > header{ position:sticky; top:0; background:#fff; padding:.6rem 1rem; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    #modal .close{ border:none; background:#eef2ff; color:#1d4ed8; padding:.45rem .7rem; border-radius:.5rem; cursor:pointer; font-weight:700; }
    #modal .close:hover{ background:#dbeafe; }
    .fin-modal-body{ max-height:calc(86vh - 64px); overflow:auto; padding:.75rem 1rem 1rem; }
    #modal .fin-table thead th{ position:sticky; top:0; background:#fafafa; z-index:1; }
    body.modal-open{ overflow:hidden; }

    /* Modal Abono */
    #abonoBackdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:2100; }
    #abonoModal{ position:fixed; top:52%; left:50%; transform:translate(-50%,-50%); width:min(560px,95vw); background:#fff; border-radius:12px; border:1px solid #e5e7eb; box-shadow:0 20px 50px rgba(0,0,0,.35); display:none; z-index:2101; }
    #abonoModal header{ padding:.7rem 1rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    #abonoModal .content{ padding:1rem; display:grid; gap:.75rem; }
    #abonoModal label{ font-weight:600; font-size:.9rem; }
    #abonoModal input, #abonoModal select, #abonoModal textarea{ width:100%; padding:.45rem .6rem; border:1px solid #e5e7eb; border-radius:.5rem; }
    #abonoModal footer{ padding:.7rem 1rem; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:.5rem; }

    /* Responsivo */
    @media (max-width: 1100px){ .kpi-grid{ grid-template-columns:repeat(2, minmax(220px,1fr)); } }
    @media (max-width: 720px){ .kpi-grid{ grid-template-columns:1fr; } #filtersCard .controls{ grid-auto-columns:85%; } #filtersCard .controls select[multiple]{ min-width:85%; } }

    /* Anti-desplazamiento por CSS global */
    body.finanzas-page #fin-main, body.finanzas-page #fin-main *{ float:none !important; box-sizing:border-box; }
  </style>
</head>

<body class="finanzas-page">
  <div id="encabezado"></div>

  <main id="fin-main">
    <!-- Header -->
    <header class="page">
      <div class="row">
        <img src="Logo Raitrai.png" alt="Rai Trai" style="height:36px;width:auto;">
        <h2>Finanzas-Operaciones</h2>
        <span class="muted" id="usuario-conectado"></span>
      </div>
      <div class="row">
        <button id="btnExportCSV" class="btn ghost">Exportar</button>
        <button id="btnRecalcular" class="btn">Recalcular</button>
      </div>
    </header>

    <!-- Filtros -->
    <aside class="panel" id="filtersCard">
      <div class="controls">
        <label for="filtroAnio">Año</label>
        <select id="filtroAnio"></select>

        <label for="filtroDestino">Destino</label>
        <select id="filtroDestino" multiple></select>

        <div class="row">
          <div style="display:flex;flex-direction:column;gap:4px;">
            <label for="fechaDesde">Desde</label>
            <input type="date" id="fechaDesde">
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <label for="fechaHasta">Hasta</label>
            <input type="date" id="fechaHasta">
          </div>
        </div>

        <label class="row" style="gap:.35rem;">
          <input type="checkbox" id="inclActividades" checked /> Incluir actividades
        </label>
        <label class="row" style="gap:.35rem;">
          <input type="checkbox" id="inclHoteles" /> Incluir hoteles
        </label>

        <label>Tipos de cambio → CLP</label>
        <div class="row" style="gap:.5rem;">
          <input type="number" id="tcUSD" placeholder="USD→CLP" step="1" style="width:120px;">
          <input type="number" id="tcBRL" placeholder="BRL→CLP" step="1" style="width:120px;">
          <input type="number" id="tcARS" placeholder="ARS→CLP" step="1" style="width:120px;">
        </div>

        <div class="muted" style="grid-column:1 / -1; margin-top:.25rem;">
          Si no indicas TC, verás subtotales por moneda y un CLP parcial.
        </div>
      </div>
    </aside>

    <!-- KPIs y tablas principales -->
    <section class="fin-main">
      <section class="kpi-grid">
        <div class="kpi-tile">
          <h4>Total CLP (convertido)</h4>
          <div id="kpiTotCLP" class="big">$0</div>
          <div class="muted" id="kpiOtrosMon">USD/BRL/ARS no convertidos: 0</div>
        </div>
        <div class="kpi-tile">
          <h4>Proveedores incluidos</h4>
          <div id="kpiProv" class="big">0</div>
          <div class="muted">Con al menos 1 ítem</div>
        </div>
        <div class="kpi-tile">
          <h4>Destinos incluidos</h4>
          <div id="kpiDest" class="big">0</div>
          <div class="muted">Filtrados</div>
        </div>
      </section>

      <section class="panel">
        <h3>Totales por destino</h3>
        <div class="scroll-x">
          <table class="fin-table" id="tblDestinos">
            <thead>
              <tr>
                <th>Destino</th>
                <th class="right">Total CLP</th>
                <th class="right">Total USD</th>
                <th class="right">Total BRL</th>
                <th class="right">Total ARS</th>
                <th class="right">Ítems</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="panel">
        <h3>Totales por proveedor</h3>
        <div class="scroll-x">
          <table class="fin-table" id="tblProveedores">
            <thead>
              <tr>
                <th>Proveedor</th>
                <th>Destino(s)</th>
                <th class="right">CLP</th>
                <th class="right">USD</th>
                <th class="right">BRL</th>
                <th class="right">ARS</th>
                <th class="right"># Ítems</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="panel" id="secHoteles" style="display:none;">
        <h3>Totales por hotel</h3>
        <div class="scroll-x">
          <table class="fin-table" id="tblHoteles">
            <thead>
              <tr>
                <th>Hotel</th>
                <th>Destino</th>
                <th class="right">CLP</th>
                <th class="right">USD</th>
                <th class="right">BRL</th>
                <th class="right">ARS</th>
                <th class="right"># Noches</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <!-- Modal proveedor -->
  <div id="backdrop"></div>
  <div id="modal" role="dialog" aria-modal="true">
    <header>
      <div>
        <h3 id="modalTitle" style="margin:0;">Detalle de proveedor</h3>
        <div class="muted" id="modalSub"></div>
      </div>
      <div class="row">
        <button class="close" id="modalClose">Cerrar</button>
      </div>
    </header>

    <div class="fin-modal-body">
      <!-- Acciones del modal -->
      <div class="row" id="modalActions" style="justify-content:flex-end; margin-bottom:.5rem;">
        <button class="btn ghost" id="btnDetClear" style="display:none;">Ver todos</button>
        <button class="btn" id="btnExportModal" disabled>Exportar XLSX</button>
        <button class="btn blue" id="btnAbonar" disabled>Abonar</button>
      </div>

      <!-- Resumen por servicio -->
      <div class="scroll-x" style="margin-bottom:.5rem;">
        <table class="fin-table" id="tblProvResumen">
          <thead>
            <tr>
              <th>Servicio</th>
              <th class="right">CLP (eq.)</th>
              <th class="right">USD</th>
              <th class="right">BRL</th>
              <th class="right">ARS</th>
              <th class="right">Saldo (CLP eq.)</th>
              <th class="right"># Ítems</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Tarjetas Total / Abonos / Saldo (solo cuando hay servicio filtrado) -->
      <section id="resumenTotales" class="kpi-grid small" style="display:none;">
        <div class="kpi-tile">
          <h4>Total del servicio</h4>
          <div>CLP: <span id="totCLP" class="right">$0</span></div>
          <div>USD: <span id="totUSD" class="right">0</span></div>
          <div>BRL: <span id="totBRL" class="right">0</span></div>
          <div>ARS: <span id="totARS" class="right">0</span></div>
        </div>
        <div class="kpi-tile">
          <h4>Abonos registrados</h4>
          <div>CLP: <span id="aboCLP" class="right">$0</span></div>
          <div>USD: <span id="aboUSD" class="right">0</span></div>
          <div>BRL: <span id="aboBRL" class="right">0</span></div>
          <div>ARS: <span id="aboARS" class="right">0</span></div>
        </div>
        <div class="kpi-tile">
          <h4>Saldo por pagar</h4>
          <div>CLP: <span id="salCLP" class="right">$0</span></div>
          <div>USD: <span id="salUSD" class="right">0</span></div>
          <div>BRL: <span id="salBRL" class="right">0</span></div>
          <div>ARS: <span id="salARS" class="right">0</span></div>
        </div>
      </section>

      <!-- Tabla de Abonos -->
      <section id="secAbonos" class="panel" style="display:none; margin-top:.5rem;">
        <h4 style="margin-top:0;">Abonos</h4>
        <div class="scroll-x">
          <table class="fin-table" id="tblAbonos">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Moneda</th>
                <th class="right">Monto</th>
                <th class="right">CLP (eq.)</th>
                <th class="right">USD (eq.)</th>
                <th class="right">BRL (eq.)</th>
                <th class="right">ARS (eq.)</th>
                <th>Nota</th>
                <th>Comprobante</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="right">Totales</th>
                <th class="right" id="aboTotCLP">$0</th>
                <th class="right" id="aboTotUSD">0</th>
                <th class="right" id="aboTotBRL">0</th>
                <th class="right" id="aboTotARS">0</th>
                <th colspan="2"></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- Tabla de Saldo (compacta) -->
      <section id="secSaldo" class="panel" style="display:none; margin-top:.5rem;">
        <h4 style="margin-top:0;">Saldo por pagar</h4>
        <div class="scroll-x">
          <table class="fin-table" id="tblSaldoPorPagar">
            <thead>
              <tr>
                <th></th>
                <th class="right">CLP (eq.)</th>
                <th class="right">USD</th>
                <th class="right">BRL</th>
                <th class="right">ARS</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Saldo</td>
                <td class="right" id="saldoCLP">$0</td>
                <td class="right" id="saldoUSD">0</td>
                <td class="right" id="saldoBRL">0</td>
                <td class="right" id="saldoARS">0</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Detalle por ítem -->
      <div class="scroll-x" style="margin-top:.5rem;">
        <table class="fin-table" id="tblDetalleProv">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Negocio-ID</th>
              <th>Grupo</th>
              <th>Servicio</th>
              <th class="right">Pax</th>
              <th>Modalidad</th>
              <th>Moneda</th>
              <th class="right">Tarifa</th>
              <th class="right">Total (mon)</th>
              <th class="right">Total CLP</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th colspan="9" class="right">Total CLP</th>
              <th id="modalTotalCLP" class="right">$0</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal de Abono -->
  <div id="abonoBackdrop"></div>
  <div id="abonoModal" role="dialog" aria-modal="true" aria-labelledby="abonoTitle">
    <header>
      <h3 id="abonoTitle" style="margin:0;">Registrar abono</h3>
      <button class="close" id="abonoClose">Cerrar</button>
    </header>
    <div class="content">
      <div>
        <label>Servicio</label>
        <div id="abonoServicio" class="muted"></div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:.75rem;">
        <div>
          <label for="abonoFecha">Fecha</label>
          <input type="date" id="abonoFecha" />
        </div>
        <div>
          <label for="abonoMoneda">Moneda</label>
          <select id="abonoMoneda">
            <option value="CLP">CLP</option>
            <option value="USD">USD</option>
            <option value="BRL">BRL</option>
            <option value="ARS">ARS</option>
          </select>
        </div>
      </div>
      <div>
        <label for="abonoMonto">Monto</label>
        <input type="number" id="abonoMonto" step="0.01" />
      </div>
      <div>
        <label for="abonoNota">Nota (opcional)</label>
        <textarea id="abonoNota" rows="3"></textarea>
      </div>
      <div>
        <label for="abonoFile">Comprobante (imagen/PDF opcional)</label>
        <input type="file" id="abonoFile" accept="image/*,.pdf" />
      </div>
      <div class="muted" id="abonoHelp">Se guardará con snapshot de TC actuales.</div>
      <div class="muted" id="abonoError" style="color:#b91c1c; display:none;"></div>
    </div>
    <footer>
      <button class="btn ghost" id="abonoCancel">Cancelar</button>
      <button class="btn blue" id="abonoSave">Guardar abono</button>
    </footer>
  </div>

  <!-- Scripts -->
  <script type="module" src="script.js"></script>
  <script type="module" src="finanzas.js"></script>
</body>
</html>
