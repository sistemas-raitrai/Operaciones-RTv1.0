<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Revisión financiera — Sistema de Operaciones RTv1</title>

  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />

  <style>
    :root{
      --bdr:#e7e7e7;
      --bdr-strong:#ddd;
      --bg:#fff;
      --bg-soft:#fafafa;
      --txt:#111;
      --muted:.65;
      --ok:#12a150;
      --ok-ink:#0a7b3d;
      --no:#d93025;
      --no-ink:#b31206;
      --pend:#999;
    }

    .page { padding: 1rem 1.2rem; }
    .muted { opacity: var(--muted); }
    .hint  { font-size:.8rem; opacity:.75; margin-top:.35rem; }
    .mono  { font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace; }
    .small { font-size:.78rem; opacity:.85; }

    /* ===== Toolbar & tabs ===== */
    .toolbar { display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; margin:.8rem 0 1rem; }
    .toolbar .tag { font-size:.85rem; opacity:.8; }
    .toolbar input, .toolbar select {
      padding:.45rem .55rem; border:1px solid var(--bdr-strong); border-radius:10px; background:#fff;
      color:var(--txt);
    }
    .toolbar button { padding:.5rem .9rem; border:1px solid var(--bdr-strong); border-radius:10px; background:#fff; cursor:pointer; color:var(--txt); font-weight:600; }
    .toolbar button.primary { border-color:#0b57d0; }

    .state-tabs { display:flex; gap:.4rem; align-items:center; flex-wrap:wrap; }
    .state-tabs button {
      padding:.35rem .7rem; border:1px solid var(--bdr-strong); border-radius:999px;
      background:#fff; cursor:pointer; font-size:.9rem; color:var(--txt); font-weight:600; letter-spacing:.01em;
    }
    .state-tabs button.active { border-color:#0b57d0; }

    /* Filtros a la derecha en desktop */
    .toolbar #filtroTipo, .toolbar #filtroCoord, .toolbar #filtroGrupo {
      width: clamp(200px, 24vw, 330px); min-width:200px; flex:0 0 auto;
    }
    .toolbar #filtroTipo { margin-left:auto; }

    @media (max-width: 900px) {
      .toolbar #filtroTipo, .toolbar #filtroCoord, .toolbar #filtroGrupo { width:100%; min-width:0; }
      .toolbar #filtroTipo { margin-left:0; }
    }

    /* ===== Tabla ===== */
    table.finanzas { width:100%; border-collapse:collapse; background:var(--bg); border:1px solid var(--bdr); border-radius:10px; overflow:hidden; }
    table.finanzas th, table.finanzas td { padding:.6rem .65rem; border-bottom:1px solid #f1f1f1; vertical-align:middle; font-size:.92rem; }
    table.finanzas thead th { background:var(--bg-soft); text-align:left; font-weight:700; }
    table.finanzas td .small { display:block; }
    /* mayúsculas generales */
    table.finanzas th, table.finanzas td { text-transform:uppercase; }
    /* pero no fuerces monoespaciado/monedas */
    table.finanzas td .mono, table.finanzas th .mono { text-transform:none; }

    /* Ocultar col. “Grupo (ID)” en pantallas chicas */
    @media (max-width: 900px) {
      table.finanzas td:nth-child(2), table.finanzas th:nth-child(2) { display:none; }
    }

    /* Badges */
    .badge { padding:.12rem .5rem; border-radius:999px; font-size:.78rem; border:1px solid var(--bdr-strong); display:inline-block; color:var(--txt); }
    .badge.aprobado { border-color:var(--ok); }
    .badge.rechazado{ border-color:var(--no); }
    .badge.pendiente{ border-color:var(--pend); }
    .badge.cerrada  { border-color:#444; }

    /* Botón tri-estado de revisión */
    .rev-cell { display:flex; align-items:center; gap:.4rem; }
    .revbtn {
      min-width:1.9rem; height:1.7rem; line-height:1.7rem; border-radius:6px;
      border:1px solid var(--bdr-strong); background:#fff; cursor:pointer;
      font-weight:700; font-size:.95rem; padding:0 .35rem;
    }
    .revbtn[data-state="aprobado"]  { border-color:var(--ok); color:var(--ok-ink); }
    .revbtn[data-state="rechazado"] { border-color:var(--no); color:var(--no-ink); }
    .revbtn[data-state="pendiente"] { border-color:#bbb; color:#555; }

    /* Encabezados ordenables */
    table.finanzas th.sortable { cursor:pointer; user-select:none; position:relative; padding-right:1.2rem; }
    table.finanzas th.sortable::after {
      content:"↕"; position:absolute; right:.4rem; top:50%; transform:translateY(-50%); opacity:.45; font-size:.85rem;
    }
    table.finanzas th.sortable.asc::after  { content:"▲"; opacity:.85; }
    table.finanzas th.sortable.desc::after { content:"▼"; opacity:.85; }

    /* Resumen y totales en mayúsculas */
    #resumen, #totales { text-transform:uppercase; }
  </style>
</head>
<body>

  <!-- Encabezado compartido -->
  <div id="encabezado"></div>

  <div id="finanzasRoot" class="page" data-mode="sistema">
    <h2 style="margin:.4rem 0 0;">REVISIÓN FINANCIERA</h2>

    <!-- Filtros -->
    <div class="toolbar" role="region" aria-label="Filtros de revisión financiera">
      <div class="state-tabs" id="stateTabs" role="tablist" aria-label="Estados">
        <button data-estado="" class="active" role="tab" aria-selected="true">TODOS</button>
        <button data-estado="pendiente" role="tab">PENDIENTES</button>
        <button data-estado="aprobado" role="tab">APROBADOS</button>
        <button data-estado="rechazado" role="tab">RECHAZADOS</button>
        <button data-estado="pagables" role="tab" title="Aprobados sin Rev. Pago">PAGABLES</button>
        <button data-estado="cerrada" role="tab">CERRADAS</button>
      </div>

      <span class="tag" aria-hidden="true">|</span>

      <!-- Tipo: mapea con el JS (gastos->gasto, pagos->abono, todos->all) -->
      <select id="filtroTipo" aria-label="Tipo de movimiento">
        <option value="">SELECCIONA TIPO…</option>
        <option value="gastos">GASTOS</option>
        <option value="pagos">PAGOS</option>
        <option value="todos">TODOS</option>
      </select>

      <!-- Autocompletados (coinciden con IDs que usa el JS) -->
      <input id="filtroCoord" type="email" placeholder="SELECCIONA COORDINADOR(A)" list="dl-coords" aria-label="Coordinador(a)" />
      <datalist id="dl-coords"></datalist>

      <input id="filtroGrupo" type="text" placeholder="SELECCIONA GRUPO" list="dl-grupos" aria-label="Grupo" />
      <datalist id="dl-grupos"></datalist>

      <button id="btnAplicar" class="primary" title="Cargar movimientos con los filtros">APLICAR FILTROS</button>
      <button id="btnRecargar" title="Recargar catálogos (coordinadores/grupos)">RECARGAR</button>

      <span class="tag" id="resumen"></span>
      <span class="tag" id="totales"></span>
    </div>

    <!-- Tabla -->
    <table class="finanzas" id="tblFinanzas">
      <thead>
        <tr>
          <th class="sortable" data-sort-key="tipo">Tipo</th>
          <th class="sortable" data-sort-key="grupo">Grupo (ID)</th>
          <th class="sortable" data-sort-key="coord">Coordinador</th>
          <th class="sortable" data-sort-key="asunto">Asunto</th>
          <th class="sortable" data-sort-key="monto">Monto</th>
          <th class="sortable" data-sort-key="moneda">Moneda</th>
          <th class="sortable" data-sort-key="rev1">Rev. 1</th>
          <th class="sortable" data-sort-key="rev2">Rev. 2</th>
          <th class="sortable" data-sort-key="revpago">Rev. Pago</th>
          <th class="sortable" data-sort-key="estado">Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="toolbar">
      <button id="btnMas">Cargar más</button>
      <span class="hint muted" id="pagInfo"></span>
    </div>
  </div>

  <!-- Carga ordenada: encabezado → firebase → scripts -->
  <script type="module">
    (async () => {
      // Inserta encabezado
      try {
        const html = await (await fetch('encabezado.html')).text();
        document.getElementById('encabezado').innerHTML = html;
      } catch { /* opcional */ }

      // Inicializa Firebase y lógica de la página
      await import('./firebase-init.js');      // exporta app/db
      await import('./script.js');             // utilidades del encabezado (usuario, reloj, etc.)
      await import('./finanzas-revision.js');  // lógica principal de revisión
      console.log('✅ finanzas-revision.js cargado');
    })();
  </script>
</body>
</html>
