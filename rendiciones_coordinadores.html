<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rendición de gastos | RTv1</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />

  <style>
    .page { padding: 1rem 1.2rem; }

    /* Toolbar de esta página: inputs a lo ancho */
    .toolbar {
      display:flex;
      flex-direction:column;
      gap:.6rem;
      align-items:stretch;
      margin:.8rem 0 1rem;
    }
    .toolbar .tag { font-size:.85rem; opacity:.8; }
    .toolbar input,
    .toolbar select,
    .toolbar button {
      padding:.45rem .55rem;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:.9rem;
      width:100%;
      max-width:100%;
      box-sizing:border-box;
    }
    .toolbar button.primary { border-color:#0b57d0; }

    @media (min-width: 900px) {
      .toolbar {
        flex-direction:row;
        align-items:center;
      }
      .toolbar input,
      .toolbar select {
        flex:1 1 0;
      }
      .toolbar button {
        flex:0 0 auto;
        width:auto;
      }
      .toolbar .tag {
        flex:0 0 auto;
        width:auto;
      }
    }

    /* Tarjetas y tabla ocupan todo el ancho */
    #rendicionesRoot .card,
    #rendicionesRoot table.finanzas {
      width:100%;
      max-width:100%;
      box-sizing:border-box;
    }

    table.finanzas {
      border-collapse:collapse;
      background:#fff;
      border:1px solid #eee;
      border-radius:10px;
      overflow:hidden;
    }
    table.finanzas th,
    table.finanzas td {
      padding:.55rem .6rem;
      border-bottom:1px solid #f1f1f1;
      vertical-align:middle;
      font-size:.9rem;
    }
    table.finanzas thead th {
      background:#fafafa;
      text-align:left;
      font-weight:700;
      text-transform:uppercase;
    }
    table.finanzas td .mono,
    table.finanzas th .mono,
    .mono {
      font-family:ui-monospace, Menlo, Consolas, "Courier New", monospace;
      text-transform:none;
    }
    .muted { opacity:.65; }

    @media (max-width: 900px) {
      table.finanzas td:nth-child(3),
      table.finanzas th:nth-child(3) { display:none; }
    }

    .rev-cell {
      display:flex;
      align-items:center;
      gap:.35rem;
    }
    .revbtn {
      min-width:1.8rem;
      height:1.6rem;
      line-height:1.6rem;
      border-radius:6px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      padding:0 .35rem;
    }
    .monto-aprob-input { width:110px; }
    .monto-aprob-wrap.saved {
      background:#e6ffed;
      transition:background .8s;
    }

    .card {
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:1.3rem 1.5rem;
      background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
      margin-bottom:1rem;
    }
    .card h3 {
      margin:0 0 .6rem;
      font-size:1.3rem;
      color:#111827;
      border-bottom:1px solid #e5e7eb;
      padding-bottom:.5rem;
    }

    .grupo-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:.4rem .8rem;
      font-size:.9rem;
    }
    .grupo-grid span.label {
      font-weight:600;
      text-transform:uppercase;
      font-size:.76rem;
      color:#6b7280;
      display:block;
    }

    .resumen-financiero {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:1rem;
      margin-top:.5rem;
    }
    .stat-card {
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:.8rem 1rem;
      text-align:center;
    }
    .stat-card.highlight {
      background:linear-gradient(135deg,#fef9c3 0%,#fef3c7 100%);
      border-color:#f59e0b;
    }
    .stat-label {
      font-size:.8rem;
      text-transform:uppercase;
      color:#6b7280;
      margin-bottom:.3rem;
      font-weight:600;
    }
    .stat-value {
      font-size:1.3rem;
      font-weight:700;
      font-family:ui-monospace,monospace;
    }
    .stat-value.gastos { color:#dc2626; }
    .stat-value.abonos { color:#059669; }
    .stat-value.saldo { color:#1d4ed8; }

    .seccion-form {
      margin-top:1rem;
      padding-top:.8rem;
      border-top:1px dashed #e5e7eb;
    }
    .seccion-form h4 {
      margin:0 0 .7rem;
      font-size:1rem;
      display:flex;
      align-items:center;
      gap:.4rem;
    }
    .hint-inline {
      font-size:.8rem;
      font-style:italic;
      font-weight:400;
      color:#6b7280;
    }

    .form-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:.8rem;
    }
    .form-item {
      display:flex;
      flex-direction:column;
      gap:.25rem;
    }
    .form-item label {
      font-size:.78rem;
      text-transform:uppercase;
      color:#4b5563;
      font-weight:600;
    }
    .input-field {
      padding:.45rem .55rem;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:.9rem;
    }
    .input-field:focus {
      outline:none;
      border-color:#0ea5e9;
      box-shadow:0 0 0 2px rgba(14,165,233,0.2);
    }

    .link-doc {
      color:#0ea5e9;
      text-decoration:none;
      font-weight:600;
      font-size:.9rem;
    }
    .link-doc:hover { text-decoration:underline; }

    .btn-accion {
      padding:.6rem 1.2rem;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-size:.9rem;
      font-weight:600;
    }
    .btn-accion.primary {
      background:#0ea5e9;
      color:#fff;
      border-color:#0ea5e9;
    }
    .btn-accion.primary:hover {
      background:#0369a1;
      border-color:#0369a1;
    }

    @media (max-width:768px) {
      .grupo-grid,
      .resumen-financiero,
      .form-grid {
        grid-template-columns:1fr;
      }
    }

    /* PRINT: acta de rendición */
    #printActa {
      display:none;
      font-family:Calibri, Arial, sans-serif;
      font-size:11pt;
    }
    #printActa .acta {
      max-width:190mm;
      margin:0 auto;
    }
    #printActa .acta-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:12px;
    }
    #printActa .acta-head-left h1 {
      font-size:16pt;
      margin:0 0 4px;
    }
    #printActa .acta-head-left .acta-sub {
      margin:0;
      font-size:10pt;
      color:#4b5563;
    }
    #printActa .acta-logo {
      max-height:40px;
      object-fit:contain;
    }
    #printActa .acta-meta {
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:4px 12px;
      margin-bottom:12px;
      font-size:9.5pt;
    }
    #printActa .acta-meta span {
      display:block;
      text-transform:uppercase;
      font-size:8pt;
      color:#6b7280;
    }
    #printActa .acta-meta strong {
      font-weight:600;
    }
    #printActa .acta-section {
      margin-top:10px;
    }
    #printActa .acta-section h2 {
      font-size:11pt;
      margin:0 0 4px;
    }
    #printActa .acta-table {
      width:100%;
      border-collapse:collapse;
      font-size:9.5pt;
    }
    #printActa .acta-table th,
    #printActa .acta-table td {
      border:1px solid #e5e7eb;
      padding:3px 4px;
      vertical-align:top;
    }
    #printActa .acta-table th {
      background:#f9fafb;
      font-weight:600;
    }
    #printActa .acta-table .num {
      text-align:right;
      white-space:nowrap;
    }
    #printActa .acta-resumen td:first-child {
      width:70%;
    }
    #printActa .acta-firmas {
      display:flex;
      justify-content:space-between;
      gap:16mm;
      margin-top:18mm;
      font-size:9pt;
    }
    #printActa .acta-firmas .firm-line {
      border-bottom:1px solid #000;
      margin-top:18mm;
    }

    @media print {
      @page { size:A4; margin:18mm; }
      body > *:not(#printActa) { display:none !important; }
      #printActa { display:block; }
    }
    /* Fila "Agregar descuento": monto chico + motivo largo + botón al final */
    .descuento-row {
      display: flex;
      gap: .6rem;
      align-items: flex-end;
      margin-top: .4rem;
    }
    
    .descuento-row .form-item {
      margin: 0;
    }
    
    .descuento-monto {
      flex: 0 0 150px;   /* ancho fijo para el monto */
    }
    
    .descuento-motivo {
      flex: 1 1 auto;    /* el motivo ocupa todo el resto */
    }
    
    .descuento-btn {
      flex: 0 0 auto;
      white-space: nowrap;
    }
    
    /* En pantallas chicas se apila vertical */
    @media (max-width: 768px) {
      .descuento-row {
        flex-direction: column;
        align-items: stretch;
      }
    
      .descuento-monto,
      .descuento-motivo {
        flex: 1 1 auto;
      }
    
      .descuento-btn {
        width: 100%;
        text-align: center;
      }
    }
  </style>

</head>
<body>
  <div id="encabezado"></div>

  <div id="rendicionesRoot" class="page" data-mode="sistema">
    <h2 style="margin:.4rem 0 0;">RENDICIÓN DE COORDINADORES</h2>

    <!-- Filtros básicos -->
    <div class="toolbar">
      <input id="filtroCoord" type="email" placeholder="COORDINADOR(A)" list="dl-coords" />
      <datalist id="dl-coords"></datalist>

      <input id="filtroGrupo" type="text" placeholder="GRUPO (ID / Nº NEGOCIO)" list="dl-grupos" />
      <datalist id="dl-grupos"></datalist>

      <input id="filtroNombreGrupo" type="text" placeholder="NOMBRE DEL GRUPO" list="dl-grupos-nombre" />
      <datalist id="dl-grupos-nombre"></datalist>

      <button id="btnCargar" class="primary">CARGAR</button>
      <span class="tag" id="pagInfo"></span>
    </div>

    <!-- Datos del grupo -->
    <div class="card">
      <h3>Datos del grupo</h3>
      <div class="grupo-grid">
        <div>
          <span class="label">Grupo</span>
          <span id="infoGrupo">—</span>
        </div>
        <div>
          <span class="label">Coordinador(a)</span>
          <span id="infoCoord">—</span>
        </div>
        <div>
          <span class="label">Destino</span>
          <span id="infoDestino">—</span>
        </div>
        <div>
          <span class="label">Pax total</span>
          <span id="infoPax">—</span>
        </div>
        <div>
          <span class="label">Programa</span>
          <span id="infoPrograma">—</span>
        </div>
        <div>
          <span class="label">Fechas</span>
          <span id="infoFechas">—</span>
        </div>
      </div>
    </div>

    <!-- Tabla de gastos -->
    <h3>Gastos declarados</h3>
    <table class="finanzas" id="tblGastos">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Asunto</th>
          <th>Autor</th>
          <th>Moneda</th>
          <th>Monto</th>
          <th>Monto aprobado</th>
          <th>Categoría</th>
          <th>Comprobante</th>
          <th>OK</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>


    <div class="toolbar">
      <span class="tag" id="resumenTabla"></span>
      <button id="btnImprimirRendicion">Imprimir rendición</button>
    </div>

    <!-- Resumen financiero y ajustes -->
    <!-- Descuentos de rendición -->
    <div class="card">
      <h3>Descuentos de rendición</h3>
      <p class="muted" style="margin-bottom:.6rem;">
        Estos descuentos se restan de los gastos aprobados del coordinador.
      </p>

      <table class="finanzas" id="tblDescuentos">
        <thead>
          <tr>
            <th>Motivo</th>
            <th>Monto (CLP)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    <div class="seccion-form">
      <h4>Agregar descuento</h4>

      <div class="descuento-row">
        <div class="form-item descuento-monto">
          <label for="nuevoDescMonto">Monto (CLP)</label>
          <input
            id="nuevoDescMonto"
            type="number"
            min="0"
            step="1000"
            class="input-field mono"
          />
        </div>

        <div class="form-item descuento-motivo">
          <label for="nuevoDescMotivo">Motivo / asunto</label>
          <input
            id="nuevoDescMotivo"
            type="text"
            class="input-field"
          />
        </div>

        <button
          id="btnAgregarDesc"
          class="btn-accion primary descuento-btn"
          type="button"
        >
          Agregar descuento
        </button>
      </div>
    </div>

    <!-- Documentos del coordinador -->
    <div class="card">
      <h3>Documentos del coordinador</h3>

      <table class="finanzas docs-table">
        <thead>
          <tr>
            <th>Documento</th>
            <th>Estado</th>
            <th>Monto real</th>
            <th>OK</th>
          </tr>
        </thead>
        <tbody>
          <!-- TRANSFERENCIA CLP -->
          <tr>
            <td><strong>Transferencia CLP</strong></td>
            <td id="celdaEstadoTransf">
              <!-- Si aplica: link VER; si no aplica: "NO APLICA" -->
              <a id="linkComprobante" href="#" target="_blank" rel="noopener" class="link-doc">—</a>
            </td>
            <td>
              <input
                id="montoDevueltoCLP"
                type="number"
                min="0"
                step="1000"
                class="input-field mono"
              />
            </td>
            <td style="text-align:center;">
              <input type="checkbox" id="chkComprobanteOk" />
            </td>
          </tr>

          <!-- CONSTANCIA USD -->
          <tr>
            <td><strong>Constancia USD / transferencia coord.</strong></td>
            <td id="celdaEstadoConstancia">
              <a id="linkTransferencia" href="#" target="_blank" rel="noopener" class="link-doc">—</a>
            </td>
            <td>
              <input
                id="montoDevueltoUSD"
                type="number"
                step="0.01"
                min="0"
                class="input-field mono"
              />
            </td>
            <td style="text-align:center;">
              <input type="checkbox" id="chkTransferenciaOk" />
            </td>
          </tr>

          <!-- BOLETA / DOC SII -->
          <tr>
            <td><strong>Boleta / doc. SII</strong></td>
            <td id="celdaEstadoBoleta">
              <a id="linkBoleta" href="#" target="_blank" rel="noopener" class="link-doc">—</a>
            </td>
            <td class="muted" style="font-size:.8rem;">Sin monto asociado</td>
            <td style="text-align:center;">
              <input type="checkbox" id="chkBoletaOk" />
            </td>
          </tr>
        </tbody>
      </table>

      <p class="muted" style="margin-top:.6rem;font-size:.8rem;">
        * “NO APLICA” se usa cuando ese documento no corresponde para este grupo
        (por ejemplo, sin devolución en USD o sin transferencia CLP).
      </p>

      <button id="btnGuardarDocs" class="btn-accion">Guardar estado de documentos</button>
    </div>


    <!-- Resumen financiero -->
    <div class="card">
      <h3>Resumen financiero</h3>

      <div class="resumen-financiero">
        <div class="stat-card">
          <div class="stat-label">Abonos totales</div>
          <div class="stat-value abonos" id="sumAbonos">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Gastos aprobados</div>
          <div class="stat-value gastos" id="sumGastos">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Descuentos de rendición</div>
          <div class="stat-value gastos" id="sumDescuentos">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Gastos netos</div>
          <div class="stat-value gastos" id="sumGastosNetos">—</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-label">Saldo esperado (abonos – gastos netos)</div>
          <div class="stat-value saldo" id="sumSaldoEsperado">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Monto devuelto (CLP)</div>
          <div class="stat-value saldo" id="sumDevuelto">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Resultado final</div>
          <div class="stat-value saldo" id="sumResultado">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hoja de impresión -->
  <div id="printActa"></div>
  <div id="printSheet" style="display:none;"></div>

  <!-- Carga encabezado + firebase + lógica -->
  <script type="module">
    (async () => {
      try {
        const html = await (await fetch('encabezado.html')).text().catch(()=> '');
        document.getElementById('encabezado').innerHTML = html || '';
      } catch (_) {}

      await import('./firebase-init.js'); // inicializa Firebase
      await import('./script.js');        // reloj/usuario del encabezado (si lo usas)
      await import('./rendiciones_coordinadores.js'); // lógica de esta página
      console.log('✅ rendiciones_coordinadores.js cargado');
    })();
  </script>
  <script type="module" src="firebase-init.js" defer></script>
</body>
</html>
