<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rendición de gastos — Sistema de Operaciones RTv1</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />

  <style>
    .page { padding: 1rem 1.2rem; }
    .toolbar {
      display:flex; flex-wrap:wrap; gap:.6rem;
      align-items:center; margin:.8rem 0 1rem;
    }
    .toolbar .tag { font-size:.85rem; opacity:.8; }
    .toolbar input, .toolbar select {
      padding:.4rem .5rem; border:1px solid #ddd;
      border-radius:8px;
    }
    .toolbar button {
      padding:.45rem .8rem; border:1px solid #ddd;
      border-radius:10px; background:#fff; cursor:pointer;
      font-weight:600; color:#111;
    }
    .toolbar button.primary { border-color:#0b57d0; }

    table.finanzas {
      width:100%; border-collapse:collapse;
      background:#fff; border:1px solid #eee;
      border-radius:10px; overflow:hidden;
    }
    table.finanzas th, table.finanzas td {
      padding:.55rem .6rem; border-bottom:1px solid #f1f1f1;
      vertical-align:middle; font-size:.9rem;
    }
    table.finanzas thead th {
      background:#fafafa; text-align:left; font-weight:700;
      text-transform:uppercase;
    }
    table.finanzas td .mono,
    table.finanzas th .mono {
      font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace;
      text-transform:none;
    }
    .mono { font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace; }
    .muted { opacity:.65; }

    @media (max-width: 900px) {
      table.finanzas td:nth-child(3),
      table.finanzas th:nth-child(3) { display:none; }
    }

    .rev-cell {
      display:flex; align-items:center; gap:.35rem;
    }
    .revbtn {
      min-width:1.8rem; height:1.6rem; line-height:1.6rem;
      border-radius:6px; border:1px solid #ddd; background:#fff;
      cursor:pointer; font-weight:700; font-size:.9rem;
      padding:0 .35rem;
    }

    .monto-aprob-input {
      width:110px;
    }
    .monto-aprob-wrap.saved {
      background:#e6ffed;
      transition:background .8s;
    }

    .card {
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:1.3rem 1.5rem;
      background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
      margin-bottom:1rem;
    }
    .card h3 {
      margin:0 0 .6rem;
      font-size:1.3rem;
      color:#111827;
      border-bottom:1px solid #e5e7eb;
      padding-bottom:.5rem;
    }

    .grupo-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap:.4rem .8rem;
      font-size:.9rem;
    }
    .grupo-grid span.label {
      font-weight:600; text-transform:uppercase; font-size:.76rem;
      color:#6b7280; display:block;
    }

    .resumen-financiero {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:1rem; margin-top:.5rem;
    }
    .stat-card {
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:.8rem 1rem;
      text-align:center;
    }
    .stat-card.highlight {
      background:linear-gradient(135deg,#fef9c3 0%,#fef3c7 100%);
      border-color:#f59e0b;
    }
    .stat-label {
      font-size:.8rem; text-transform:uppercase;
      color:#6b7280; margin-bottom:.3rem; font-weight:600;
    }
    .stat-value {
      font-size:1.3rem; font-weight:700;
      font-family:ui-monospace,monospace;
    }
    .stat-value.gastos { color:#dc2626; }
    .stat-value.abonos { color:#059669; }
    .stat-value.saldo { color:#1d4ed8; }

    .seccion-form {
      margin-top:1rem;
      padding-top:.8rem;
      border-top:1px dashed #e5e7eb;
    }
    .seccion-form h4 {
      margin:0 0 .7rem;
      font-size:1rem;
      display:flex; align-items:center; gap:.4rem;
    }
    .hint-inline {
      font-size:.8rem; font-style:italic;
      font-weight:400; color:#6b7280;
    }

    .form-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:.8rem;
    }
    .form-item {
      display:flex; flex-direction:column; gap:.25rem;
    }
    .form-item label {
      font-size:.78rem; text-transform:uppercase;
      color:#4b5563; font-weight:600;
    }
    .input-field {
      padding:.45rem .55rem;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:.9rem;
    }
    .input-field:focus {
      outline:none;
      border-color:#0ea5e9;
      box-shadow:0 0 0 2px rgba(14,165,233,0.2);
    }

    .link-doc {
      color:#0ea5e9; text-decoration:none; font-weight:600;
      font-size:.9rem;
    }
    .link-doc:hover { text-decoration:underline; }

    .btn-accion {
      padding:.6rem 1.2rem;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-size:.9rem;
      font-weight:600;
    }
    .btn-accion.primary {
      background:#0ea5e9; color:#fff; border-color:#0ea5e9;
    }
    .btn-accion.primary:hover {
      background:#0369a1; border-color:#0369a1;
    }

    @media (max-width: 768px) {
      .grupo-grid, .resumen-financiero, .form-grid {
        grid-template-columns:1fr;
      }
    }

    /* PRINT */
    @media print {
      #encabezado, .toolbar, .btn-accion, button { display:none !important; }
      #printSheet { display:block; }
      @page { size:A4; margin:18mm; }
    }
    #printSheet {
      display:none;
      white-space:pre-wrap;
      font-family:Calibri, Arial, sans-serif;
      font-size:11pt;
    }
  </style>
</head>
<body>
  <div id="encabezado"></div>

  <div id="rendicionesRoot" class="page" data-mode="sistema">
    <h2 style="margin:.4rem 0 0;">RENDICIÓN DE GASTOS — COORDINADORES</h2>

    <!-- Filtros básicos -->
    <div class="toolbar">
      <input id="filtroCoord" type="email" placeholder="COORDINADOR(A)" list="dl-coords" />
      <datalist id="dl-coords"></datalist>

      <input id="filtroGrupo" type="text" placeholder="GRUPO (ID)" list="dl-grupos" />
      <datalist id="dl-grupos"></datalist>

      <button id="btnCargar" class="primary">CARGAR</button>
      <span class="tag" id="pagInfo"></span>
    </div>

    <!-- Datos del grupo -->
    <div class="card">
      <h3>Datos del grupo</h3>
      <div class="grupo-grid">
        <div>
          <span class="label">Grupo</span>
          <span id="infoGrupo">—</span>
        </div>
        <div>
          <span class="label">Coordinador(a)</span>
          <span id="infoCoord">—</span>
        </div>
        <div>
          <span class="label">Destino</span>
          <span id="infoDestino">—</span>
        </div>
        <div>
          <span class="label">Pax total</span>
          <span id="infoPax">—</span>
        </div>
        <div>
          <span class="label">Programa</span>
          <span id="infoPrograma">—</span>
        </div>
        <div>
          <span class="label">Fechas</span>
          <span id="infoFechas">—</span>
        </div>
      </div>
    </div>

    <!-- Tabla de gastos -->
    <h3>Gastos declarados</h3>
    <table class="finanzas" id="tblGastos">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Asunto</th>
          <th>Autor</th>
          <th>Moneda</th>
          <th>Monto</th>
          <th>Monto aprobado</th>
          <th>OK</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="toolbar">
      <span class="tag" id="resumenTabla"></span>
      <button id="btnImprimirRendicion">Imprimir rendición</button>
    </div>

    <!-- Resumen financiero y ajustes -->
    <div class="card">
      <h3>Resumen financiero</h3>

      <div class="resumen-financiero">
        <div class="stat-card">
          <div class="stat-label">Abonos totales</div>
          <div class="stat-value abonos" id="sumAbonos">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Gastos aprobados</div>
          <div class="stat-value gastos" id="sumGastos">—</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-label">Saldo (Abonos – Gastos)</div>
          <div class="stat-value saldo" id="sumSaldo">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Saldo neto (menos descuento)</div>
          <div class="stat-value saldo" id="sumSaldoNeto">—</div>
        </div>
      </div>

      <!-- Descuento -->
      <div class="seccion-form">
        <h4>Descuento / ajuste <span class="hint-inline">(si corresponde restar algo al saldo a pagar)</span></h4>
        <div class="form-grid">
          <div class="form-item">
            <label for="descuentoMonto">Monto descuento (CLP)</label>
            <input id="descuentoMonto" type="number" min="0" step="1000" class="input-field mono" />
          </div>
          <div class="form-item">
            <label for="descuentoAsunto">Motivo / asunto descuento</label>
            <input id="descuentoAsunto" type="text" class="input-field" />
          </div>
        </div>
        <button id="btnGuardarDescuento" class="btn-accion primary">Guardar descuento</button>
      </div>

      <!-- Documentos -->
      <div class="seccion-form">
        <h4>Documentos del coordinador</h4>
        <div class="form-grid">
          <div class="form-item">
            <label>Boleta</label>
            <a id="linkBoleta" href="#" target="_blank" rel="noopener" class="link-doc">—</a>
            <label style="margin-top:.25rem;">
              <input type="checkbox" id="chkBoletaOk" />
              Boleta revisada y correcta
            </label>
          </div>
          <div class="form-item">
            <label>Comprobante transferencia</label>
            <a id="linkComprobante" href="#" target="_blank" rel="noopener" class="link-doc">—</a>
            <label style="margin-top:.25rem;">
              <input type="checkbox" id="chkComprobanteOk" />
              Comprobante revisado y correcto
            </label>
          </div>
          <div class="form-item">
            <label>Transferencia coordinador</label>
            <a id="linkTransferencia" href="#" target="_blank" rel="noopener" class="link-doc">—</a>
            <label style="margin-top:.25rem;">
              <input type="checkbox" id="chkTransferenciaOk" />
              Transferencia revisada y correcta
            </label>
          </div>
        </div>
        <button id="btnGuardarDocs" class="btn-accion">Guardar estado de documentos</button>
      </div>
    </div>
  </div>

  <!-- Hoja de impresión -->
  <div id="printSheet"></div>

  <!-- Carga encabezado + firebase + lógica -->
  <script type="module">
    (async () => {
      try {
        const html = await (await fetch('encabezado.html')).text().catch(()=> '');
        document.getElementById('encabezado').innerHTML = html || '';
      } catch (_) {}

      await import('./firebase-init.js'); // inicializa Firebase
      await import('./script.js');        // reloj/usuario del encabezado (si lo usas)
      await import('./rendiciones_coordinadores.js'); // lógica de esta página
      console.log('✅ rendiciones_coordinadores.js cargado');
    })();
  </script>
  <script type="module" src="firebase-init.js" defer></script>
</body>
</html>
