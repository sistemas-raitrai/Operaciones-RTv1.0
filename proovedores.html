<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proveedores Rai Trai</title>
  <!-- Enlaza tus estilos personalizados -->
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <!-- Encabezado din√°mico: se carga externamente con fetch -->
  <div id="encabezado"></div>

  <h2 style="margin-top: 2rem;">üìã Detalle de Proveedores</h2>

  <!-- Tabla principal de proveedores -->
  <table id="tabla">
    <thead>
      <tr>
        <th>Destino</th>
        <th>N¬∞</th>
        <th>Actividad</th>
        <th>Servicios</th>
        <th>Tipo de Servicio</th>
        <th>Ciudad</th>
        <th>Restricciones</th>
        <th>Proveedor</th>
        <th>Contacto</th>
        <th>Correo</th>
        <th>Tipo Cobro</th>
        <th>Moneda</th>
        <th>Valor Servicio</th>
        <th>Forma de Pago</th>
        <th>Guardar</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>

  <!-- Botones de acci√≥n: agregar filas y guardar todo -->
  <div style="margin-top: 1rem;">
    <button onclick="agregarFila()">‚ûï Nueva fila</button>
    <button onclick="agregarVariasFilas(10)">‚ûï‚ûï Agregar 10 filas</button>
    <button onclick="guardarTodo()">üíæ Guardar todo</button>
  </div>

  <script type="module">
    // Inicializaci√≥n de Firebase Auth y Firestore
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection,
      getDocs,
      doc,
      setDoc,
      addDoc,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    // Verifica sesi√≥n: si no hay usuario, redirige a login
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          const usernameSpan = document.querySelector('.username');
          if (usernameSpan) usernameSpan.textContent = user.email;
        });
      }
    });

    // Opciones para generar <select> din√°micos
    const opciones = {
      destino:      ['BRASIL','SUR DE CHILE','BARILOCHE','NORTE DE CHILE','OTRO'],
      servicios:    ['DIARIO','GENERAL','OTRO'],
      tipoServicio: ['NAVEGACI√ìN','ALIMENTACI√ìN','ATRACCI√ìN TUR√çSTICA','ENTRETENCI√ìN','TOUR','PARQUE ACU√ÅTICO','DISCO','OTRA'],
      formaPago:    ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro:    ['POR PERSONA','POR GRUPO','OTRO'],
      moneda:       ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };

    // Referencia al <tbody> donde se a√±aden las filas
    const tabla = document.getElementById('contenido');
    // Almacena referencias a inputs y IDs de Firestore
    const filas = [];

    /**
     * Crea y a√±ade una nueva fila en la tabla.
     * @param {Object} dato  - Valores para prefilling (opcional)
     * @param {string} docId - ID de Firestore si ya existe
     */
    function agregarFila(dato = {}, docId = null) {
      const fila = document.createElement('tr');
      const campos = [
        'destino','numero','actividad','servicios','tipoServicio',
        'ciudad','restricciones','proveedor','contacto','correo',
        'tipoCobro','moneda','valorServicio','formaPago'
      ];
      const inputsRef = [];

      campos.forEach(campo => {
        const td = document.createElement('td');
        let input;

        // Si hay opciones, crea select
        if (opciones[campo]) {
          input = document.createElement('select');
          opciones[campo].forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            input.appendChild(option);
          });
          input.value = dato[campo] || '';
        } else {
          input = document.createElement('input');
          input.value = dato[campo] || '';
          // Forzar may√∫sculas salvo valorServicio
          if (campo !== 'valorServicio') {
            input.addEventListener('input', () => {
              input.value = input.value.toUpperCase();
            });
          }
        }

        input.dataset.campo = campo;
        inputsRef.push(input);
        td.appendChild(input);
        fila.appendChild(td);
      });

      // Bot√≥n guardar
      const tdGuardar = document.createElement('td');
      const btnGuardar = document.createElement('button');
      btnGuardar.textContent = 'üíæ';
      btnGuardar.onclick = async () => {
        await guardarFila(inputsRef, docId);
        alert('Registro guardado ‚úÖ');
      };
      tdGuardar.appendChild(btnGuardar);
      fila.appendChild(tdGuardar);

      // Bot√≥n eliminar
      const tdEliminar = document.createElement('td');
      const btnEliminar = document.createElement('button');
      btnEliminar.textContent = 'üóëÔ∏è';
      btnEliminar.onclick = async () => {
        if (docId) {
          await deleteDoc(doc(db,'proveedores',docId));
          alert('Registro eliminado de Firebase ‚úÖ');
        }
        fila.remove();
      };
      tdEliminar.appendChild(btnEliminar);
      fila.appendChild(tdEliminar);

      tabla.appendChild(fila);
      filas.push({ inputs: inputsRef, docId });

      // Soporte pegado por celda (tab)
      fila.addEventListener('paste', e => {
        const texto = e.clipboardData.getData('text/plain');
        const valores = texto.split('\t');
        valores.forEach((val,i) => {
          if (inputsRef[i]) inputsRef[i].value = val.trim().toUpperCase();
        });
      });
    }

    /**
     * Guarda o actualiza el documento en Firestore.
     */
    async function guardarFila(inputsRef, docId) {
      const data = {};
      inputsRef.forEach(input => {
        const campo = input.dataset.campo;
        let val = input.value.trim();
        data[campo] = (campo==='valorServicio') ? Number(val)||0 : val.toUpperCase();
      });
      if (docId) await setDoc(doc(db,'proveedores',docId),data);
      else      await addDoc(collection(db,'proveedores'),data);
    }

    /**
     * Agrega N filas vac√≠as.
     */
    function agregarVariasFilas(n) {
      for(let i=0;i<n;i++) agregarFila();
    }

    /**
     * Guarda todo el contenido de la tabla.
     */
    async function guardarTodo() {
      for(const fila of filas) {
        await guardarFila(fila.inputs,fila.docId);
      }
      alert('Todos los registros guardados ‚úÖ');
    }

    /**
     * Carga datos desde Firestore al iniciar.
     */
    async function cargarRegistros() {
      const snap = await getDocs(collection(db,'proveedores'));
      const docs = [];
      snap.forEach(s=>docs.push({id:s.id,data:s.data()}));
      docs.sort((a,b)=>a.data.destino.localeCompare(b.data.destino));
      docs.forEach(d=>agregarFila(d.data,d.id));
    }

    // ===========================================
    // Inicializaci√≥n
    cargarRegistros();

    // Soporte pegado m√∫ltiple: crea filas para cada l√≠nea
    const campos = [
      'destino','numero','actividad','servicios','tipoServicio',
      'ciudad','restricciones','proveedor','contacto','correo',
      'tipoCobro','moneda','valorServicio','formaPago'
    ];
    tabla.addEventListener('paste',e=>{
      e.preventDefault();
      const texto = e.clipboardData.getData('text/plain').trim();
      texto.split(/\r?\n/).forEach(line=>{
        if(!line) return;
        const vals = line.split('\t');
        const d={};
        campos.forEach((c,i)=>d[c]=vals[i]?vals[i].trim(): '');
        agregarFila(d,null);
      });
    });
    // Exponer funciones al global
    window.agregarFila = agregarFila;
    window.agregarVariasFilas = agregarVariasFilas;
    window.guardarTodo = guardarTodo;

    // Carga encabezado externo
    fetch('encabezado.html')
      .then(r=>r.text())
      .then(html=>{
        document.getElementById('encabezado').innerHTML=html;
        if(typeof iniciarReloj==='function') iniciarReloj();
      });
  </script>
</body>
</html>
