<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Actividades Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div id="encabezado"></div>
  <h2 style="margin-top: 2rem;">📋 Detalle de Actividades</h2>
  <table id="tabla">
    <thead>
      <tr>
        <th>Destino</th>
        <th>N°</th>
        <th>Actividad</th>
        <th>Servicios</th>
        <th>Tipo de Servicio</th>
        <th>Ciudad</th>
        <th>Restricciones</th>
        <th>Proveedor</th>
        <th>Contacto</th>
        <th>Correo</th>
        <th>Tipo Cobro</th>
        <th>Moneda</th>
        <th>Valor Servicio</th>
        <th>Forma de Pago</th>
        <th>Guardar</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>
  <div style="margin-top: 1rem;">
    <button onclick="agregarFila()">➕ Nueva fila</button>
    <button onclick="agregarVariasFilas(10)">➕➕ Agregar 10 filas</button>
    <button onclick="guardarTodo()">💾 Guardar todo</button>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection,
      getDocs,
      doc,
      setDoc,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'login.html';
    });

    const opciones = {
      destino: ['BRASIL','SUR DE CHILE','BARILOCHE','NORTE DE CHILE','OTRO'],
      servicios: ['DIARIO','GENERAL','OTRO'],
      tipoServicio: ['NAVEGACIÓN','ALIMENTACIÓN','ATRACCIÓN TURÍSTICA','ENTRETENCIÓN','TOUR','PARQUE ACUÁTICO','DISCO','OTRA'],
      formaPago: ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro: ['POR PERSONA','POR GRUPO','OTRO'],
      moneda: ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };

    const tabla = document.getElementById('contenido');
    const filas = [];
    const campos = ['destino','numero','actividad','servicios','tipoServicio','ciudad','restricciones','proveedor','contacto','correo','tipoCobro','moneda','valorServicio','formaPago'];

    function agregarFila(dato = {}, docMeta = {}) {
      const fila = document.createElement('tr');
      const inputsRef = [];
      campos.forEach(campo => {
        const td = document.createElement('td');
        let input;
        if (opciones[campo]) {
          input = document.createElement('select');
          opciones[campo].forEach(opt => {
            const o = document.createElement('option'); o.value = opt; o.textContent = opt;
            input.appendChild(o);
          });
          input.value = dato[campo] || '';
        } else {
          input = document.createElement('input');
          input.value = dato[campo] || '';
          if (campo !== 'valorServicio') input.addEventListener('input',()=>input.value=input.value.toUpperCase());
        }
        input.dataset.campo = campo;
        inputsRef.push(input);
        td.appendChild(input);
        fila.appendChild(td);
      });
      // Guardar
      const tdG = document.createElement('td');
      const btnG = document.createElement('button'); btnG.textContent='💾';
      btnG.onclick = async () => { await guardarFila(inputsRef); alert('Guardado ✅'); };
      tdG.appendChild(btnG); fila.appendChild(tdG);
      // Eliminar
      const tdE = document.createElement('td');
      const btnE = document.createElement('button'); btnE.textContent='🗑️';
      btnE.onclick = async () => { await eliminarFila(inputsRef); fila.remove(); };
      tdE.appendChild(btnE); fila.appendChild(tdE);

      tabla.appendChild(fila);
      filas.push({ inputs: inputsRef });
    }

    async function guardarFila(inputsRef) {
      const data = {};
      inputsRef.forEach(input => {
        const key = input.dataset.campo;
        const val = input.value.trim();
        data[key] = (key === 'valorServicio') ? Number(val) || 0 : val.toUpperCase();
      });
      const destino = data.destino;
      const actividad = data.actividad;
      if (!destino || !actividad) {
        alert('Debes completar Destino y Actividad antes de guardar.');
        return;
      }
      // Referencia a la subcolección Actividades/{destino}/Detalles
      const detallesCol = collection(db, 'Actividades', destino, 'Detalles');
      // Documento con ID igual a la actividad
      const docRef = doc(detallesCol, actividad);
      await setDoc(docRef, data);
    }

    async function eliminarFila(inputsRef) {
      const destino = inputsRef.find(i => i.dataset.campo === 'destino').value;
      const actividad = inputsRef.find(i => i.dataset.campo === 'actividad').value;
      if (!destino || !actividad) {
        alert('Debes completar Destino y Actividad para eliminar.');
        return;
      }
      // Referencia al documento a eliminar en la subcolección
      const docRef = doc(db, 'Actividades', destino, 'Detalles', actividad);
      await deleteDoc(docRef);
    }

      // Referencia al documento a eliminar
      const docRef = doc(db, 'Actividades', destino, 'Detalles', actividad);
      await deleteDoc(docRef);
    }
    async function eliminarFila(inputsRef) {
      const dest = inputsRef.find(i=>i.dataset.campo==='destino').value;
      const act  = inputsRef.find(i=>i.dataset.campo==='actividad').value;
      await deleteDoc(doc(db,'Actividades',dest,'Detalles',act));
    }

    function agregarVariasFilas(n){ for(let i=0;i<n;i++) agregarFila(); }
    async function guardarTodo(){ for(const f of filas) await guardarFila(f.inputs); alert('Todos guardados ✅'); }

    async function cargarRegistros(){
      const actSnap = await getDocs(collection(db,'Actividades'));
      for(const docD of actSnap.docs){
        const destino = docD.id;
        const detSnap = await getDocs(collection(db,'Actividades',destino,'Detalles'));
        detSnap.forEach(d=>agregarFila({ destino, ...d.data() }));
      }
    }

    cargarRegistros();

    // Pegado múltiple
    tabla.addEventListener('paste', e=>{
      e.preventDefault();
      e.clipboardData.getData('text/plain').trim().split(/\r?\n/).forEach(line=>{
        if(!line) return;
        const vals = line.split('\t');
        const d={}; campos.forEach((c,i)=>d[c]=vals[i]?vals[i].trim(): '');
        agregarFila(d);
      });
    });

    window.agregarFila=agregarFila;
    window.agregarVariasFilas=agregarVariasFilas;
    window.guardarTodo=guardarTodo;

    fetch('encabezado.html').then(r=>r.text()).then(html=>{document.getElementById('encabezado').innerHTML=html;});
  </script>
</body>
</html>
