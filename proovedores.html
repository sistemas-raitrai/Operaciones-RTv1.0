<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Actividades Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div id="encabezado"></div>
  <h2 style="margin-top: 2rem;">📋 Detalle de Actividades</h2>

  <table id="tabla">
    <thead>
      <tr>
        <th>Destino</th>
        <th>N°</th>
        <th>Actividad</th>
        <th>Servicio</th>
        <th>Tipo de Servicio</th>
        <th>Ciudad</th>
        <th>Restricciones</th>
        <th>Proveedor</th>
        <th>Contacto</th>
        <th>Correo</th>
        <th>Tipo Cobro</th>
        <th>Moneda</th>
        <th>Valor Servicio</th>
        <th>Forma de Pago</th>
        <th>Guardar</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>

  <div style="margin-top: 1rem;">
    <button onclick="agregarFila()">➕ Nueva fila</button>
    <button onclick="agregarVariasFilas(10)">➕➕ Agregar 10 filas</button>
    <button onclick="guardarTodo()">💾 Guardar todo</button>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import { collection, getDocs, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    // Asegura sesión
    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'login.html';
    });

    // Opciones para selects
    const opciones = {
      destino:      ['BRASIL','SUR DE CHILE','BARILOCHE','NORTE DE CHILE','OTRO'],
      servicios:    ['DIARIO','GENERAL','OTRO'],
      tipoServicio: ['NAVEGACIÓN','ALIMENTACIÓN','ATRACCIÓN TURÍSTICA','ENTRETENCIÓN','TOUR','PARQUE ACUÁTICO','DISCO','OTRA'],
      formaPago:    ['EFECTIVO','CTA CORRIENTE','OTRO'],
      tipoCobro:    ['POR PERSONA','POR GRUPO','OTRO'],
      moneda:       ['PESO CHILENO','PESO ARGENTINO','REAL','USD','OTRO']
    };

    const tabla = document.getElementById('contenido');
    const filas = [];
    const campos = [
      'destino','numero','actividad','servicios','tipoServicio',
      'ciudad','restricciones','proveedor','contacto','correo',
      'tipoCobro','moneda','valorServicio','formaPago'
    ];

    // Crea una fila: si 'dato' viene vacío, es una nueva
    function agregarFila(dato = {}) {
      const fila = document.createElement('tr');
      const inputs = [];

      campos.forEach(c => {
        const td = document.createElement('td');
        let input;
        if (opciones[c]) {
          input = document.createElement('select');
          opciones[c].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt; o.textContent = opt;
            input.appendChild(o);
          });
          input.value = dato[c] || '';
        } else {
          input = document.createElement('input');
          input.value = dato[c] || '';
          if (c !== 'valorServicio') {
            input.addEventListener('input', () => input.value = input.value.toUpperCase());
          }
        }
        input.dataset.campo = c;
        inputs.push(input);
        td.appendChild(input);
        fila.appendChild(td);
      });

      // Botón Guardar
      const tdG = document.createElement('td');
      const btnG = document.createElement('button');
      btnG.textContent = '💾';
      btnG.onclick = async () => {
        await guardarFila(inputs);
        alert('Guardado ✅');
      };
      tdG.appendChild(btnG);
      fila.appendChild(tdG);

      // Botón Eliminar
      const tdE = document.createElement('td');
      const btnE = document.createElement('button');
      btnE.textContent = '🗑️';
      btnE.onclick = async () => {
        await eliminarFila(inputs);
        fila.remove();
      };
      tdE.appendChild(btnE);
      fila.appendChild(tdE);

      // Pegado por celda
      fila.addEventListener('paste', e => {
        e.preventDefault();
        const vals = e.clipboardData.getData('text/plain').split('\t');
        vals.forEach((v, i) => {
          if (inputs[i]) inputs[i].value = v.trim().toUpperCase();
        });
      });

      tabla.appendChild(fila);
      filas.push(inputs);
    }

    // Guarda una sola fila en Actividades/{destino}/{actividad}
    async function guardarFila(inputs) {
      const data = {};
      inputs.forEach(i => {
        const key = i.dataset.campo;
        data[key] = key === 'valorServicio'
          ? Number(i.value) || 0
          : i.value.trim().toUpperCase();
      });
    
      const { destino, actividad } = data;
      if (!destino || !actividad) {
        alert('Completa Destino y Actividad antes de guardar.');
        return;
      }
    
      // Documento en Actividades/{destino}/{actividad}
      const docRef = doc(db, 'Actividades', destino, actividad);
      await setDoc(docRef, data);
    }

    // Elimina Actividades/{destino}/{actividad}
    async function eliminarFila(inputs) {
      const destino   = inputs.find(i => i.dataset.campo === 'destino').value;
      const actividad = inputs.find(i => i.dataset.campo === 'actividad').value;
      if (!destino || !actividad) {
        alert('Completa Destino y Actividad antes de eliminar.');
        return;
      }
    
      const docRef = doc(db, 'Actividades', destino, actividad);
      await deleteDoc(docRef);
    }

    // Agrega N filas vacías
    function agregarVariasFilas(n) {
      for (let i=0; i<n; i++) agregarFila();
    }

    // Guarda todas las filas en un solo clic
    async function guardarTodo() {
      for (const inputs of filas) {
        await guardarFila(inputs);
      }
      alert('Todos los registros guardados ✅');
    }

    // Carga inicial: recorre Actividades y subcolección Detalles
    async function cargarRegistros() {
      // Obtiene todos los destinos
      const destSnap = await getDocs(collection(db, 'Actividades'));
      for (const docDest of destSnap.docs) {
        const destino = docDest.id;
        // Obtiene cada actividad (documento) bajo Actividades/{destino}
        const actSnap = await getDocs(collection(db, 'Actividades', destino));
        actSnap.forEach(docAct => {
          // docAct.id es el nombre de la actividad
          agregarFila({ destino, actividad: docAct.id, ...docAct.data() });
        });
      }
    }

    // Soporte pegado múltiple en <tbody>
    tabla.addEventListener('paste', e => {
      e.preventDefault();
      const lineas = e.clipboardData.getData('text/plain').trim().split(/\r?\n/);
      lineas.forEach(l => {
        const vals = l.split('\t');
        const dato = {};
        campos.forEach((c,i) => dato[c] = vals[i] ? vals[i].trim() : '');
        agregarFila(dato);
      });
    });

    // Exponer API al global (para los onclick)
    window.agregarFila = agregarFila;
    window.agregarVariasFilas = agregarVariasFilas;
    window.guardarTodo = guardarTodo;

    // Inicia carga de datos y encabezado
    cargarRegistros();
    fetch('encabezado.html')
      .then(r => r.text())
      .then(html => document.getElementById('encabezado').innerHTML = html);
  </script>
</body>
</html>
