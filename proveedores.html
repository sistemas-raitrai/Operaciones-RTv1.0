<!-- proveedores.html (MEJORADO + BLOQUE DE FILTROS TIPO servicios.html) -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proveedores Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    /* ====== Cabecera ====== */
    header { display:flex; justify-content:space-between; align-items:center; margin:.5rem 0 }
    header h2 { margin:0 }

    /* ====== Secciones y controles ====== */
    .section { margin:1.25rem 0; }
    .section h3 { margin:.25rem 0 .5rem }
    .controls { display:flex; gap:.5rem; margin:.5rem 0 }
    .controls button{ padding:.35rem .8rem; border:none; background:#0055A4; color:#fff; border-radius:4px; cursor:pointer }

    /* ====== Tabla ====== */
    .table-wrapper { overflow-x:auto }
    table { width:100%; border-collapse:collapse; table-layout:fixed; margin-top:.25rem }
    thead th { position:sticky; top:0; background:#f9f9f9; z-index:2 }
    th, td { border:1px solid #ccc; padding:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; text-align:left }

    /* Anchos en secciones FIJAS (sin columna Destino) */
    .tbl-fixed th:nth-child(1), .tbl-fixed td:nth-child(1){ width:28% } /* Proveedor */
    .tbl-fixed th:nth-child(2), .tbl-fixed td:nth-child(2){ width:22% } /* Contacto  */
    .tbl-fixed th:nth-child(3), .tbl-fixed td:nth-child(3){ width:16% } /* Tel√©fono  */
    .tbl-fixed th:nth-child(4), .tbl-fixed td:nth-child(4){ width:24% } /* Correo    */
    .tbl-fixed th:nth-child(5), .tbl-fixed td:nth-child(5){ width:5% }  /* üíæ        */
    .tbl-fixed th:nth-child(6), .tbl-fixed td:nth-child(6){ width:5% }  /* üóëÔ∏è        */

    /* Anchos en secci√≥n OTRO (con columna Destino) */
    .tbl-otro th:nth-child(1), .tbl-otro td:nth-child(1){ width:18% }   /* Destino   */
    .tbl-otro th:nth-child(2), .tbl-otro td:nth-child(2){ width:26% }   /* Proveedor */
    .tbl-otro th:nth-child(3), .tbl-otro td:nth-child(3){ width:20% }   /* Contacto  */
    .tbl-otro th:nth-child(4), .tbl-otro td:nth-child(4){ width:12% }   /* Tel√©fono  */
    .tbl-otro th:nth-child(5), .tbl-otro td:nth-child(5){ width:18% }   /* Correo    */
    .tbl-otro th:nth-child(6), .tbl-otro td:nth-child(6){ width:3% }    /* üíæ        */
    .tbl-otro th:nth-child(7), .tbl-otro td:nth-child(7){ width:3% }    /* üóëÔ∏è        */

    /* ====== BLOQUE DE FILTROS (igual a servicios.html) ====== */
    .filters{
      display: grid;
      grid-template-columns: minmax(280px, 340px) 1fr; /* select izq, buscador ocupa el resto */
      align-items: end;
      gap: 1rem;
      width: 100%;
      background:#fff; border:1px solid #ddd; border-radius:6px;
      padding:.75rem 1rem; margin:.75rem 0 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    @media (max-width: 900px){
      .filters{ grid-template-columns: 1fr; }
    }
    .filters .field{
      display:flex; flex-direction:column; gap:.25rem;
    }
    .filters .field label{
      margin:0 !important; font-weight:600; color:#333;
    }
    /* Select multi (destinos) */
    #destFilter{
      width: 100%;
      min-width: 280px;
      height: 150px;
      border:1px solid #bbb; border-radius:6px;
      padding:.35rem .5rem; box-sizing:border-box;
      background:#f9f9f9;
    }
    /* Buscador expandible */
    #search{
      width:100%; height: 42px;
      border:1px solid #bbb; border-radius:6px;
      padding: 0 .75rem; box-sizing:border-box;
      background:#fff;
    }
    #destFilter:focus, #search:focus{
      outline: 2px solid #0b3d91;
      border-color: #0b3d91;
    }

    /* Editor flotante (por consistencia; aqu√≠ no se usa) */
    .floating-editor{ position:absolute; z-index:200; width:300px; height:80px; resize:both; box-sizing:border-box }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <header>
    <h2>üìã LISTADO DE PROVEEDORES</h2>
  </header>

  <!-- Filtros (destinos + buscador) en tarjeta full-width -->
  <div id="filters" class="filters">
    <div class="field">
      <label for="destFilter">Filtrar destinos</label>
      <select id="destFilter" multiple>
        <option value="ALL">‚Äî Todos ‚Äî</option>
        <option value="BRASIL">BRASIL</option>
        <option value="BARILOCHE">BARILOCHE</option>
        <option value="SUR DE CHILE">SUR DE CHILE</option>
        <option value="NORTE DE CHILE">NORTE DE CHILE</option>
        <option value="OTRO">OTRO</option>
      </select>
    </div>

    <div class="field">
      <label for="search">Buscador</label>
      <input id="search" type="search" placeholder="PROVEEDOR / CONTACTO / TEL√âFONO / CORREO">
    </div>
  </div>

  <!-- Secciones por destino -->
  <div id="secciones"></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';
    import './script.js'; // Header din√°mico, usuario, reloj, etc.

    (async () => {
      /* ===========================
         0) Encabezado y Auth Gate
         =========================== */
      const html = await (await fetch('encabezado.html')).text();
      document.getElementById('encabezado').innerHTML = html;
      onAuthStateChanged(auth, u => { if (!u) location.href = 'login.html' });

      /* ===========================
         1) Config
         =========================== */
      const DESTINOS_FIJOS = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE'];
      const DEST_OTRO = null; // secci√≥n libre
      const seccionesWrap = document.getElementById('secciones');

      /* ===========================
         2) Filtro por destino (multi)
         =========================== */
      setupFilter();
      function setupFilter(){
        const sel = document.getElementById('destFilter');
        [...sel.options].forEach(o => o.selected = (o.value === 'ALL'));
        sel.addEventListener('change', () => {
          const vals = [...sel.selectedOptions].map(o => o.value);
          const mostrarTodas = vals.includes('ALL') || vals.length === 0;
          document.querySelectorAll('.section').forEach(sec => {
            const title = sec.querySelector('h3').textContent;
            sec.style.display = (mostrarTodas || vals.includes(title)) ? '' : 'none';
          });
          if (mostrarTodas) {
            [...sel.options].forEach(o => o.selected = (o.value === 'ALL'));
          }
        });
      }

      /* ===========================
         3) Buscador global
         =========================== */
      setupSearch();
      function norm(s){
        return (s || '').toString()
          .normalize('NFD').replace(/\p{Diacritic}/gu,'')
          .toUpperCase();
      }
      function applySearch(){
        const q = norm(document.getElementById('search')?.value || '');
        document.querySelectorAll('#secciones tbody tr').forEach(tr => {
          let t = '';
          tr.querySelectorAll('input').forEach(inp => t += (inp.value || '') + ' ');
          tr.style.display = norm(t).includes(q) ? '' : 'none';
        });
      }
      function setupSearch(){
        const input = document.getElementById('search');
        if(!input) return;
        input.addEventListener('input', applySearch);
      }

      /* ===========================
         4) Construir secciones
         =========================== */
      const secciones = [];
      DESTINOS_FIJOS.forEach(d => secciones.push(createSection(d)));
      secciones.push(createSection(DEST_OTRO)); // ‚ÄúOTRO‚Äù

      for (const sec of secciones) {
        if (sec.isOtro) continue;
        await sec.cargarDesdeFirestore();
      }

      /* =========================================================
         5) Factor√≠a de secciones (cada destino maneja su tabla)
         ========================================================= */
      function createSection(destFijo){
        const isOtro = destFijo === null;
        const titulo = isOtro ? 'OTRO' : destFijo;

        const sec = document.createElement('div');
        sec.className = 'section';
        sec.innerHTML = `<h3>${titulo}</h3>`;
        seccionesWrap.appendChild(sec);

        const ctrl = document.createElement('div');
        ctrl.className = 'controls';
        const btnNueva   = mkBtn('‚ûï Nueva fila', () => addRow());
        const btnDiez    = mkBtn('‚ûï‚ûï Agregar 10 filas', () => { for(let i=0;i<10;i++) addRow(); });
        const btnSaveAll = mkBtn('üíæ Guardar todo', saveAll);
        ctrl.append(btnNueva, btnDiez, btnSaveAll);
        sec.appendChild(ctrl);

        const wrap = document.createElement('div');
        wrap.className = 'table-wrapper';
        const tbl = document.createElement('table');
        tbl.className = isOtro ? 'tbl-otro' : 'tbl-fixed';

        const thead = document.createElement('thead');
        const trh   = document.createElement('tr');
        const headers = isOtro
          ? ['Destino','Proveedor','Nombre Contacto','Tel√©fono','Correo electr√≥nico','üíæ','üóëÔ∏è']
          : ['Proveedor','Nombre Contacto','Tel√©fono','Correo electr√≥nico','üíæ','üóëÔ∏è'];
        headers.forEach(t => { const th=document.createElement('th'); th.textContent=t; trh.appendChild(th); });
        thead.appendChild(trh);
        tbl.appendChild(thead);

        const tbody = document.createElement('tbody');
        tbl.appendChild(tbody);
        wrap.appendChild(tbl);
        sec.appendChild(wrap);

        const rows = []; // { inputs:[], ref?, tr }

        /* Pegado MASIVO por secci√≥n (tipo Excel) */
        tbody.addEventListener('paste', e => {
          const ae = document.activeElement;
          if (ae && /^(INPUT|TEXTAREA|SELECT)$/i.test(ae.tagName)) return;
          e.preventDefault();
          const lines = (e.clipboardData.getData('text/plain') || '')
            .trim().split(/\r?\n/);
          for (const line of lines) {
            const vals = line.split('\t');
            const obj = {};
            if (isOtro) {
              ['destino','proveedor','contacto','telefono','correo'].forEach((c,i)=>obj[c]=vals[i]||'');
            } else {
              ['proveedor','contacto','telefono','correo'].forEach((c,i)=>obj[c]=vals[i]||'');
            }
            addRow(obj);
          }
        });

        function addRow(prefill = {}, ref = null){
          const tr = document.createElement('tr');
          const inputs = [];

          if (isOtro) {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.placeholder = 'Destino';
            inp.value = prefill.destino || '';
            inp.dataset.campo = 'destino';
            inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
            td.appendChild(inp);
            tr.appendChild(td);
            inputs.push(inp);
          }

          const fields = ['proveedor','contacto','telefono','correo'];
          fields.forEach(field => {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.value = prefill[field] || '';
            if (field !== 'correo') {
              inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
            }
            inp.dataset.campo = field;
            td.appendChild(inp);
            tr.appendChild(td);
            inputs.push(inp);
          });

          const tdG = document.createElement('td');
          const btnG = mkBtn('üíæ', async () => {
            try {
              await guardarFila(inputs, ref);
              alert('Guardado ‚úÖ');
            } catch (e) {
              alert('Error: ' + e.message);
            }
          });
          tdG.appendChild(btnG);
          tr.appendChild(tdG);

          const tdE = document.createElement('td');
          const btnE = mkBtn('üóëÔ∏è', async () => {
            if (ref) await deleteDoc(ref);
            tr.remove();
            const idx = rows.findIndex(r => r.tr === tr);
            if (idx >= 0) rows.splice(idx,1);
          });
          tdE.appendChild(btnE);
          tr.appendChild(tdE);

          inputs.forEach((inp, startIdx) => {
            inp.addEventListener('paste', e => {
              const dt = e.clipboardData || window.clipboardData;
              const text = (dt && dt.getData('text')) || '';
              const hasGrid = text.includes('\t') || /\r?\n/.test(text);

              if (!hasGrid) {
                setTimeout(() => {
                  if (inp.dataset.campo !== 'correo') inp.value = inp.value.toUpperCase();
                  applySearch();
                }, 0);
                return;
              }

              e.preventDefault();
              const tokens = text.replace(/\r\n/g, '\n')
                                 .split(/\t|\n/)
                                 .filter(t => t.length);
              for (let k = 0; k < tokens.length && (startIdx + k) < inputs.length; k++) {
                const target = inputs[startIdx + k];
                const raw = tokens[k].trim();
                target.value = (target.dataset.campo === 'correo') ? raw : raw.toUpperCase();
                target.dispatchEvent(new Event('input', { bubbles: true }));
              }
              applySearch();
            });
          });

          tbody.appendChild(tr);
          rows.push({ inputs, ref, tr });
          applySearch();
        }

        async function guardarFila(inputs, ref){
          const data = {};
          inputs.forEach(inp => {
            const k = inp.dataset.campo;
            data[k] = inp.value.trim();
          });

          const destino = isOtro ? data.destino : destFijo;
          if (!destino)        throw new Error('Falta Destino');
          if (!data.proveedor) throw new Error('Falta Proveedor');

          const destinoDoc = doc(db, 'Proveedores', destino);
          await setDoc(destinoDoc, { _created: true }, { merge: true });

          const listCol = collection(db, 'Proveedores', destino, 'Listado');
          const provDoc = doc(listCol, data.proveedor);
          await setDoc(provDoc, {
            destino,
            proveedor: data.proveedor || '',
            contacto:  data.contacto  || '',
            telefono:  data.telefono  || '',
            correo:    data.correo    || ''
          }, { merge: true });

          if (!ref) {
            const r = rows.find(r => r.inputs === inputs);
            if (r) r.ref = provDoc;
          }
        }

        async function saveAll(){
          for (const r of rows) {
            try { await guardarFila(r.inputs, r.ref); }
            catch (e) { alert('Error: ' + e.message); }
          }
          alert('Todos guardados ‚úÖ');
        }

        async function cargarDesdeFirestore(){
          const colRef = collection(db, 'Proveedores', destFijo, 'Listado');
          const q = query(colRef, orderBy('proveedor','asc'));
          const snap = await getDocs(q);
          snap.forEach(docSnap => {
            const d = docSnap.data();
            addRow(
              {
                proveedor: d.proveedor || docSnap.id,
                contacto:  d.contacto  || '',
                telefono:  d.telefono  || '',
                correo:    d.correo    || ''
              },
              doc(db, 'Proveedores', destFijo, 'Listado', docSnap.id)
            );
          });
        }

        function mkBtn(txt, fn){ const b=document.createElement('button'); b.textContent=txt; b.onclick=fn; return b; }

        return { isOtro, cargarDesdeFirestore };
      }
    })();
  </script>
</body>
</html>
