<!-- proveedores.html (MEJORADO + COMENTADO, manteniendo todo lo que funcionaba) -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proveedores Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    /* ====== Cabecera y filtros ====== */
    header { display:flex; justify-content:space-between; align-items:center; margin:.5rem 0 }
    header h2 { margin:0 }
    .row { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
    label { font-weight:600 }
    select[multiple] { min-width:220px; min-height:90px }
    input[type="search"] { padding:.4rem .6rem; min-width:260px }

    /* ====== Secciones ====== */
    .section { margin:1.25rem 0; }
    .section h3 { margin:.25rem 0 .5rem }
    .controls { display:flex; gap:.5rem; margin:.5rem 0 }
    .controls button{ padding:.35rem .8rem; border:none; background:#0055A4; color:#fff; border-radius:4px; cursor:pointer }

    /* ====== Tabla ====== */
    .table-wrapper { overflow-x:auto }
    table { width:100%; border-collapse:collapse; table-layout:fixed; margin-top:.25rem }
    thead th { position:sticky; top:0; background:#f9f9f9; z-index:2 }
    th, td { border:1px solid #ccc; padding:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; text-align:left }

    /* Anchos en secciones FIJAS (sin columna Destino) */
    .tbl-fixed th:nth-child(1), .tbl-fixed td:nth-child(1){ width:28% } /* Proveedor */
    .tbl-fixed th:nth-child(2), .tbl-fixed td:nth-child(2){ width:22% } /* Contacto */
    .tbl-fixed th:nth-child(3), .tbl-fixed td:nth-child(3){ width:16% } /* Tel√©fono */
    .tbl-fixed th:nth-child(4), .tbl-fixed td:nth-child(4){ width:24% } /* Correo */
    .tbl-fixed th:nth-child(5), .tbl-fixed td:nth-child(5){ width:5% }  /* üíæ */
    .tbl-fixed th:nth-child(6), .tbl-fixed td:nth-child(6){ width:5% }  /* üóëÔ∏è */

    /* Anchos en secci√≥n OTRO (con columna Destino) */
    .tbl-otro th:nth-child(1), .tbl-otro td:nth-child(1){ width:18% }   /* Destino */
    .tbl-otro th:nth-child(2), .tbl-otro td:nth-child(2){ width:26% }   /* Proveedor */
    .tbl-otro th:nth-child(3), .tbl-otro td:nth-child(3){ width:20% }   /* Contacto */
    .tbl-otro th:nth-child(4), .tbl-otro td:nth-child(4){ width:12% }   /* Tel√©fono */
    .tbl-otro th:nth-child(5), .tbl-otro td:nth-child(5){ width:18% }   /* Correo */
    .tbl-otro th:nth-child(6), .tbl-otro td:nth-child(6){ width:3% }    /* üíæ */
    .tbl-otro th:nth-child(7), .tbl-otro td:nth-child(7){ width:3% }    /* üóëÔ∏è */

    /* Editor flotante reutilizable (lo maneja script.js de servicios; aqu√≠ no se usa) */
    .floating-editor{ position:absolute; z-index:200; width:300px; height:80px; resize:both; box-sizing:border-box }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <header>
    <h2>üìã LISTADO DE PROVEEDORES</h2>
  </header>

  <div class="row">
    <!-- Filtro de destinos (igual al de servicios.html) -->
    <div id="filter-container">
      <label for="destFilter">Filtrar destinos:</label>
      <select id="destFilter" multiple>
        <option value="ALL">‚Äî Todos ‚Äî</option>
        <option value="BRASIL">BRASIL</option>
        <option value="BARILOCHE">BARILOCHE</option>
        <option value="SUR DE CHILE">SUR DE CHILE</option>
        <option value="NORTE DE CHILE">NORTE DE CHILE</option>
        <option value="OTRO">OTRO</option>
      </select>
    </div>

    <!-- Buscador global (filtra filas dentro de las secciones visibles) -->
    <div>
      <label for="search">Buscador:</label>
      <input id="search" type="search" placeholder="Proveedor / Contacto / Tel√©fono / Correo">
    </div>
  </div>

  <!-- Secciones por destino -->
  <div id="secciones"></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';
    import './script.js'; // Header din√°mico, usuario, reloj, etc.

    (async () => {
      /* ==============================
         0) Encabezado y Auth Gate
         ============================== */
      const html = await (await fetch('encabezado.html')).text();
      document.getElementById('encabezado').innerHTML = html;

      onAuthStateChanged(auth, u => { if (!u) location.href = 'login.html' });

      /* ==============================
         1) Config
         ============================== */
      const DESTINOS_FIJOS = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE'];
      const DEST_OTRO = null; // secci√≥n libre, usuario define el destino manualmente
      const seccionesWrap = document.getElementById('secciones');

      /* ==============================
         2) Filtro por destino (multi)
         ============================== */
      setupFilter();
      function setupFilter(){
        const sel = document.getElementById('destFilter');
        // Pre-selecciona ‚ÄúALL‚Äù
        [...sel.options].forEach(o => o.selected = (o.value === 'ALL'));
        sel.addEventListener('change', () => {
          const vals = [...sel.selectedOptions].map(o => o.value);
          const mostrarTodas = vals.includes('ALL') || vals.length === 0;
          document.querySelectorAll('.section').forEach(sec => {
            const title = sec.querySelector('h3').textContent; // BRASIL / BARILOCHE / ...
            sec.style.display = (mostrarTodas || vals.includes(title)) ? '' : 'none';
          });
          // Si mostramos todas, dejar solo ALL marcado
          if (mostrarTodas) {
            [...sel.options].forEach(o => o.selected = (o.value === 'ALL'));
          }
        });
      }

      /* ==============================
         3) Buscador global
            - Ignora may√∫sculas/tildes
            - Oculta/mostrar filas (no secciones)
         ============================== */
      setupSearch();
      function norm(s){
        return (s || '').toString()
          .normalize('NFD').replace(/\p{Diacritic}/gu,'')
          .toUpperCase();
      }
      function applySearch(){
        const q = norm(document.getElementById('search')?.value || '');
        document.querySelectorAll('#secciones tbody tr').forEach(tr => {
          // Tomamos contenido de inputs de la fila
          let t = '';
          tr.querySelectorAll('input').forEach(inp => t += (inp.value || '') + ' ');
          tr.style.display = norm(t).includes(q) ? '' : 'none';
        });
      }
      function setupSearch(){
        const input = document.getElementById('search');
        if(!input) return;
        input.addEventListener('input', applySearch);
      }

      /* ==============================
         4) Construir secciones por destino
         ============================== */
      const secciones = [];
      DESTINOS_FIJOS.forEach(d => secciones.push(createSection(d)));
      secciones.push(createSection(DEST_OTRO)); // secci√≥n ‚ÄúOTRO‚Äù

      // Cargar datos Firestore para secciones fijas
      for (const sec of secciones) {
        if (sec.isOtro) continue;
        await sec.cargarDesdeFirestore();
      }

      /* =========================================================
         5) Factor√≠a de secciones (cada destino maneja su tabla)
         ========================================================= */
      function createSection(destFijo){
        const isOtro = destFijo === null;
        const titulo = isOtro ? 'OTRO' : destFijo;

        // Contenedor de la secci√≥n
        const sec = document.createElement('div');
        sec.className = 'section';
        sec.innerHTML = `<h3>${titulo}</h3>`;
        seccionesWrap.appendChild(sec);

        // Controles de la secci√≥n
        const ctrl = document.createElement('div');
        ctrl.className = 'controls';
        const btnNueva   = mkBtn('‚ûï Nueva fila', () => addRow());
        const btnDiez    = mkBtn('‚ûï‚ûï Agregar 10 filas', () => { for(let i=0;i<10;i++) addRow(); });
        const btnSaveAll = mkBtn('üíæ Guardar todo', saveAll);
        ctrl.append(btnNueva, btnDiez, btnSaveAll);
        sec.appendChild(ctrl);

        // Tabla de la secci√≥n
        const wrap = document.createElement('div');
        wrap.className = 'table-wrapper';
        const tbl = document.createElement('table');
        tbl.className = isOtro ? 'tbl-otro' : 'tbl-fixed';

        const thead = document.createElement('thead');
        const trh   = document.createElement('tr');
        const headers = isOtro
          ? ['Destino','Proveedor','Nombre Contacto','Tel√©fono','Correo electr√≥nico','üíæ','üóëÔ∏è']
          : ['Proveedor','Nombre Contacto','Tel√©fono','Correo electr√≥nico','üíæ','üóëÔ∏è'];
        headers.forEach(t => { const th=document.createElement('th'); th.textContent=t; trh.appendChild(th); });
        thead.appendChild(trh);
        tbl.appendChild(thead);

        const tbody = document.createElement('tbody');
        tbl.appendChild(tbody);
        wrap.appendChild(tbl);
        sec.appendChild(wrap);

        // Estado interno de filas de esta secci√≥n
        const rows = []; // { inputs:[], ref?:DocumentReference, tr:HTMLTableRowElement }

        /* ---------------------------------------------------------
           Pegado MASIVO por SECCI√ìN (varias l√≠neas tipo Excel)
           - Solo se activa si NO hay un input enfocado.
           - Cada l√≠nea -> nueva fila, campos separados por TAB.
           --------------------------------------------------------- */
        tbody.addEventListener('paste', e => {
          const ae = document.activeElement;
          if (ae && /^(INPUT|TEXTAREA|SELECT)$/i.test(ae.tagName)) return; // si est√°s en una celda, no interceptar
          e.preventDefault();
          const lines = (e.clipboardData.getData('text/plain') || '')
            .trim().split(/\r?\n/);
          for (const line of lines) {
            const vals = line.split('\t');
            const obj = {};
            if (isOtro) {
              ['destino','proveedor','contacto','telefono','correo'].forEach((c,i)=>obj[c]=vals[i]||'');
            } else {
              ['proveedor','contacto','telefono','correo'].forEach((c,i)=>obj[c]=vals[i]||'');
            }
            addRow(obj);
          }
        });

        /* -----------------------
           API: agregar una fila
           ----------------------- */
        function addRow(prefill = {}, ref = null){
          const tr = document.createElement('tr');
          const inputs = [];

          // (Solo en OTRO) Columna "Destino"
          if (isOtro) {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.placeholder = 'Destino';
            inp.value = prefill.destino || '';
            inp.dataset.campo = 'destino';
            inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
            td.appendChild(inp);
            tr.appendChild(td);
            inputs.push(inp);
          }

          // Proveedor / Contacto / Tel√©fono / Correo
          const fields = ['proveedor','contacto','telefono','correo'];
          fields.forEach(field => {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.value = prefill[field] || '';
            if (field !== 'correo') {
              inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
            }
            inp.dataset.campo = field;
            td.appendChild(inp);
            tr.appendChild(td);
            inputs.push(inp);
          });

          // Guardar fila individual
          const tdG = document.createElement('td');
          const btnG = mkBtn('üíæ', async () => {
            try {
              await guardarFila(inputs, ref);
              alert('Guardado ‚úÖ');
            } catch (e) {
              alert('Error: ' + e.message);
            }
          });
          tdG.appendChild(btnG);
          tr.appendChild(tdG);

          // Eliminar fila
          const tdE = document.createElement('td');
          const btnE = mkBtn('üóëÔ∏è', async () => {
            if (ref) await deleteDoc(ref);
            tr.remove();
            const idx = rows.findIndex(r => r.tr === tr);
            if (idx >= 0) rows.splice(idx,1);
          });
          tdE.appendChild(btnE);
          tr.appendChild(tdE);

          /* -------------------------------------------------------
             Pegado INTELIGENTE por CELDA
             - Si pegas texto simple => deja el pegado nativo en esa celda.
               (y normaliza may√∫sculas despu√©s).
             - Si pegas una cadena con TABs / saltos de l√≠nea =>
               reparte los valores desde la celda actual hacia la derecha.
             ------------------------------------------------------- */
          inputs.forEach((inp, startIdx) => {
            inp.addEventListener('paste', e => {
              const dt = e.clipboardData || window.clipboardData;
              const text = (dt && dt.getData('text')) || '';
              const hasGrid = text.includes('\t') || /\r?\n/.test(text);

              if (!hasGrid) {
                // Pegado normal + normalizaci√≥n de may√∫sculas (menos correo)
                setTimeout(() => {
                  if (inp.dataset.campo !== 'correo') inp.value = inp.value.toUpperCase();
                  applySearch(); // mantener coherencia con filtro activo
                }, 0);
                return; // no prevenimos
              }

              // Pegado tipo Excel (fila parcial o completa)
              e.preventDefault();
              const tokens = text.replace(/\r\n/g, '\n')
                                 .split(/\t|\n/)
                                 .filter(t => t.length);
              for (let k = 0; k < tokens.length && (startIdx + k) < inputs.length; k++) {
                const target = inputs[startIdx + k];
                const raw = tokens[k].trim();
                target.value = (target.dataset.campo === 'correo') ? raw : raw.toUpperCase();
                target.dispatchEvent(new Event('input', { bubbles: true }));
              }
              applySearch();
            });
          });

          // Inserta la fila y registra en memoria
          tbody.appendChild(tr);
          rows.push({ inputs, ref, tr });

          // Si hay b√∫squeda activa, evaluar la nueva fila
          applySearch();
        }

        /* -----------------------------------
           Guardar una fila (merge en Firestore)
           ----------------------------------- */
        async function guardarFila(inputs, ref){
          const data = {};
          inputs.forEach(inp => {
            const k = inp.dataset.campo;
            data[k] = inp.value.trim();
          });

          const destino = isOtro ? data.destino : destFijo;
          if (!destino)        throw new Error('Falta Destino');
          if (!data.proveedor) throw new Error('Falta Proveedor');

          // Asegura padre: Proveedores/{destino}
          const destinoDoc = doc(db, 'Proveedores', destino);
          await setDoc(destinoDoc, { _created: true }, { merge: true });

          // Subcolecci√≥n: Proveedores/{destino}/Listado/{proveedor}
          const listCol = collection(db, 'Proveedores', destino, 'Listado');
          const provDoc = doc(listCol, data.proveedor);
          await setDoc(provDoc, {
            destino,
            proveedor: data.proveedor || '',
            contacto:  data.contacto  || '',
            telefono:  data.telefono  || '',
            correo:    data.correo    || ''
          }, { merge: true });

          // Si era nuevo, guarda la ref para permitir eliminar luego
          if (!ref) {
            const r = rows.find(r => r.inputs === inputs);
            if (r) r.ref = provDoc;
          }
        }

        /* -----------------------------------
           Guardar TODAS las filas de la secci√≥n
           ----------------------------------- */
        async function saveAll(){
          for (const r of rows) {
            try {
              await guardarFila(r.inputs, r.ref);
            } catch (e) {
              alert('Error: ' + e.message);
            }
          }
          alert('Todos guardados ‚úÖ');
        }

        /* -----------------------------------
           Cargar datos de Firestore (secciones fijas)
           ----------------------------------- */
        async function cargarDesdeFirestore(){
          const colRef = collection(db, 'Proveedores', destFijo, 'Listado');
          const q = query(colRef, orderBy('proveedor','asc'));
          const snap = await getDocs(q);
          snap.forEach(docSnap => {
            const d = docSnap.data();
            addRow(
              {
                proveedor: d.proveedor || docSnap.id,
                contacto:  d.contacto  || '',
                telefono:  d.telefono  || '',
                correo:    d.correo    || ''
              },
              doc(db, 'Proveedores', destFijo, 'Listado', docSnap.id)
            );
          });
        }

        // Utilitario para botones
        function mkBtn(txt, fn){ const b=document.createElement('button'); b.textContent=txt; b.onclick=fn; return b; }

        // API p√∫blica m√≠nima de la secci√≥n
        return {
          isOtro,
          cargarDesdeFirestore
        };
      }
    })();
  </script>
</body>
</html>
