<!-- proveedores.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proveedores Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    header { display:flex; justify-content:space-between; align-items:center; margin:.5rem 0 }
    header h2 { margin:0 }
    .row { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
    label { font-weight:600 }
    select[multiple] { min-width:220px; min-height:90px }
    input[type="search"] { padding:.4rem .6rem; min-width:260px }

    .section { margin:1.25rem 0; }
    .section h3 { margin:.25rem 0 .5rem }
    .controls { display:flex; gap:.5rem; margin:.5rem 0 }
    .controls button{ padding:.35rem .8rem; border:none; background:#0055A4; color:#fff; border-radius:4px; cursor:pointer }

    .table-wrapper { overflow-x:auto }
    table { width:100%; border-collapse:collapse; table-layout:fixed; margin-top:.25rem }
    thead th { position:sticky; top:0; background:#f9f9f9; z-index:2 }
    th, td { border:1px solid #ccc; padding:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; text-align:left }

    /* Anchos razonables */
    .tbl-fixed th:nth-child(1), .tbl-fixed td:nth-child(1){ width:28% } /* Proveedor */
    .tbl-fixed th:nth-child(2), .tbl-fixed td:nth-child(2){ width:22% } /* Contacto */
    .tbl-fixed th:nth-child(3), .tbl-fixed td:nth-child(3){ width:16% } /* TelÃ©fono */
    .tbl-fixed th:nth-child(4), .tbl-fixed td:nth-child(4){ width:24% } /* Correo */
    .tbl-fixed th:nth-child(5), .tbl-fixed td:nth-child(5){ width:5% }  /* ğŸ’¾ */
    .tbl-fixed th:nth-child(6), .tbl-fixed td:nth-child(6){ width:5% }  /* ğŸ—‘ï¸ */

    /* En secciÃ³n OTRO, hay columna â€œDestinoâ€ adicional al inicio */
    .tbl-otro th:nth-child(1), .tbl-otro td:nth-child(1){ width:18% }   /* Destino */
    .tbl-otro th:nth-child(2), .tbl-otro td:nth-child(2){ width:26% }   /* Proveedor */
    .tbl-otro th:nth-child(3), .tbl-otro td:nth-child(3){ width:20% }   /* Contacto */
    .tbl-otro th:nth-child(4), .tbl-otro td:nth-child(4){ width:12% }   /* TelÃ©fono */
    .tbl-otro th:nth-child(5), .tbl-otro td:nth-child(5){ width:18% }   /* Correo */
    .tbl-otro th:nth-child(6), .tbl-otro td:nth-child(6){ width:3% }    /* ğŸ’¾ */
    .tbl-otro th:nth-child(7), .tbl-otro td:nth-child(7){ width:3% }    /* ğŸ—‘ï¸ */
  </style>
</head>
<body>
  <!--<div id="encabezado"></div> -->
  <header>
    <h2>ğŸ“‹ LISTADO DE PROVEEDORES</h2>
  </header>

  <div class="row">
    <!-- Filtro de destinos (como en servicios.html) -->
    <div id="filter-container">
      <label for="destFilter">Filtrar destinos:</label>
      <select id="destFilter" multiple>
        <option value="ALL">â€” Todos â€”</option>
        <option value="BRASIL">BRASIL</option>
        <option value="BARILOCHE">BARILOCHE</option>
        <option value="SUR DE CHILE">SUR DE CHILE</option>
        <option value="NORTE DE CHILE">NORTE DE CHILE</option>
        <option value="OTRO">OTRO</option>
      </select>
    </div>

    <!-- Buscador global -->
    <div>
      <label for="search">Buscador:</label>
      <input id="search" type="search" placeholder="Proveedor / Contacto / TelÃ©fono / Correo">
    </div>
  </div>

  <!-- Secciones por destino -->
  <div id="secciones"></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';
    import './script.js'; // Header, usuario, reloj

    (async () => {
      // Inyectar encabezado
      const html = await (await fetch('encabezado.html')).text();
      document.getElementById('encabezado').innerHTML = html;

      // Auth gate
      onAuthStateChanged(auth, u => { if (!u) location.href = 'login.html' });

      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      // Config
      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      const DESTINOS_FIJOS = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE']; // secciones fijas
      const DEST_OTRO = null; // secciÃ³n libre (ingresas el destino manualmente)
      const seccionesWrap = document.getElementById('secciones');

      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      // Filtro por destino (igual al de servicios.js)
      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      setupFilter();
      function setupFilter(){
        const sel = document.getElementById('destFilter');
        // Pre-selecciona â€œALLâ€
        [...sel.options].forEach(o => o.selected = (o.value === 'ALL'));
        sel.addEventListener('change', () => {
          const vals = [...sel.selectedOptions].map(o => o.value);
          const mostrarTodas = vals.includes('ALL') || vals.length === 0;
          document.querySelectorAll('.section').forEach(sec => {
            const title = sec.querySelector('h3').textContent; // BRASIL, BARILOCHE, ...
            sec.style.display = (mostrarTodas || vals.includes(title)) ? '' : 'none';
          });
          // Si mostramos todas, dejamos solo ALL marcado
          if (mostrarTodas) {
            [...sel.options].forEach(o => o.selected = (o.value === 'ALL'));
          }
        });
      }

      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      // Buscador global
      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      setupSearch();
      function setupSearch(){
        const input = document.getElementById('search');
        input.addEventListener('input', () => {
          const q = input.value.trim().toUpperCase();
          document.querySelectorAll('tbody tr').forEach(tr => {
            // tomamos texto visible de las celdas de datos
            const t = tr.textContent.toUpperCase();
            tr.style.display = t.includes(q) ? '' : 'none';
          });

          // Si el buscador oculta todas las filas de una secciÃ³n, igual dejamos visible la secciÃ³n;
          // el filtro de destinos es el que controla visibilidad de secciones.
        });
      }

      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      // Crear secciones por destino
      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      const secciones = [];
      DESTINOS_FIJOS.forEach(d => secciones.push(createSection(d)));
      secciones.push(createSection(DEST_OTRO)); // secciÃ³n â€œOTROâ€

      // Cargar datos de destinos fijos
      for (const sec of secciones) {
        if (sec.isOtro) continue;
        await sec.cargarDesdeFirestore();
      }

      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      // FACTORÃA DE SECCIONES
      // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      function createSection(destFijo){
        const isOtro = destFijo === null;
        const titulo = isOtro ? 'OTRO' : destFijo;

        const sec = document.createElement('div');
        sec.className = 'section';
        sec.innerHTML = `<h3>${titulo}</h3>`;
        seccionesWrap.appendChild(sec);

        // Controles
        const ctrl = document.createElement('div');
        ctrl.className = 'controls';
        const btnNueva = mkBtn('â• Nueva fila', () => addRow());
        const btnDiez  = mkBtn('â•â• Agregar 10 filas', () => { for(let i=0;i<10;i++) addRow(); });
        const btnSaveAll = mkBtn('ğŸ’¾ Guardar todo', saveAll);
        ctrl.append(btnNueva, btnDiez, btnSaveAll);
        sec.appendChild(ctrl);

        // Tabla
        const wrap = document.createElement('div');
        wrap.className = 'table-wrapper';
        const tbl = document.createElement('table');
        tbl.className = isOtro ? 'tbl-otro' : 'tbl-fixed';

        const thead = document.createElement('thead');
        const trh   = document.createElement('tr');
        const headers = isOtro
          ? ['Destino','Proveedor','Nombre Contacto','TelÃ©fono','Correo electrÃ³nico','ğŸ’¾','ğŸ—‘ï¸']
          : ['Proveedor','Nombre Contacto','TelÃ©fono','Correo electrÃ³nico','ğŸ’¾','ğŸ—‘ï¸'];
        headers.forEach(t => { const th=document.createElement('th'); th.textContent=t; trh.appendChild(th); });
        thead.appendChild(trh);
        tbl.appendChild(thead);

        const tbody = document.createElement('tbody');
        tbl.appendChild(tbody);
        wrap.appendChild(tbl);
        sec.appendChild(wrap);

        const rows = []; // { inputs, ref?, tr }

        // Pega masiva por secciÃ³n (lÃ­neas con tab)
        tbody.addEventListener('paste', e => {
          // evita que se dispare el pegado de una celda individual primero
          if (document.activeElement && document.activeElement.tagName === 'INPUT') return;
          e.preventDefault();
          const lines = e.clipboardData.getData('text/plain').trim().split(/\r?\n/);
          for (const line of lines) {
            const vals = line.split('\t');
            const obj = {};
            if (isOtro) {
              ['destino','proveedor','contacto','telefono','correo'].forEach((c,i)=>obj[c]=vals[i]||'');
            } else {
              ['proveedor','contacto','telefono','correo'].forEach((c,i)=>obj[c]=vals[i]||'');
            }
            addRow(obj);
          }
        });

        // API fila
        function addRow(prefill = {}, ref = null){
          const tr = document.createElement('tr');
          const inputs = [];

          // (OTRO) Destino manual
          if (isOtro) {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.placeholder = 'Destino';
            inp.value = prefill.destino || '';
            inp.dataset.campo = 'destino';
            inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
            td.appendChild(inp);
            tr.appendChild(td);
            inputs.push(inp);
          }

          // Proveedor, Contacto, TelÃ©fono, Correo
          const fields = ['proveedor','contacto','telefono','correo'];
          fields.forEach(field => {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.value = prefill[field] || '';
            if (field !== 'correo') {
              inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
            }
            inp.dataset.campo = field;
            td.appendChild(inp);
            tr.appendChild(td);
            inputs.push(inp);
          });

          // Guardar fila
          const tdG = document.createElement('td');
          const btnG = mkBtn('ğŸ’¾', async () => {
            try {
              await guardarFila(inputs, ref);
              alert('Guardado âœ…');
            } catch (e) {
              alert('Error: ' + e.message);
            }
          });
          tdG.appendChild(btnG);
          tr.appendChild(tdG);

          // Eliminar fila
          const tdE = document.createElement('td');
          const btnE = mkBtn('ğŸ—‘ï¸', async () => {
            if (ref) await deleteDoc(ref);
            tr.remove();
            const idx = rows.findIndex(r => r.tr === tr);
            if (idx >= 0) rows.splice(idx,1);
          });
          tdE.appendChild(btnE);
          tr.appendChild(tdE);

          // Pegado tab-a-tab dentro de la fila
          tr.addEventListener('paste', e => {
            e.preventDefault();
            const vals = e.clipboardData.getData('text/plain').split('\t');
            inputs.forEach((inp,i) => {
              if (vals[i] !== undefined) {
                const v = vals[i].trim();
                inp.value = (inp.dataset.campo === 'correo') ? v : v.toUpperCase();
              }
            });
          });

          tbody.appendChild(tr);
          rows.push({ inputs, ref, tr });
        }

        async function guardarFila(inputs, ref){
          const data = {};
          inputs.forEach(inp => {
            const k = inp.dataset.campo;
            data[k] = inp.value.trim();
          });

          const destino = isOtro ? data.destino : destFijo;
          if (!destino)          throw new Error('Falta Destino');
          if (!data.proveedor)   throw new Error('Falta Proveedor');

          // Asegura doc padre Proveedores/{destino}
          const destinoDoc = doc(db, 'Proveedores', destino);
          await setDoc(destinoDoc, { _created: true }, { merge: true });

          // SubcolecciÃ³n Listado
          const listCol = collection(db, 'Proveedores', destino, 'Listado');
          const provDoc = doc(listCol, data.proveedor);
          await setDoc(provDoc, {
            destino,
            proveedor: data.proveedor || '',
            contacto:  data.contacto  || '',
            telefono:  data.telefono  || '',
            correo:    data.correo    || ''
          }, { merge: true });

          // si era nuevo, enlaza su ref
          if (!ref) {
            const r = rows.find(r => r.inputs === inputs);
            if (r) r.ref = provDoc;
          }
        }

        async function saveAll(){
          for (const r of rows) {
            try {
              await guardarFila(r.inputs, r.ref);
            } catch (e) {
              alert('Error: ' + e.message);
            }
          }
          alert('Todos guardados âœ…');
        }

        async function cargarDesdeFirestore(){
          const colRef = collection(db, 'Proveedores', destFijo, 'Listado');
          const q = query(colRef, orderBy('proveedor','asc'));
          const snap = await getDocs(q);
          snap.forEach(docSnap => {
            const d = docSnap.data();
            // en secciones fijas, â€œdestinoâ€ lo fija la secciÃ³n
            addRow(
              {
                proveedor: d.proveedor || docSnap.id,
                contacto:  d.contacto  || '',
                telefono:  d.telefono  || '',
                correo:    d.correo    || ''
              },
              doc(db, 'Proveedores', destFijo, 'Listado', docSnap.id)
            );
          });
        }

        function mkBtn(txt, fn){ const b=document.createElement('button'); b.textContent=txt; b.onclick=fn; return b; }

        // Exponer API mÃ­nima de la secciÃ³n
        return {
          isOtro,
          cargarDesdeFirestore
        };
      }
    })();
  </script>
</body>
</html>
