<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proveedores Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 4px; }
    .controls { margin: 1rem 0; }
    .controls button { margin-right: .5rem; }
    select, input { width: 100%; box-sizing: border-box; }
    th.rownum, td.rownum { width: 2rem; text-align: center; }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <h2>📋 Listado de Proveedores</h2>

  <table id="tabla">
    <thead>
      <tr>
        <th class="rownum">#</th>
        <th>Destino</th>
        <th>Proveedor</th>
        <th>Nombre Contacto</th>
        <th>Teléfono</th>
        <th>Correo electrónico</th>
        <th>💾</th>
        <th>🗑️</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>

  <div class="controls">
    <button onclick="agregarFila()">➕ Nueva fila</button>
    <button onclick="agregarVariasFilas(10)">➕➕ Agregar 10 filas</button>
    <button onclick="guardarTodo()">💾 Guardar todo</button>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'login.html';
    });

    const destinos = ['BRASIL','BARILOCHE','SUR DE CHILE','NORTE DE CHILE','OTRO'];
    const tablaBody = document.getElementById('contenido');
    const filas = [];

    function actualizarNumeros() {
      tablaBody.querySelectorAll('tr').forEach((tr,i) => {
        let td = tr.querySelector('td.rownum');
        if (!td) {
          td = document.createElement('td');
          td.className = 'rownum';
          tr.insertBefore(td, tr.firstChild);
        }
        td.textContent = i + 1;
      });
    }

    function crearSelectDestino(value = '') {
      const sel = document.createElement('select');
      sel.dataset.campo = 'destino';
      sel.appendChild(new Option('— Seleccione —',''));
      destinos.forEach(d => {
        const o = new Option(d, d);
        if (d === value) o.selected = true;
        sel.appendChild(o);
      });
      sel.onchange = () => {
        if (sel.value === 'OTRO') {
          const inp = document.createElement('input');
          inp.placeholder = 'Escribe nuevo destino';
          inp.dataset.campo = 'destino';
          inp.addEventListener('input', ()=> inp.value = inp.value.toUpperCase());
          sel.replaceWith(inp);
          inp.focus();
        }
      };
      return sel;
    }

    function agregarFila(prefill = {}, ref = null) {
      const tr = document.createElement('tr');
      const inputs = [];

      // columna # (fila) - se rellenará en actualizarNumeros
      const placeholderTd = document.createElement('td');
      placeholderTd.className = 'rownum';
      tr.appendChild(placeholderTd);

      // Destino
      const td0 = document.createElement('td');
      let inp0;
      const destVal = (prefill.destino||'').toUpperCase();
      if (destVal && !destinos.includes(destVal)) {
        inp0 = document.createElement('input');
        inp0.value = destVal;
        inp0.dataset.campo = 'destino';
        inp0.addEventListener('input', ()=> inp0.value = inp0.value.toUpperCase());
      } else {
        inp0 = crearSelectDestino(destVal);
      }
      td0.appendChild(inp0);
      tr.appendChild(td0);
      inputs.push(inp0);

      // Proveedor / Contacto / Teléfono / Correo
      ['proveedor','contacto','telefono','correo'].forEach(c => {
        const td = document.createElement('td');
        const inp = document.createElement('input');
        inp.value = prefill[c] || '';
        if (c!=='correo') inp.addEventListener('input', ()=> inp.value = inp.value.toUpperCase());
        inp.dataset.campo = c;
        td.appendChild(inp);
        tr.appendChild(td);
        inputs.push(inp);
      });

      // Guardar
      const tdG = document.createElement('td');
      const btnG = document.createElement('button');
      btnG.textContent = '💾';
      btnG.onclick = async () => {
        document.activeElement.blur();
        try {
          await guardarFila(inputs, ref);
          alert('✅ Guardado');
        } catch(e) {
          alert('⚠️ ' + e.message);
        }
      };
      tdG.appendChild(btnG);
      tr.appendChild(tdG);

      // Eliminar
      const tdE = document.createElement('td');
      const btnE = document.createElement('button');
      btnE.textContent = '🗑️';
      btnE.onclick = async () => {
        if (ref) { await deleteDoc(ref); alert('✅ Eliminado'); }
        tr.remove();
        actualizarNumeros();
      };
      tdE.appendChild(btnE);
      tr.appendChild(tdE);

      // Pegado tab-a-tab
      tr.addEventListener('paste', e => {
        e.preventDefault();
        const vals = e.clipboardData.getData('text/plain').split('\t');
        inputs.forEach((inp,i)=> {
          if (vals[i]!=null) inp.value = vals[i].trim().toUpperCase();
        });
      });

      tablaBody.appendChild(tr);
      filas.push({inputs, ref});
      actualizarNumeros();
    }

    function agregarVariasFilas(n) {
      for (let i=0;i<n;i++) agregarFila();
    }

    async function guardarFila(inputs, ref) {
      const data = {};
      inputs.forEach(i=> data[i.dataset.campo] = i.value.trim());
      // Forzar mayúsculas
      data.destino   = data.destino.toUpperCase();
      data.proveedor = data.proveedor.toUpperCase();

      if (!data.destino)   throw new Error('Debe ingresar Destino');
      if (!data.proveedor) throw new Error('Debe ingresar Proveedor');

      // *** chequeo duplicados en tabla actual ***
      const iguales = filas.some(f=>{
        if(f.inputs===inputs) return false;
        const d = f.inputs.find(i=>i.dataset.campo==='destino').value;
        const p = f.inputs.find(i=>i.dataset.campo==='proveedor').value;
        return d===data.destino && (
          p===data.proveedor ||
          p.includes(data.proveedor) ||
          data.proveedor.includes(p)
        );
      });
      if (iguales) {
        if (!confirm(`Ya existe un proveedor similar (“${data.proveedor}”) para ${data.destino}.\n¿Guardar de todas formas?`)) {
          throw new Error('Guardado cancelado por duplicado');
        }
      }

      // 1) crear doc padre
      const padre = doc(db,'Proveedores',data.destino);
      await setDoc(padre,{_created:true},{merge:true});

      // 2) guardar en Listado
      const col = collection(db,'Proveedores',data.destino,'Listado');
      const pd  = doc(col,data.proveedor);
      await setDoc(pd,data);

      if (!ref) filas.find(f=>f.inputs===inputs).ref = pd;
    }

    async function guardarTodo() {
      for (const f of filas) {
        try { await guardarFila(f.inputs,f.ref); }
        catch(e){ alert('⚠️ '+e.message); }
      }
      alert('📑 Todo guardado');
    }

    async function cargarProveedores() {
      for (const d of destinos) {
        const destino = d.toUpperCase();
        const col = collection(db,'Proveedores',destino,'Listado');
        const q   = query(col, orderBy('proveedor','asc'));
        const snap= await getDocs(q);
        snap.forEach(s=>{
          const o = s.data();
          o.destino = destino;
          agregarFila(o, doc(db,'Proveedores',destino,'Listado',s.id));
        });
      }
    }

    // pegado masivo en toda la tabla
    tablaBody.addEventListener('paste',e=>{
      e.preventDefault();
      const lines = e.clipboardData.getData('text/plain').trim().split(/\r?\n/);
      lines.forEach(line=>{
        const vals = line.split('\t');
        const obj = {};
        ['destino','proveedor','contacto','telefono','correo']
          .forEach((c,i)=> obj[c]=vals[i]||'');
        agregarFila(obj);
      });
    });

    window.agregarFila        = agregarFila;
    window.agregarVariasFilas = agregarVariasFilas;
    window.guardarTodo        = guardarTodo;

    cargarProveedores();

    fetch('encabezado.html')
      .then(r=>r.text())
      .then(html=>document.getElementById('encabezado').innerHTML=html);
  </script>
</body>
</html>
