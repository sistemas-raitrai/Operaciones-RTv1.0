<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proveedores Rai Trai</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 4px; }
    .controls { margin: 1rem 0; }
    .controls button { margin-right: .5rem; }
  </style>
</head>
<body>
  <div id="encabezado"></div>
  <h2>ğŸ“‹ Listado de Proveedores</h2>

  <table id="tabla">
    <thead>
      <tr>
        <th>Destino</th>
        <th>Proveedor</th>
        <th>Contacto</th>
        <th>TelÃ©fono</th>
        <th>Correo electrÃ³nico</th>
        <th>ğŸ’¾</th>
        <th>ğŸ—‘ï¸</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>

  <div class="controls">
    <button onclick="agregarFila()">â• Nueva fila</button>
    <button onclick="agregarVariasFilas(10)">â•â• Agregar 10 filas</button>
    <button onclick="guardarTodo()">ğŸ’¾ Guardar todo</button>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection, getDocs, query, orderBy,
      doc, setDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'login.html';
    });

    const tablaBody = document.getElementById('contenido');
    const filas = [];

    // Crea una fila en la tabla, con opcional prefill y ref de Firestore
    function agregarFila(prefill = {}, ref = null) {
      const tr = document.createElement('tr');
      const inputs = [];

      // Campo DESTINO
      const td0 = document.createElement('td');
      const inp0 = document.createElement('input');
      inp0.value = prefill.destino || '';
      inp0.placeholder = 'Destino';
      inp0.dataset.campo = 'destino';
      inp0.addEventListener('input', () => inp0.value = inp0.value.toUpperCase());
      td0.appendChild(inp0);
      tr.appendChild(td0);
      inputs.push(inp0);

      // Campos: proveedor, contacto, telÃ©fono, correo
      ['proveedor','contacto','telefono','correo'].forEach(c => {
        const td = document.createElement('td');
        const inp = document.createElement('input');
        inp.value = prefill[c] || '';
        if (c !== 'correo') inp.addEventListener('input', () => inp.value = inp.value.toUpperCase());
        inp.dataset.campo = c;
        td.appendChild(inp);
        tr.appendChild(td);
        inputs.push(inp);
      });

      // BotÃ³n GUARDAR
      const tdG = document.createElement('td');
      const btnG = document.createElement('button');
      btnG.textContent = 'ğŸ’¾';
      btnG.onclick = async () => {
        document.activeElement.blur();
        try {
          await guardarFila(inputs, ref);
          alert('âœ… Guardado');
        } catch (e) {
          alert('âš ï¸ ' + e.message);
        }
      };
      tdG.appendChild(btnG);
      tr.appendChild(tdG);

      // BotÃ³n ELIMINAR
      const tdE = document.createElement('td');
      const btnE = document.createElement('button');
      btnE.textContent = 'ğŸ—‘ï¸';
      btnE.onclick = async () => {
        if (ref) {
          await deleteDoc(ref);
          alert('âœ… Eliminado');
        }
        tr.remove();
      };
      tdE.appendChild(btnE);
      tr.appendChild(tdE);

      // Pegado por fila (tab a tab)
      tr.addEventListener('paste', e => {
        e.preventDefault();
        const vals = e.clipboardData.getData('text/plain').split('\t');
        inputs.forEach((inp, i) => {
          if (vals[i] !== undefined) inp.value = vals[i].trim().toUpperCase();
        });
      });

      tablaBody.appendChild(tr);
      filas.push({inputs, ref});
    }

    // Crea N filas vacÃ­as
    function agregarVariasFilas(n) {
      for (let i = 0; i < n; i++) agregarFila();
    }

    // Guarda (o actualiza) un proveedor en Proveedores/{destino}/Listado/{proveedor}
    async function guardarFila(inputs, ref) {
      const data = {};
      inputs.forEach(i => data[i.dataset.campo] = i.value.trim());
      if (!data.destino)   throw new Error('Debe ingresar Destino');
      if (!data.proveedor) throw new Error('Debe ingresar Proveedor');
      const col = collection(db, 'Proveedores', data.destino, 'Listado');
      const docRef = doc(col, data.proveedor);
      await setDoc(docRef, data);
      if (!ref) filas.find(f => f.inputs === inputs).ref = docRef;
    }

    // Guarda todas las filas
    async function guardarTodo() {
      for (const f of filas) {
        try { await guardarFila(f.inputs, f.ref); }
        catch(e){ alert('âš ï¸ '+e.message); }
      }
      alert('ğŸ“‘ Proceso completado');
    }

    // Carga dinÃ¡micamente TODOS los destinos y sus proveedores
    async function cargarProveedores() {
      console.log('ğŸ”„ cargando destinos...');
      // 1) leemos todas las docs bajo Proveedores/
      const rootSnap = await getDocs(collection(db, 'Proveedores'));
      console.log('ğŸ“‚ destinos encontrados:', rootSnap.size);

      for (const destDoc of rootSnap.docs) {
        const destino = destDoc.id;           // p.ej. "Brasil"
        const col = collection(db, 'Proveedores', destino, 'Listado');
        const q   = query(col, orderBy('proveedor','asc'));
        const snap = await getDocs(q);
        console.log(`ğŸ“‘ ${destino}: ${snap.size} proveedores`);
        // 2) agregamos una fila por cada proveedor
        snap.forEach(s => {
          const d = s.data();
          d.destino = destino;
          agregarFila(d,
            doc(db, 'Proveedores', destino, 'Listado', s.id)
          );
        });
      }
      console.log('âœ… carga completa, filas en tabla:', filas.length);
    }

    // Pegado masivo en toda la tabla
    tablaBody.addEventListener('paste', e => {
      e.preventDefault();
      const lines = e.clipboardData.getData('text/plain').trim().split(/\r?\n/);
      lines.forEach(line => {
        const vals = line.split('\t');
        const obj = {};
        ['destino','proveedor','contacto','telefono','correo']
          .forEach((c,i)=> obj[c] = vals[i] || '');
        agregarFila(obj);
      });
    });

    // Exponer funciones globales para los botones
    window.agregarFila        = agregarFila;
    window.agregarVariasFilas = agregarVariasFilas;
    window.guardarTodo        = guardarTodo;

    // EJECUCIÃ“N INICIAL
    cargarProveedores();

    fetch('encabezado.html')
      .then(r=>r.text())
      .then(html=>document.getElementById('encabezado').innerHTML = html);

  </script>
</body>
</html>
