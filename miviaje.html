<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Mi Viaje | RT</title>

  <!-- Estilos globales propios (si los tienes) -->
  <link rel="stylesheet" href="estilos.css" />
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />

  <style>
    /* ====== Base ====== */
    .grid{ display:grid; gap:12px; }
    .card{ border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
    .activity-card{ border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
    .dia-seccion{ margin:12px 0; }
    .dia-titulo{ color:#1D4ED8; font-weight:700; }

    .row{ display:grid; grid-template-columns:1fr auto; gap:12px; align-items:end; }
    .column{ display:block; }
    .btn-add{ margin-left:8px; }
    .readonly-field{ opacity:.9; }

    .table-wrapper{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:6px 4px; border-bottom:1px solid #eee; text-align:left; }

    .print-only{ display:none; white-space:pre-wrap; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif; }

    /* Ocultar logo en pantalla */
    @media screen{ #print-logo{ display:none; } }

    /* ====== Itinerario embebido (PANTALLA) ====== */
    .dias-embebidas{ display:block; margin:12px 0; }
    .dias-embebidas .fila{
      display:grid;
      gap:12px;
      /* las columnas exactas las fija JS con style="grid-template-columns: repeat(N, minmax(260px,1fr))" */
      margin-bottom:12px;
    }
    .dias-embebidas .fila:last-child{ margin-bottom:0; }

    .dias-embebidas .dia-seccion{
      margin:0;
      width:auto !important;
      min-width:0 !important;
      max-width:none !important;
      flex:1 1 auto !important;
    }
    .dias-embebidas .dia-titulo{
      background:#eef2ff;
      border-radius:8px;
      padding:6px 8px;
      margin-bottom:8px;
      font-weight:700;
    }

    /* Quitar carrusel/scroll horizontal heredado */
    #itinerario-container{ overflow:visible !important; }
    #itinerario-container input[type="range"],
    #itinerario-container .scrollbar,
    #itinerario-container .x-scroll,
    #itinerario-container [role="scrollbar"],
    #itinerario-container .range,
    #itinerario-container .slider,
    #itinerario-container .scroll-track,
    #itinerario-container .scroll-thumb{
      display:none !important;
    }
    /* Si alg√∫n wrapper qued√≥ con overflow-x */
    #itinerario-container *[style*="overflow-x"]{ overflow:visible !important; overflow-x:visible !important; }

    /* Espaciado para t√≠tulos numerados ‚Äú1. ‚Ä¶‚Äù */
    .seccion-num{ display:block; margin:22px 0 18px; font-weight:700; line-height:1.25; }
    #itinerario-container .card ol > li + li{ margin-top:16px; }

    /* Responsive fino */
    @media (max-width: 840px){
      .dias-embebidas .fila{ grid-template-columns: repeat(2, minmax(240px,1fr)) !important; }
    }

    /* ====== IMPRESI√ìN ====== */
    @media print{
      @page{ margin:14mm 12mm; }
      *{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      header, .btn-add{ display:none !important; }
      .print-only, #print-block{ display:none !important; }

      #print-logo{
        display:block; position:fixed; top:12px; right:12px; width:120px;
      }

      .grid, #itinerario-container, .activity-list{ display:block !important; gap:0 !important; width:100% !important; }

      .dia-seccion{ break-inside:avoid; page-break-inside:avoid; margin:12px 0 10px 0 !important; }
      .dia-seccion h3{
        color:#1D4ED8 !important; margin:12px 0 6px 0 !important; padding:0 !important;
        font-size:12pt !important; text-align:left !important; background:none !important; border:0 !important;
      }
      .activity-card p{ margin:0 0 4px 0 !important; font-size:11pt !important; font-weight:600; }

      body{ background:#fff; color:#000; font-size:11pt; }
      h1,h2,h3{ margin:0 0 6px 0; }

      .row{ display:block !important; margin:0 0 8px 0 !important; }
      .row .column, .row .long, .row .medium, .row .short{ display:block !important; width:100% !important; margin:0 0 4px 0 !important; }
      #itinerario-container{ margin-top:14px !important; }

      .u-hide-screen{ display:none !important; }
      @media print{ .u-hide-screen{ display:block !important; } }
      .u-hide-all{ display:none !important; }

      /* Al imprimir, 3 columnas por fila si cabe */
      .dias-embebidas .fila{ grid-template-columns: repeat(3, 1fr) !important; }
    }
  </style>
</head>

<body class="itinerario-page">
  <img id="print-logo" src="Logo Raitrai.png" alt="RaiTrai" />

  <header class="header" style="display:flex;align-items:center;gap:.75rem;padding:.5rem 1rem;border-bottom:1px solid #ddd;background:#fff;">
    <img src="Logo Raitrai.png" alt="Rai Trai" style="height:36px;width:auto;">
    <h1 style="font-size:1.25rem;margin:0;">Mi Viaje</h1>
    <div id="resumen-pax" style="margin-left:auto;font-size:.9rem;color:#666;"></div>
    <button id="btnShare" class="btn-add" title="Copiar enlace para compartir">üîó Copiar enlace</button>
    <button id="btnPrint"  class="btn-add" title="Imprimir / Guardar en PDF">üñ®Ô∏è Imprimir</button>
  </header>

  <main class="main" style="padding:12px;">
    <!-- Cabecera de grupo opcional (oculta en pantalla) -->
    <div id="cabecera-grupo" style="display:none">
      <div class="row">
        <div class="column long"><h2>PROGRAMA: <span id="grupo-title">‚Äì</span></h2></div>
        <div class="column medium"><h2>FECHAS: <span id="grupo-fechas" class="readonly-field">‚Äî</span></h2></div>
      </div>
      <div class="column medium"><h2>GRUPO: <span id="grupo-nombre">‚Äî</span></h2></div>
      <div class="row" style="grid-template-columns:2fr 1fr;">
        <div class="column medium"><label>Destino</label><div id="grupo-destino" class="readonly-field">‚Äî</div></div>
        <div class="column short"><label>N¬∞ Negocio</label><div id="grupo-numero" class="readonly-field">‚Äî</div></div>
      </div>
      <section id="grupo-ficha" style="margin:12px 0;">
        <h3 style="margin:12px 0 6px;">Ficha del grupo</h3>
        <div id="ficha-inner" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;"></div>
      </section>
    </div>

    <!-- Aqu√≠ miviaje.js pinta todo -->
    <div id="mi-itin"></div>
    <pre id="print-block" class="print-only"></pre>
  </main>

  <noscript><p style="padding:1rem;color:#b00;">Esta p√°gina requiere JavaScript para cargar tu viaje.</p></noscript>

  <!-- Carga datos del viaje -->
  <script type="module">import './miviaje.js';</script>

  <!-- Embebido y distribuci√≥n 4/4, 4/3, 3/3, 3/2 -->
  <script>
  (function(){
    const cont = document.getElementById('itinerario-container');
    if (!cont) return;

    // Quita controles de carrusel
    function desactivarCarrusel(){
      cont.querySelectorAll(
        'input[type="range"], [role="scrollbar"], .scrollbar, .x-scroll, .slider, .scroll-track, .scroll-thumb'
      ).forEach(el => el.remove());
      cont.querySelectorAll('[style*="overflow-x"], .overflow-x, .overflow-auto, .x-overflow')
        .forEach(el => { el.style.overflow='visible'; el.style.overflowX='visible'; });
    }

    // Reglas de distribuci√≥n
    function distribucion(n){
      if (n >= 8) return [4, n-4]; // 8 -> 4/4 (m√°x 8)
      if (n === 7) return [4, 3];
      if (n === 6) return [3, 3];
      if (n === 5) return [3, 2];
      return [n, 0]; // 1..4 todo arriba
    }

    function embutirYDistribuir(){
      // Encontrar la frase ‚ÄúTURISMO RAITRAI LES DESEA‚Ä¶‚Äù
      const deseo = Array.from(cont.querySelectorAll('*'))
        .find(n => n && /TURISMO\s+RAITRAI\s+LES\s+DESEA/i.test(n.textContent || ''));
      if (!deseo) return;

      const caja = deseo.closest('.card') || deseo.parentElement;
      if (!caja || caja.dataset.itinSplit === '1') return;

      // Crear contenedor y dos filas
      const wrap = document.createElement('div');
      wrap.className = 'dias-embebidas';

      const filaTop = document.createElement('div');
      filaTop.className = 'fila fila-top';
      const filaBottom = document.createElement('div');
      filaBottom.className = 'fila fila-bottom';

      // Insertar antes de la frase
      wrap.appendChild(filaTop);
      wrap.appendChild(filaBottom);
      caja.insertBefore(wrap, deseo);

      // Tomar d√≠as y repartir
      const dias = Array.from(cont.querySelectorAll('.dia-seccion'));
      if (!dias.length) return;

      const [topCount, bottomCount] = distribucion(dias.length);

      // Set columnas exactas por fila
      if (topCount)   filaTop.style.gridTemplateColumns    = `repeat(${topCount}, minmax(260px, 1fr))`;
      if (bottomCount)filaBottom.style.gridTemplateColumns = `repeat(${bottomCount}, minmax(260px, 1fr))`;

      dias.forEach((d, idx) => {
        if (idx < topCount) filaTop.appendChild(d);
        else filaBottom.appendChild(d);
      });

      // Oculta fila de abajo si no se usa
      if (!bottomCount) filaBottom.style.display = 'none';

      caja.dataset.itinSplit = '1';
      desactivarCarrusel();
      obs.disconnect();
    }

    // Marca ‚Äú1. ‚Ä¶‚Äù como secciones numeradas
    function marcarNumerados(){
      const RE = /^\s*\d+\.\s/;
      cont.querySelectorAll('.card').forEach(card => {
        Array.from(card.children).forEach(el => {
          if (/^(P|DIV|H\d)$/i.test(el.tagName) && RE.test((el.textContent||'').trim())){
            el.classList.add('seccion-num');
          }
        });
      });
    }

    const obs = new MutationObserver(() => { embutirYDistribuir(); marcarNumerados(); });
    obs.observe(cont, { childList:true, subtree:true });
    window.addEventListener('load', () => { embutirYDistribuir(); marcarNumerados(); desactivarCarrusel(); });
  })();
  </script>
</body>
</html>
