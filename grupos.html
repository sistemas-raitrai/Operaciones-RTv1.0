<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualizaci√≥n de Grupos | RT v1.0</title>
  <!-- DataTables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  >
  <!-- Tu CSS global -->
  <link rel="stylesheet" href="css/estilos.css">
  <style>
    /* Ajuste para que la tabla ocupe todo el ancho */
    #tablaGrupos {
      width: 100% !important;
      background: white;
      border-collapse: collapse;
    }
    /* Quitar el buscador por defecto de DataTables */
    .dataTables_filter {
      display: none;
    }
    /* Peque√±os ajustes al input */
    #buscador {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- === Header con tu clase === -->
  <div class="header">
    <div class="row">
      <div class="column short">
        <img src="Logo Raitrai.png" alt="Logo Rai Trai" style="height:40px;">
      </div>
      <div class="column medium">
        <h2>SISTEMA DE OPERACIONES RT v1.0</h2>
        <p id="usuario-conectado">Usuario conectado: ‚Ä¶</p>
      </div>
    </div>
    <div class="row">
      <a href="index.html" class="boton-cerrar">üè†</a>
      <button onclick="location.reload()">üîÑ</button>
      <button onclick="history.back()">‚¨ÖÔ∏è</button>
      <button class="boton-cerrar" onclick="logout()">‚èèÔ∏è</button>
    </div>
  </div>

  <main class="main">
    <div class="row">
      <div class="column long">
        <label for="buscador">Buscar en cualquier columna</label>
        <input
          type="text"
          id="buscador"
          placeholder="Palabra clave‚Ä¶"
        >
      </div>
    </div>

    <!-- Filtros por columna -->
    <div class="row">
      <div class="column short">
        <label for="filtroDestino">Destino</label>
        <select id="filtroDestino"><option value="">Todos</option></select>
      </div>
      <div class="column short">
        <label for="filtroAno">A√±o de Viaje</label>
        <select id="filtroAno"><option value="">Todos</option></select>
      </div>
    </div>

    <!-- Tabla DataTables -->
    <div class="row">
      <table id="tablaGrupos" class="display">
        <thead>
          <tr>
            <th>Num Negocio</th><th>Grupo</th><th>Pax Total</th>
            <th>Colegio</th><th>Curso</th><th>A√±o</th><th>Destino</th>
            <th>Programa</th><th>Hotel</th><th>Asist. Viajes</th>
            <th>Autoriz.</th><th>Fecha Viaje</th><th>Obs.</th>
            <th>Versi√≥n</th><th>Creado Por</th><th>F. Creaci√≥n</th>
            <th>Inicio</th><th>Fin</th><th>Adultos</th><th>Estudiantes</th>
            <th>Transporte</th><th>Ciudades</th><th>Hoteles</th>
            <th>Tramos</th><th>Obs. Logist.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Firebase + tu l√≥gica de auth -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script>
    // Inicializa Firebase
    const firebaseConfig = {
      apiKey: "...", authDomain: "...", // completa con tu configuraci√≥n
      projectId: "...", // etc
    };
    firebase.initializeApp(firebaseConfig);

    // Funci√≥n de logout
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location = 'login.html';
      });
    }

    // Muestra el usuario o redirige si no hay
    firebase.auth().onAuthStateChanged(u => {
      if (!u) return window.location = 'login.html';
      document.getElementById('usuario-conectado').textContent =
        'Usuario conectado: ' + (u.email || u.displayName);
    });
  </script>

  <!-- jQuery + DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"
  ></script>

  <!-- L√≥gica de datos y DataTables -->
  <script>
    // Campos que devuelve tu Web App
    const campos = [
      'numeroNegocio','nombreGrupo','cantidadgrupo','colegio','curso','anoViaje',
      'destino','programa','hotel','asistenciaEnViajes','autorizacion',
      'fechaDeViaje','observaciones','versionFicha','creadoPor','fechaCreacion',
      'fechaInicio','fechaFin','adultos','estudiantes','transporte',
      'ciudades','hoteles','tramos','observacionesLogisticas'
    ];

    function initDataTablesGrupos() {
      fetch('https://script.google.com/macros/s/TU_ID/exec')
        .then(r => r.json())
        .then(json => {
          const datos = json.valores || [];
          renderizarTabla(datos);
          inicializarFiltros(datos);
        })
        .catch(console.error);
    }

    function renderizarTabla(datos) {
      const $tb = $('#tablaGrupos tbody').empty();
      datos.forEach(r => {
        const $tr = $('<tr>');
        campos.forEach(c => $tr.append($('<td>').text(r[c] || '')));
        $tb.append($tr);
      });

      window.tabla = $('#tablaGrupos').DataTable({
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' },
        dom: 'lrtip',
        pageLength: 10,
        order: [[5, 'desc']]
      });

      $('#buscador').on('input', function() {
        tabla.search(this.value).draw();
      });
    }

    function inicializarFiltros(datos) {
      const uniq = arr => [...new Set(arr.filter(x=>x))].sort();

      uniq(datos.map(r=>r.destino))
        .forEach(d => $('#filtroDestino').append(`<option>${d}</option>`));
      uniq(datos.map(r=>r.anoViaje))
        .forEach(a => $('#filtroAno').append(`<option>${a}</option>`));

      $('#filtroDestino').on('change', function() {
        tabla.column(6).search(this.value).draw();
      });
      $('#filtroAno').on('change', function() {
        tabla.column(5).search(this.value).draw();
      });
    }

    // Arranca tras cargar la p√°gina y confirmar auth
    window.addEventListener('load', () => {
      firebase.auth().onAuthStateChanged(u => {
        if (u) initDataTablesGrupos();
      });
    });
  </script>
</body>
</html>
