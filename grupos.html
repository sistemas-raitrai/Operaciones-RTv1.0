<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>VisualizaciÃ³n de Grupos | RT v1.0</title>
  <!-- 1) Estilos de DataTables -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  >
  <!-- 2) Tu CSS global -->
  <link rel="stylesheet" href="estilos.css">
  <link rel="icon" type="image/png" href="Logo Raitrai.png" />
  <style>
    /* 3) Ajustes especÃ­ficos de esta pÃ¡gina */
    #tablaGrupos {
      width: 100% !important;
      background: white;
      border-collapse: collapse;
    }
    .dataTables_filter { display: none; }
    #buscador { margin-bottom: 1rem; }
  </style>
</head>
<body>

  <!-- 4) Punto de montaje del encabezado reutilizable -->
  <div id="encabezado"></div>

  <main class="main">
    <div class="filter-bar">
      <div class="row">
        <!-- Buscador ocupa la columna "long" -->
        <div class="column long">
          <label for="buscador">Buscador de palabras claves</label>
          <input type="text" id="buscador" placeholder="â€¦">
        </div>
        <!-- Filtro Destino ocupa "short" -->
        <div class="column short">
          <label for="filtroDestino">Destino</label>
          <select id="filtroDestino">
            <option value="">Todos</option>
          </select>
        </div>
        <!-- Filtro AÃ±o ocupa "short" -->
        <div class="column short">
          <label for="filtroAno">AÃ±o de Viaje</label>
          <select id="filtroAno">
            <option value="">Todos</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row" style="margin-bottom: 1rem; gap: 1rem; align-items: center;">
      <button id="btn-toggle-edit" class="btn">ðŸ”“ Activar EdiciÃ³n</button>
      <button id="btn-view-history" class="btn">ðŸ“œ Ver Historial</button>
    </div>
    
    <!-- Modal de Historial -->
    <div id="modalHistorial" class="modal-backdrop" style="display:none;">
      <div class="modal" style="max-width:800px; margin:auto; background:white; padding:1rem;">
        <h2>Historial del Grupo</h2>
        <div style="display:flex; gap:1rem; align-items:center; margin-bottom:0.5rem;">
          <!-- Input rango de fechas -->
          <input type="date" id="histInicio" />
          <input type="date" id="histFin" />
          <!-- BotÃ³n actualizar datos -->
          <button id="btn-refresh-history">ðŸ”„ Actualizar</button>
          <!-- Buscador global -->
          <input type="text" id="buscadorHistorial" placeholder="Buscarâ€¦" style="flex:1;" />
          <!-- Cerrar -->
          <button id="btn-close-history">Cerrar</button>
        </div>
        <table id="tablaHistorial" class="display" style="width:100%;">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Usuario</th>
              <th>AcciÃ³n / Campo</th>
              <th>Antes</th>
              <th>DespuÃ©s</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>



    <!-- 7) Tabla vacÃ­a, que llenaremos con JS -->
    <div class="row">
       <div class="table-container">
        <table id="tablaGrupos" class="display">
          <thead>
            <tr>
              <th>NÂ° Negocio</th>               <!-- 0 -->
              <th>Nombre de Grupo</th>           <!-- 1 -->
              <th>Pax</th>                       <!-- 2 -->
              <th>Adultos</th>                   <!-- 3 -->
              <th>Estudiantes</th>               <!-- 4 -->
              <th>Colegio</th>                   <!-- 5 -->
              <th>Curso</th>                     <!-- 6 -->
              <th>AÃ±o</th>                       <!-- 7 -->
              <th>Destino</th>                   <!-- 8 -->
              <th>Programa</th>                  <!-- 9 -->
              <th>Inicio</th>                    <!-- 10 -->
              <th>Hotel</th>                     <!-- 11 -->
              <th>Asist. Viajes</th>             <!-- 12 -->
              <th>Autoriz.</th>                  <!-- 13 -->
              <th>Fecha de Viaje</th>            <!-- 14 -->
              <th>Obs.</th>                      <!-- 15 -->
              <th>VersiÃ³n</th>                   <!-- 16 -->
              <th>Creado Por</th>                <!-- 17 -->
              <th>F. CreaciÃ³n</th>               <!-- 18 -->
              <th>Fin</th>                       <!-- 19 -->
              <th>Transporte</th>                <!-- 20 -->
              <th>Ciudades</th>                  <!-- 21 -->
              <th>Hoteles</th>                   <!-- 22 -->
              <th>Tramos</th>                    <!-- 23 -->
              <th>Obs. Logist.</th>              <!-- 24 -->
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- 8) Inyecto el encabezado (header) -->
  <script type="module">
    (async () => {
      const res = await fetch("encabezado.html");
      document.getElementById("encabezado").innerHTML = await res.text();
    })();
  </script>

  <!-- 9) InicializaciÃ³n de Firebase/Auth (sin depender del DOM) -->
  <script type="module" src="firebase-init.js" defer></script>
  <!-- 10) Script global (reloj, logout, mostrar usuario) -->
  <script type="module" src="script.js" defer></script>

  <!-- 11) LibrerÃ­as clÃ¡sicas SIN defer para garantizar que existan antes del mÃ³dulo -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <!-- 12) LÃ³gica de la tabla (module, sin defer) -->
  <script type="module">
    import { app, db } from './firebase-init.js';
    import { getAuth, onAuthStateChanged, signOut }
      from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import {
      collection,
      getDocs,
      query,
      orderBy,
      doc,
      updateDoc,
      addDoc
    } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';
  
    const auth = getAuth(app);

    // 0) AquÃ­ defines tu array de claves Firestore:
    const camposFire = [
      "numeroNegocio","nombreGrupo","cantidadgrupo",
      "adultos","estudiantes","colegio","curso",
      "anoViaje","destino","programa","inicio",
      "hotel","asistenciaEnViajes","autorizacion",
      "fechaDeViaje","observaciones","versionFicha",
      "creadoPor","fechaCreacion","fin",
      "transporte","ciudades","hoteles","tramos","obsLogist"
    ];
  
    $(function() {
      $('#btn-logout').click(() =>
        signOut(auth).then(() => location = 'login.html')
      );
      onAuthStateChanged(auth, user => {
        if (!user) location = 'login.html';
        else cargarYMostrarTabla();
      });
    });
  
    async function cargarYMostrarTabla() {
      // 0) Traer todos los grupos de Firestore
      const snapshot = await getDocs(collection(db, "grupos"));
      if (snapshot.empty) {
        console.warn("No hay grupos en Firestore");
        return;
      }
  
      // 1) Mapear cada doc a un array de valores
      const valores = snapshot.docs.map(docSnap => {
        // extraemos los datos aquÃ­:
        const d = docSnap.data();

        // y los devolvemos dentro de un objeto literal:
        return {
          id: docSnap.id,
          fila: [
            d.numeroNegocio,
            d.nombreGrupo,
            d.cantidadgrupo,
            d.adultos     || '',
            d.estudiantes || '',
            d.colegio,
            d.curso,
            d.anoViaje,
            d.destino,
            d.programa,
            d.inicio      || '',
            d.hotel,
            d.asistenciaEnViajes,
            d.autorizacion,
            d.fechaDeViaje,
            d.observaciones,
            d.versionFicha,
            d.creadoPor,
            d.fechaCreacion,
            // Y si tienes mÃ¡s campos en Firestore:
            d.fin         || '',
            d.transporte  || '',
            d.ciudades    || '',
            d.hoteles     || '',
            d.tramos      || '',
            d.obsLogist   || ''
          ]
        };
      });
  
      // 2) Vaciar y rellenar el <tbody>
      const $tb = $('#tablaGrupos tbody').empty();
      valores.forEach(item => {
          const { id, fila } = item;              // <â€” extraigo id y el array
          const $tr = $('<tr>');
        
        fila.forEach((celda, idx) => {
          // todas las columnas editables, excepto 0 y 1:
          const editable = (idx !== 0 && idx !== 1);
          const campoClave = camposFire[idx]; 
          const $td = $('<td>')
            .text(celda ?? '')
            .attr('data-doc-id', id)
            .attr('data-campo', campoClave) 
            .attr('data-original', celda);
      
          $tr.append($td);
        });
      
        $tb.append($tr);
      });
  
      // 3) Inicializar DataTable con tus ajustes
      const tabla = $('#tablaGrupos').DataTable({
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' },
        dom: 'rtip', // QUITAMOS la â€œlâ€ (length) del dom
        pageLength: -1, // -1 significa â€œTodosâ€
        lengthChange: false, // deshabilita el dropdown de length
          order: [
          [8, 'desc'],  // Destino 
          [9, 'desc'],  // Programa
          [10, 'desc'],  // Fecha Inicio 
          [1, 'desc']   // Nombre Grupo
        ],
        scrollX: true,
        columnDefs: [
          // Oculta las columnas que quieras
          { targets: [5, 6], visible: false }
        ]
      });

      // 4) Listener de focusout en celdas editables
      $('#tablaGrupos tbody').on('focusout', 'td[contenteditable]', async function() {
        const $td       = $(this);
        const nuevo     = $td.text().trim();
        const original  = $td.attr('data-original');
        if (nuevo === original) return;

        const docId     = $td.attr('data-doc-id');
        const campo     = $td.attr('data-campo') || $('#tablaGrupos thead th').eq($td.index()).text();

        // a) update en /grupos/{docId}
        await updateDoc(doc(db, 'grupos', docId), { [campo]: nuevo });

        // b) log en /historial
        await addDoc(collection(db, 'historial'), {
          numeroNegocio: $td.closest('tr').find('td').eq(0).text().trim(),
          campo,
          anterior: original,
          nuevo,
          modificadoPor: auth.currentUser.email,
          timestamp: new Date()
        });

        // c) actualiza el data-original
        $td.attr('data-original', nuevo);
      });

        // 0) Flag de estado
        let editMode = false;

        // BotÃ³n toggle
        $('#btn-toggle-edit').on('click', async () => {
          editMode = !editMode;
        
          // 1) Cambio texto del botÃ³n
          $('#btn-toggle-edit')
            .text(editMode ? 'ðŸ”’ Desactivar EdiciÃ³n' : 'ðŸ”“ Activar EdiciÃ³n');
        
          // 2) Pongo o quito contenteditable en todas las celdas
          $('#tablaGrupos tbody td')
            .attr('contenteditable', editMode);
        
        // 3) Registro en historial la activaciÃ³n o desactivaciÃ³n
        const accion = editMode 
          ? 'ACTIVÃ“ MODO EDICIÃ“N' 
          : 'DESACTIVÃ“ MODO EDICIÃ“N';
        
        await addDoc(collection(db, 'historial'), {
          // usa la misma clave que tu variable:
          accion,
          usuario: auth.currentUser.email,
          timestamp: new Date()
        });
      });
      
      // 1) Abrir modal de historial
      $('#btn-view-history').on('click', async () => {
        // 1.1) Query sin filtros, sÃ³lo ordenada por timestamp desc
        const q = query(
          collection(db,'historial'),
          orderBy('timestamp','desc')
        );
        const snap = await getDocs(q);
      
        // 1.2) Pintar en el <tbody> del modal sÃ³lo lo que importa
        const $tbH = $('#tablaHistorial tbody').empty();
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const fecha = d.timestamp.toDate().toLocaleString('es-CL');
          const usuario = d.modificadoPor || d.usuario;
          const accionOCampo = d.accion || d.campo;
          const antes = d.anterior || '';
          const despues = d.nuevo || '';
          $tbH.append(`
            <tr>
              <td>${fecha}</td>
              <td>${usuario}</td>
              <td>${accionOCampo}</td>
              <td>${antes}</td>
              <td>${despues}</td>
            </tr>
          `);
        });
      
        // 1.3) Inicializar DataTable (o refrescar si ya existe)
        if ( $.fn.DataTable.isDataTable('#tablaHistorial') ) {
          $('#tablaHistorial').DataTable().destroy();
        }
        const dtHist = $('#tablaHistorial').DataTable({
          language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' },
          pageLength: 15,
          lengthMenu: [ [15, 30, 50, -1], [15, 30, 50, 'Todos'] ],
          order: [[0, 'desc']],
          dom: 'fltip',  // f = filter, l = length, t = table, i = info, p = paging
        });
      
        // 1.4) Conectar nuestro buscador personalizado
        $('#buscadorHistorial').off('input').on('input', function() {
          dtHist.search(this.value).draw();
        });
      
        // 1.5) Mostrar el modal
        $('#modalHistorial').show();
      });
      
      // 2) Cerrar modal
      $('#btn-close-history').on('click', () => {
        $('#modalHistorial').hide();
      });
  
      // 5) Buscador global y filtros (igual que antes)
      $('#buscador').on('input', () =>
        tabla.search($('#buscador').val()).draw()
      );
      const uniq = arr => [...new Set(arr.filter(x => x))].sort();
      uniq(valores.map(r => r[6])).forEach(destino =>
        $('#filtroDestino').append(`<option>${destino}</option>`)
      );
      uniq(valores.map(r => r[5])).forEach(ano =>
        $('#filtroAno').append(`<option>${ano}</option>`)
      );
      $('#filtroDestino').on('change', () =>
        tabla.column(6).search($('#filtroDestino').val()).draw()
      );
      $('#filtroAno').on('change', () =>
        tabla.column(5).search($('#filtroAno').val()).draw()
      );
    }
  </script>
</body>
</html>
