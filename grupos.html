<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualizaci√≥n de Grupos | RT v1.0</title>
  <!-- DataTables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  >
  <!-- Tu CSS global -->
  <link rel="stylesheet" href="estilos.css">
  <style>
    #tablaGrupos { width:100% !important; background:white; border-collapse:collapse; }
    .dataTables_filter { display:none; }
    #buscador { margin-bottom:1rem; }
  </style>
</head>
<body>

  <!-- Inyectamos el header -->
  <div id="encabezado"></div>

  <main class="main">
    <!-- Buscador global -->
    <div class="row">
      <div class="column long">
        <label for="buscador">Buscar en cualquier columna</label>
        <input type="text" id="buscador" placeholder="Palabra clave‚Ä¶">
      </div>
    </div>
    <!-- Filtros -->
    <div class="row">
      <div class="column short">
        <label for="filtroDestino">Destino</label>
        <select id="filtroDestino"><option value="">Todos</option></select>
      </div>
      <div class="column short">
        <label for="filtroAno">A√±o de Viaje</label>
        <select id="filtroAno"><option value="">Todos</option></select>
      </div>
    </div>
    <!-- Tabla -->
    <div class="row">
      <table id="tablaGrupos" class="display">
        <thead>
          <tr>
            <th>Num Negocio</th><th>Grupo</th><th>Pax Total</th>
            <th>Colegio</th><th>Curso</th><th>A√±o</th><th>Destino</th>
            <th>Programa</th><th>Hotel</th><th>Asist. Viajes</th>
            <th>Autoriz.</th><th>Fecha Viaje</th><th>Obs.</th>
            <th>Versi√≥n</th><th>Creado Por</th><th>F. Creaci√≥n</th>
            <th>Inicio</th><th>Fin</th><th>Adultos</th><th>Estudiantes</th>
            <th>Transporte</th><th>Ciudades</th><th>Hoteles</th>
            <th>Tramos</th><th>Obs. Logist.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- 1Ô∏è‚É£ Inyecto encabezado -->
  <script type="module">
    (async () => {
      const res = await fetch("encabezado.html");
      document.getElementById("encabezado").innerHTML = await res.text();
    })();
  </script>

  <!-- 2Ô∏è‚É£ Firebase/Auth init -->
  <script type="module" src="firebase-init.js" defer></script>
  <!-- 3Ô∏è‚É£ Script global (reloj, logout, usuario) -->
  <script type="module" src="script.js" defer></script>

  <!-- 4Ô∏è‚É£ Librer√≠as externas SIN defer -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <!-- 5Ô∏è‚É£ L√≥gica de tabla -->
  <script type="module">
    import { app } from './firebase-init.js';
    import { getAuth, onAuthStateChanged, signOut }
      from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';

    const auth = getAuth(app);

    // Solo arrancamos cuando jQuery y DOM listo
    $(function() {
      // Logout
      $('#btn-logout').click(() =>
        signOut(auth).then(() => location = 'login.html')
      );
      // Tras autenticaci√≥n, cargo la tabla
      onAuthStateChanged(auth, user => {
        if (!user) return location = 'login.html';
        cargarYMostrarTabla();
      });
    });

    // üîë Nombres de campo en el orden de las columnas
    const campos = [
      'numeroNegocio','nombreGrupo','cantidadgrupo','colegio','curso','anoViaje',
      'destino','programa','hotel','asistenciaEnViajes','autorizacion',
      'fechaDeViaje','observaciones','versionFicha','creadoPor','fechaCreacion',
      'fechaInicio','fechaFin','adultos','estudiantes','transporte',
      'ciudades','hoteles','tramos','obsLogistica'
    ];

    async function cargarYMostrarTabla() {
      console.log('‚ñ∂ fetch de datos‚Ä¶');
      const res = await fetch(
        'https://script.google.com/macros/s/AKfycbwkyIMHb_bzAzMWoO3Yte2a6aFtVDguFGsiL0aaG6Tupn8B807oovR34S0YbR9I9mz0/exec'
      );
      if (!res.ok) return console.error('Fetch fall√≥', res.status);
      const json    = await res.json();
      console.log('‚ñ∂ Datos:', json);
      const valores = json.valores || [];

      // Lleno el tbody
      const $tb = $('#tablaGrupos tbody').empty();
      valores.forEach(r => {
        const $tr = $('<tr>');
        campos.forEach(c => $tr.append($('<td>').text(r[c] || '')));
        $tb.append($tr);
      });

      // Inicializo DataTable y guardo la instancia
      const tabla = $('#tablaGrupos').DataTable({
        language: { url:'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' },
        dom: 'lrtip',
        pageLength: 10,
        order: [[5,'desc']]
      });

      // Buscador y filtros ahora pueden usar esa instancia
      $('#buscador').on('input', () => tabla.search($('#buscador').val()).draw());

      const uniq = arr => [...new Set(arr.filter(x=>x))].sort();
      uniq(valores.map(r=>r.destino))
        .forEach(d => $('#filtroDestino').append(`<option>${d}</option>`));
      uniq(valores.map(r=>r.anoViaje))
        .forEach(a => $('#filtroAno').append(`<option>${a}</option>`));

      $('#filtroDestino').on('change', () => tabla.column(6).search($('#filtroDestino').val()).draw());
      $('#filtroAno').on('change',    () => tabla.column(5).search($('#filtroAno').val()).draw());
    }
  </script>
</body>
</html>
